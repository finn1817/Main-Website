<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Betting Hub - Heads-Up Poker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2d1b69 0%, #11998e 100%);
            min-height: 100vh;
            color: white;
            position: relative;
            overflow-x: hidden;
        }

        /* Poker Table Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.1) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 80px 80px, 40px 40px;
            z-index: -1;
            opacity: 0.4;
        }

        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.5);
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #00d4aa;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .balance {
            background: linear-gradient(45deg, #00d4aa, #00b894);
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .admin-badge {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
            display: none;
            animation: pulse 2s infinite;
        }

        .admin-badge.show {
            display: inline-block;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0); }
        }

        .back-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Game Container */
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Game Status */
        .game-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #00d4aa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .status-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d4aa;
            margin-bottom: 5px;
        }

        .status-label {
            color: #ccc;
            font-size: 0.9em;
        }

        /* Poker Table */
        .poker-table {
            background: radial-gradient(ellipse at center, #0e4b3d 0%, #0a3529 70%);
            border-radius: 50%;
            padding: 40px;
            margin: 30px auto;
            border: 8px solid #00d4aa;
            position: relative;
            max-width: 800px;
            aspect-ratio: 1.6/1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        /* Player Areas */
        .opponent-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .player-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .player-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #00d4aa;
        }

        .player-chips {
            background: rgba(0, 0, 0, 0.8);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            color: #00d4aa;
        }

        .player-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-waiting {
            background: #ffc107;
            color: #000;
        }

        .status-active {
            background: #28a745;
            color: white;
        }

        .status-folded {
            background: #dc3545;
            color: white;
        }

        /* Cards */
        .hand-cards {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .card {
            width: 60px;
            height: 84px;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            transition: all 0.3s ease;
            border: 2px solid #ddd;
        }

        .card.dealing {
            animation: dealCard 0.5s ease-out;
        }

        @keyframes dealCard {
            from {
                transform: translateY(-100px) rotateY(180deg);
                opacity: 0;
            }
            to {
                transform: translateY(0) rotateY(0deg);
                opacity: 1;
            }
        }

        .card-back {
            background: linear-gradient(45deg, #2d1b69, #11998e);
            color: #00d4aa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .card-top {
            font-size: 0.8em;
            font-weight: bold;
            line-height: 1;
        }

        .card-center {
            font-size: 1.5em;
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-bottom {
            font-size: 0.8em;
            font-weight: bold;
            transform: rotate(180deg);
            text-align: right;
            line-height: 1;
        }

        .red {
            color: #dc3545;
        }

        .black {
            color: #000;
        }

        /* Community Cards */
        .community-area {
            text-align: center;
            margin: 20px 0;
        }

        .community-title {
            color: #00d4aa;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .community-cards {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .pot-info {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
        }

        .pot-amount {
            font-size: 1.4em;
            font-weight: bold;
            color: #00d4aa;
        }

        /* Game Controls */
        .game-controls {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
            backdrop-filter: blur(10px);
            border: 2px solid #00d4aa;
        }

        .controls-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #00d4aa;
            text-align: center;
        }

        .betting-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .bet-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .bet-input {
            padding: 10px 15px;
            border: 2px solid #00d4aa;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
            font-weight: bold;
            text-align: center;
            width: 120px;
        }

        .bet-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .game-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-fold {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }

        .btn-call {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-raise {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }

        .btn-check {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
        }

        .btn-all-in {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
        }

        .game-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .game-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Game Lobby */
        .game-lobby {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid #00d4aa;
        }

        .lobby-title {
            font-size: 2em;
            font-weight: bold;
            color: #00d4aa;
            margin-bottom: 20px;
        }

        .lobby-description {
            color: #ccc;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .lobby-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .lobby-option {
            background: rgba(0, 212, 170, 0.1);
            border: 2px solid #00d4aa;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lobby-option:hover {
            background: rgba(0, 212, 170, 0.2);
            transform: translateY(-5px);
        }

        .option-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #00d4aa;
            margin-bottom: 10px;
        }

        .option-description {
            color: #ccc;
            margin-bottom: 15px;
        }

        .buy-in-selector {
            margin: 20px 0;
        }

        .buy-in-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .buy-in-btn {
            background: rgba(0, 0, 0, 0.6);
            color: #00d4aa;
            border: 2px solid #00d4aa;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .buy-in-btn:hover, .buy-in-btn.selected {
            background: #00d4aa;
            color: #000;
        }

        /* Game Messages */
        .game-message {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00d4aa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .win-message {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .lose-message {
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #f44336;
        }

        .notification.warning {
            background: #ff9800;
        }

        /* Loading Animation */
        .loading {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #00d4aa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .game-container {
                padding: 20px 10px;
            }
            
            .poker-table {
                padding: 20px;
                margin: 20px auto;
            }
            
            .card {
                width: 50px;
                height: 70px;
            }
            
            .betting-controls {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .game-btn {
                width: 100%;
                margin: 5px 0;
            }

            .chat-spectator-panel {
                flex-direction: column;
            }
        }

        /* Spectator System */
        .spectator-panel {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 2px solid #00d4aa;
        }

        .spectator-title {
            color: #00d4aa;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .spectator-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .spectator-item {
            background: rgba(0, 212, 170, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #00d4aa;
            color: #00d4aa;
            font-size: 0.9em;
            font-weight: bold;
        }

        .spectator-count {
            background: #00d4aa;
            color: #000;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 5px;
        }

        /* Hand History */
        .hand-history-panel {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 2px solid #00d4aa;
            max-height: 400px;
            overflow-y: auto;
        }

        .history-title {
            color: #00d4aa;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .history-item {
            background: rgba(0, 212, 170, 0.1);
            border: 1px solid #00d4aa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            background: rgba(0, 212, 170, 0.2);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-players {
            font-weight: bold;
            color: #00d4aa;
        }

        .history-result {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .result-win {
            background: #28a745;
            color: white;
        }

        .result-loss {
            background: #dc3545;
            color: white;
        }

        .history-details {
            color: #ccc;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .history-date {
            color: #888;
            font-size: 0.8em;
            margin-top: 8px;
        }

        /* Chat System */
        .chat-panel {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 2px solid #00d4aa;
            flex: 1;
        }

        .chat-title {
            color: #00d4aa;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .chat-messages {
            height: 250px;
            overflow-y: auto;
            background: rgba(0, 212, 170, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(0, 212, 170, 0.3);
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(0, 212, 170, 0.1);
            border-left: 3px solid #00d4aa;
        }

        .chat-message.system-message {
            background: rgba(0, 212, 170, 0.2);
            border-left: 3px solid #00d4aa;
            font-style: italic;
        }

        .chat-user {
            font-weight: bold;
            color: #00d4aa;
            margin-bottom: 2px;
        }

        .chat-username {
            font-weight: bold;
            color: #00d4aa;
        }

        .chat-text {
            color: #fff;
            line-height: 1.3;
            margin-left: 5px;
        }

        .chat-text.system-text {
            color: #00d4aa;
            margin-left: 0;
        }

        .chat-time {
            font-size: 0.8em;
            color: #888;
            margin-top: 4px;
            float: right;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #00d4aa;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-input::placeholder {
            color: #888;
        }

        .chat-send {
            background: #00d4aa;
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .chat-send:hover {
            background: #00b894;
            transform: translateY(-2px);
        }

        .chat-spectator-panel {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        /* Feature Toggle Buttons */
        .feature-toggles {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .toggle-btn {
            background: rgba(0, 212, 170, 0.2);
            color: #00d4aa;
            border: 2px solid #00d4aa;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover, .toggle-btn.active {
            background: #00d4aa;
            color: #000;
        }

        .feature-panel {
            display: none;
        }

        .feature-panel.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Notification System -->
    <div id="notification" class="notification"></div>

    <!-- Header -->
    <div class="header">
        <div class="logo">🎲 Family Poker Arena</div>
        <div class="user-info">
            <span id="userBalance" class="balance">$0</span>
            <span id="adminBadge" class="admin-badge">👑 ADMIN</span>
            <a href="dashboard.html" class="back-btn">← Back to Dashboard</a>
        </div>
    </div>

    <!-- Game Container -->
    <div class="game-container">
        <!-- Game Status -->
        <div class="game-status" id="gameStatus">
            <div class="status-card">
                <div class="status-value" id="pokerWins">0</div>
                <div class="status-label">Poker Wins</div>
            </div>
            <div class="status-card">
                <div class="status-value" id="pokerLosses">0</div>
                <div class="status-label">Poker Losses</div>
            </div>
            <div class="status-card">
                <div class="status-value" id="pokerWinRate">0%</div>
                <div class="status-label">Win Rate</div>
            </div>
            <div class="status-card">
                <div class="status-value" id="pokerWinnings">$0</div>
                <div class="status-label">Total Winnings</div>
            </div>
        </div>

        <!-- Game Lobby (shown when not in game) -->
        <div class="game-lobby" id="gameLobby">
            <div class="lobby-title">🎲 Heads-Up Poker Arena</div>
            <div class="lobby-description">
                Challenge family members to intense 1v1 Texas Hold'em battles!<br>
                Choose your stakes and prepare for the ultimate poker showdown! 🔥
            </div>
            
            <div class="buy-in-selector">
                <div style="color: #00d4aa; font-weight: bold; margin-bottom: 15px;">Select Buy-In Amount:</div>
                <div class="buy-in-buttons">
                    <div class="buy-in-btn" data-amount="100">$100</div>
                    <div class="buy-in-btn" data-amount="250">$250</div>
                    <div class="buy-in-btn selected" data-amount="500">$500</div>
                    <div class="buy-in-btn" data-amount="1000">$1,000</div>
                    <div class="buy-in-btn" data-amount="2500">$2,500</div>
                </div>
            </div>

            <div class="lobby-options">
                <div class="lobby-option" onclick="createGame()">
                    <div class="option-title">🚀 Create New Game</div>
                    <div class="option-description">
                        Start a new poker game and invite a family member to join your table.
                    </div>
                </div>
                <div class="lobby-option" onclick="joinGame()">
                    <div class="option-title">🎯 Join Existing Game</div>
                    <div class="option-description">
                        Join an existing game created by another family member.
                    </div>
                </div>
            </div>
        </div>

        <!-- Poker Table (hidden initially) -->
        <div class="poker-table" id="pokerTable" style="display: none;">
            <!-- Opponent Area -->
            <div class="opponent-area">
                <div class="player-info">
                    <div class="player-name" id="opponentName">Waiting for opponent...</div>
                    <div class="player-chips" id="opponentChips">$0</div>
                    <div class="player-status" id="opponentStatus">Waiting</div>
                </div>
                <div class="hand-cards" id="opponentHand">
                    <!-- Opponent cards will be added here -->
                </div>
            </div>

            <!-- Community Cards Area -->
            <div class="community-area">
                <div class="community-title">Community Cards</div>
                <div class="community-cards" id="communityCards">
                    <!-- Community cards will be added here -->
                </div>
                <div class="pot-info">
                    <div class="pot-amount" id="potAmount">$0</div>
                    <div style="color: #ccc; font-size: 0.9em;">Total Pot</div>
                </div>
            </div>

            <!-- Player Area -->
            <div class="player-area">
                <div class="hand-cards" id="playerHand">
                    <!-- Player cards will be added here -->
                </div>
                <div class="player-info">
                    <div class="player-name" id="playerName">You</div>
                    <div class="player-chips" id="playerChips">$0</div>
                    <div class="player-status" id="playerStatus">Active</div>
                </div>
            </div>
        </div>

        <!-- Game Message -->
        <div class="game-message" id="gameMessage" style="display: none;">
            Welcome to Family Poker Arena! 🎲
        </div>

        <!-- Game Controls -->
        <div class="game-controls" id="gameControls" style="display: none;">
            <div class="controls-title">Your Turn</div>
            
            <div class="bet-input-container">
                <label for="betAmount" style="color: #00d4aa; font-weight: bold;">Bet Amount:</label>
                <input type="number" id="betAmount" class="bet-input" min="0" value="50" placeholder="Amount">
            </div>

            <div class="action-buttons">
                <button class="game-btn btn-fold" onclick="foldHand()">Fold</button>
                <button class="game-btn btn-check" onclick="checkHand()">Check</button>
                <button class="game-btn btn-call" onclick="callBet()">Call</button>
                <button class="game-btn btn-raise" onclick="raiseBet()">Raise</button>
                <button class="game-btn btn-all-in" onclick="allIn()">All In</button>
            </div>
        </div>

        <!-- Feature Toggle Buttons -->
        <div class="feature-toggles">
            <button class="toggle-btn" onclick="toggleFeature('spectators')">👥 Spectators</button>
            <button class="toggle-btn active" onclick="toggleFeature('chat')">💬 Chat</button>
            <button class="toggle-btn" onclick="toggleFeature('history')">📖 Hand History</button>
        </div>

        <!-- Chat & Spectator Panel -->
        <div class="chat-spectator-panel">
            <!-- Chat System -->
            <div class="chat-panel feature-panel active" id="chatPanel">
                <div class="chat-title">💬 Game Chat & Trash Talk</div>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message">
                        <div class="chat-user">System</div>
                        <div class="chat-text">Welcome to the poker arena! Let the trash talk begin! 🎲</div>
                        <div class="chat-time">Just now</div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" class="chat-input" placeholder="Type your message... 💬" maxlength="200">
                    <button class="chat-send" onclick="sendChatMessage()">Send</button>
                </div>
            </div>

            <!-- Spectator System -->
            <div class="spectator-panel feature-panel" id="spectatorPanel">
                <div class="spectator-title">👥 Live Spectators <span class="spectator-count" id="spectatorCount">0</span></div>
                <div class="spectator-list" id="spectatorList">
                    <div class="spectator-item">No spectators yet</div>
                </div>
                <div style="text-align: center; margin-top: 15px; color: #888; font-size: 0.9em;">
                    Family members can watch this epic battle live! 🍿
                </div>
            </div>
        </div>

        <!-- Hand History -->
        <div class="hand-history-panel feature-panel" id="historyPanel">
            <div class="history-title">📖 Hand History</div>
            <div id="handHistoryList">
                <div style="text-align: center; color: #888; padding: 40px;">
                    No hands played yet. Start your first game to see history! 🎲
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading" id="loading"></div>

    <!-- Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            where, 
            or,
            doc, 
            setDoc, 
            updateDoc, 
            getDoc,
            deleteDoc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBs0mLN4_HzWx9nGdOjCsewT3X6F69Ysik",
            authDomain: "family-bets-1967f.firebaseapp.com",
            projectId: "family-bets-1967f",
            storageBucket: "family-bets-1967f.firebasestorage.app",
            messagingSenderId: "13304744240",
            appId: "1:13304744240:web:1e9a2c0ddb1703474b60f5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.db = db;
        window.firestoreUtils = { 
            collection, addDoc, getDocs, query, where, or, doc, setDoc, updateDoc, getDoc, deleteDoc, onSnapshot
        };

        // Initialize poker
        initializePoker();
    </script>

    <script>
        // Global variables
        let currentUser = null;
        let currentGame = null;
        let gameListener = null;
        let chatListener = null;
        let spectatorListener = null;
        let selectedBuyIn = 500;
        
        let pokerStats = {
            wins: 0,
            losses: 0,
            winnings: 0
        };

        // Feature tracking
        let activeFeature = 'chat';
        let spectators = [];
        let handHistory = [];

        // Poker game state
        let gameState = {
            gameId: null,
            phase: 'waiting', // waiting, preflop, flop, turn, river, showdown
            pot: 0,
            playerChips: 0,
            opponentChips: 0,
            playerCards: [],
            opponentCards: [],
            communityCards: [],
            currentBet: 0,
            lastAction: null,
            turn: null, // player or opponent
            smallBlind: 25,
            bigBlind: 50
        };

        // Feature toggle functions
        function toggleFeature(feature) {
            activeFeature = feature;
            
            // Hide all panels
            document.getElementById('chatPanel').style.display = 'none';
            document.getElementById('spectatorPanel').style.display = 'none';
            document.getElementById('handHistoryPanel').style.display = 'none';
            
            // Remove active class from all buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected panel and mark button as active
            if (feature === 'chat') {
                document.getElementById('chatPanel').style.display = 'block';
                document.querySelector('[onclick="toggleFeature(\'chat\')"]').classList.add('active');
            } else if (feature === 'spectator') {
                document.getElementById('spectatorPanel').style.display = 'block';
                document.querySelector('[onclick="toggleFeature(\'spectator\')"]').classList.add('active');
            } else if (feature === 'history') {
                document.getElementById('handHistoryPanel').style.display = 'block';
                document.querySelector('[onclick="toggleFeature(\'history\')"]').classList.add('active');
            }
        }

        // Chat functions
        function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message === '' || !currentGame) return;
            
            // Add chat message to Firebase
            db.collection('pokerChats').add({
                gameId: currentGame,
                username: currentUser.username,
                message: message,
                timestamp: new Date(),
                type: 'game'
            }).then(() => {
                chatInput.value = '';
            }).catch(error => {
                console.error('Error sending chat message:', error);
            });
        }

        function loadChatMessages() {
            if (!currentGame) return;
            
            if (chatListener) {
                chatListener();
            }
            
            chatListener = db.collection('pokerChats')
                .where('gameId', '==', currentGame)
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    const chatMessages = document.getElementById('chatMessages');
                    
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            addChatMessage(message.username, message.message, message.timestamp);
                        }
                    });
                });
        }

        function addChatMessage(username, message, timestamp) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = username === 'System' ? 'chat-message system-message' : 'chat-message';
            
            const time = timestamp.toDate ? timestamp.toDate().toLocaleTimeString() : new Date(timestamp).toLocaleTimeString();
            
            if (username === 'System') {
                messageDiv.innerHTML = `
                    <span class="chat-text system-text">${message}</span>
                    <span class="chat-time">${time}</span>
                `;
            } else {
                messageDiv.innerHTML = `
                    <span class="chat-username">${username}:</span>
                    <span class="chat-text">${message}</span>
                    <span class="chat-time">${time}</span>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Spectator functions
        function addSpectator(username) {
            if (!spectators.includes(username) && username !== currentUser.username) {
                spectators.push(username);
                updateSpectatorList();
            }
        }

        function removeSpectator(username) {
            spectators = spectators.filter(spec => spec !== username);
            updateSpectatorList();
        }

        function updateSpectatorList() {
            const spectatorList = document.getElementById('spectatorList');
            const spectatorCount = document.getElementById('spectatorCount');
            
            spectatorCount.textContent = spectators.length;
            spectatorList.innerHTML = '';
            
            spectators.forEach(spectator => {
                const spectatorDiv = document.createElement('div');
                spectatorDiv.className = 'spectator-item';
                spectatorDiv.textContent = spectator;
                spectatorList.appendChild(spectatorDiv);
            });
        }

        function loadSpectators() {
            if (!currentGame) return;
            
            if (spectatorListener) {
                spectatorListener();
            }
            
            spectatorListener = db.collection('pokerSpectators')
                .where('gameId', '==', currentGame)
                .onSnapshot(snapshot => {
                    spectators = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.username !== currentUser.username) {
                            spectators.push(data.username);
                        }
                    });
                    updateSpectatorList();
                });
        }

        function joinAsSpectator() {
            if (!currentGame) return;
            
            db.collection('pokerSpectators').add({
                gameId: currentGame,
                username: currentUser.username,
                joinedAt: new Date()
            });
        }

        // Hand history functions
        function saveHandToHistory(gameData, winner, winnings) {
            const hand = {
                gameId: currentGame,
                players: [gameData.player1, gameData.player2],
                winner: winner,
                winnings: winnings,
                timestamp: new Date(),
                pot: gameData.pot,
                cards: {
                    community: gameData.communityCards,
                    player1: gameData.player1Cards,
                    player2: gameData.player2Cards
                }
            };
            
            handHistory.unshift(hand);
            if (handHistory.length > 20) {
                handHistory = handHistory.slice(0, 20);
            }
            
            // Save to Firebase
            db.collection('pokerHistory').add(hand);
            
            updateHandHistoryDisplay();
        }

        function loadHandHistory() {
            if (!currentUser) return;
            
            db.collection('pokerHistory')
                .where('players', 'array-contains', currentUser.username)
                .orderBy('timestamp', 'desc')
                .limit(20)
                .get()
                .then(snapshot => {
                    handHistory = [];
                    snapshot.forEach(doc => {
                        handHistory.push(doc.data());
                    });
                    updateHandHistoryDisplay();
                });
        }

        function updateHandHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            handHistory.forEach(hand => {
                const handDiv = document.createElement('div');
                handDiv.className = 'history-item';
                
                const isWin = hand.winner === currentUser.username;
                const time = hand.timestamp.toDate ? hand.timestamp.toDate().toLocaleString() : new Date(hand.timestamp).toLocaleString();
                
                handDiv.innerHTML = `
                    <div class="history-result ${isWin ? 'win' : 'loss'}">
                        ${isWin ? 'WIN' : 'LOSS'}
                    </div>
                    <div class="history-details">
                        <div>vs ${hand.players.find(p => p !== currentUser.username)}</div>
                        <div>Pot: $${hand.pot}</div>
                        <div>${time}</div>
                    </div>
                `;
                
                historyList.appendChild(handDiv);
            });
        }

        // Initialize Poker
        async function initializePoker() {
            // Check if user is logged in
            const savedUser = localStorage.getItem('familyBettingUser');
            if (!savedUser) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = JSON.parse(savedUser);
            
            // Update UI
            document.getElementById('playerName').textContent = currentUser.username;
            
            // Update user stats and balance
            await updateUserStats();
            
            // Set up buy-in selection
            setupBuyInSelection();
            
            // Initialize features
            toggleFeature('chat'); // Start with chat panel open
            loadHandHistory(); // Load user's poker history
            
            // Set up chat input enter key
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            showNotification('Welcome to the Poker Arena! 🎲', 'success');
        }

        // Update user stats from database
        async function updateUserStats() {
            try {
                const { doc, getDoc } = window.firestoreUtils;
                const userDoc = await getDoc(doc(window.db, 'users', currentUser.id));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUser = { ...currentUser, ...userData };
                    localStorage.setItem('familyBettingUser', JSON.stringify(currentUser));
                    
                    // Update balance
                    document.getElementById('userBalance').textContent = '$' + userData.balance.toLocaleString();
                    
                    // Update poker stats
                    pokerStats.wins = userData.pokerWins || 0;
                    pokerStats.losses = userData.pokerLosses || 0;
                    pokerStats.winnings = userData.pokerWinnings || 0;
                    
                    updateStatsDisplay();
                    
                    // Show/hide admin badge
                    const adminBadge = document.getElementById('adminBadge');
                    if (userData.isAdmin === 1) {
                        adminBadge.classList.add('show');
                    } else {
                        adminBadge.classList.remove('show');
                    }
                }
            } catch (error) {
                console.error('Error updating user stats:', error);
                showNotification('Error loading user data', 'error');
            }
        }

        // Update stats display
        function updateStatsDisplay() {
            document.getElementById('pokerWins').textContent = pokerStats.wins;
            document.getElementById('pokerLosses').textContent = pokerStats.losses;
            document.getElementById('pokerWinnings').textContent = '$' + pokerStats.winnings.toLocaleString();
            
            const totalGames = pokerStats.wins + pokerStats.losses;
            const winRate = totalGames > 0 ? Math.round((pokerStats.wins / totalGames) * 100) : 0;
            document.getElementById('pokerWinRate').textContent = winRate + '%';
        }

        // Setup buy-in selection
        function setupBuyInSelection() {
            const buyInButtons = document.querySelectorAll('.buy-in-btn');
            buyInButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    buyInButtons.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedBuyIn = parseInt(btn.dataset.amount);
                });
            });
        }

        // Create new game
        async function createGame() {
            if (selectedBuyIn > currentUser.balance) {
                showNotification('Insufficient funds for this buy-in!', 'error');
                return;
            }

            try {
                const { collection, addDoc } = window.firestoreUtils;
                
                const gameData = {
                    creator: currentUser.id,
                    creatorName: currentUser.username,
                    buyIn: selectedBuyIn,
                    status: 'waiting_for_opponent',
                    createdAt: new Date().toISOString(),
                    pot: 0,
                    phase: 'waiting',
                    smallBlind: Math.floor(selectedBuyIn * 0.05), // 5% of buy-in
                    bigBlind: Math.floor(selectedBuyIn * 0.1)     // 10% of buy-in
                };

                const gameDoc = await addDoc(collection(window.db, 'pokerGames'), gameData);
                gameState.gameId = gameDoc.id;
                currentGame = gameDoc.id;

                // Initialize chat and spectator features
                loadChatMessages();
                loadSpectators();
                joinAsSpectator(); // Creator becomes spectator until game starts

                // Hide lobby and show waiting message
                document.getElementById('gameLobby').style.display = 'none';
                document.getElementById('gameMessage').style.display = 'block';
                document.getElementById('gameMessage').textContent = 'Game created! Waiting for opponent to join... 🎲';

                // Start listening for game updates
                startGameListener();

                showNotification('Game created! Share your game ID: ' + gameDoc.id.substring(0, 8), 'success');

            } catch (error) {
                console.error('Error creating game:', error);
                showNotification('Failed to create game', 'error');
            }
        }

        // Join existing game
        async function joinGame() {
            // For now, we'll auto-match with the first available game
            // Later you can add a game browser or invite system
            try {
                const { collection, getDocs, query, where, updateDoc, doc } = window.firestoreUtils;
                
                const gamesRef = collection(window.db, 'pokerGames');
                const q = query(gamesRef, where("status", "==", "waiting_for_opponent"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showNotification('No games available to join. Create a new game!', 'warning');
                    return;
                }

                // Join the first available game
                const gameDoc = querySnapshot.docs[0];
                const gameData = gameDoc.data();

                if (selectedBuyIn !== gameData.buyIn) {
                    showNotification(`This game requires a $${gameData.buyIn} buy-in. Please adjust your buy-in.`, 'warning');
                    return;
                }

                if (selectedBuyIn > currentUser.balance) {
                    showNotification('Insufficient funds for this buy-in!', 'error');
                    return;
                }

                // Update game with opponent
                await updateDoc(doc(window.db, 'pokerGames', gameDoc.id), {
                    opponent: currentUser.id,
                    opponentName: currentUser.username,
                    status: 'active',
                    updatedAt: new Date().toISOString()
                });

                gameState.gameId = gameDoc.id;
                currentGame = gameDoc.id;

                // Initialize chat and spectator features
                loadChatMessages();
                loadSpectators();
                joinAsSpectator(); // Player becomes spectator for this game

                // Hide lobby and start game
                document.getElementById('gameLobby').style.display = 'none';
                document.getElementById('pokerTable').style.display = 'flex';
                document.getElementById('gameMessage').style.display = 'block';
                document.getElementById('gameMessage').textContent = 'Game joined! Dealing cards... 🃏';

                // Start listening for game updates
                startGameListener();

                showNotification('Joined game! Get ready to play! 🎲', 'success');

            } catch (error) {
                console.error('Error joining game:', error);
                showNotification('Failed to join game', 'error');
            }
        }

        // Start game listener
        function startGameListener() {
            if (gameListener) gameListener();

            const { doc, onSnapshot } = window.firestoreUtils;
            const gameDoc = doc(window.db, 'pokerGames', gameState.gameId);

            gameListener = onSnapshot(gameDoc, (snapshot) => {
                if (snapshot.exists()) {
                    const gameData = snapshot.data();
                    updateGameState(gameData);
                } else {
                    showNotification('Game ended or was removed', 'warning');
                    returnToLobby();
                }
            });
        }

        // Update game state from Firebase
        function updateGameState(gameData) {
            currentGame = gameData;
            
            // Update UI based on game status
            if (gameData.status === 'active' && gameData.opponent) {
                // Show poker table
                document.getElementById('pokerTable').style.display = 'flex';
                document.getElementById('gameMessage').style.display = 'block';
                
                // Update opponent info
                const opponentName = gameData.creator === currentUser.id ? gameData.opponentName : gameData.creatorName;
                document.getElementById('opponentName').textContent = opponentName;
                
                // Send welcome chat message if this is the first time game becomes active
                if (gameData.phase === 'waiting') {
                    // Send automatic welcome message
                    db.collection('pokerChats').add({
                        gameId: currentGame.gameId || gameState.gameId,
                        username: 'System',
                        message: `${currentUser.username} and ${opponentName} joined the game! Good luck! 🎲`,
                        timestamp: new Date(),
                        type: 'system'
                    });
                }
                
                // Update game phase
                if (gameData.phase === 'waiting') {
                    document.getElementById('gameMessage').textContent = 'Game starting... Shuffling deck! 🃏';
                    // Auto-start the game
                    setTimeout(() => dealNewHand(), 2000);
                }
            }
        }

        // Deal new hand
        async function dealNewHand() {
            try {
                const deck = createDeck();
                shuffleDeck(deck);

                // Deal 2 cards to each player
                const playerCards = [deck.pop(), deck.pop()];
                const opponentCards = [deck.pop(), deck.pop()];

                // Update game state
                gameState.playerCards = playerCards;
                gameState.opponentCards = opponentCards;
                gameState.communityCards = [];
                gameState.phase = 'preflop';
                gameState.pot = gameState.smallBlind + gameState.bigBlind;
                gameState.playerChips = selectedBuyIn - gameState.bigBlind; // Big blind
                gameState.opponentChips = selectedBuyIn - gameState.smallBlind; // Small blind
                gameState.currentBet = gameState.bigBlind;
                gameState.turn = 'player'; // Player acts first in preflop

                // Update Firebase
                const { doc, updateDoc } = window.firestoreUtils;
                await updateDoc(doc(window.db, 'pokerGames', gameState.gameId), {
                    phase: 'preflop',
                    pot: gameState.pot,
                    playerCards: playerCards,
                    opponentCards: opponentCards,
                    communityCards: [],
                    currentBet: gameState.currentBet,
                    turn: gameState.turn,
                    updatedAt: new Date().toISOString()
                });

                // Update UI
                updateGameDisplay();
                
                document.getElementById('gameMessage').textContent = 'Cards dealt! Make your move! 🎲';
                document.getElementById('gameControls').style.display = 'block';

            } catch (error) {
                console.error('Error dealing new hand:', error);
                showNotification('Error dealing cards', 'error');
            }
        }

        // Update game display
        function updateGameDisplay() {
            // Update player cards
            const playerHandDiv = document.getElementById('playerHand');
            playerHandDiv.innerHTML = '';
            gameState.playerCards.forEach(card => {
                playerHandDiv.appendChild(createCardElement(card));
            });

            // Update opponent cards (hidden)
            const opponentHandDiv = document.getElementById('opponentHand');
            opponentHandDiv.innerHTML = '';
            gameState.opponentCards.forEach(() => {
                opponentHandDiv.appendChild(createCardElement(null, true));
            });

            // Update community cards
            const communityDiv = document.getElementById('communityCards');
            communityDiv.innerHTML = '';
            gameState.communityCards.forEach(card => {
                communityDiv.appendChild(createCardElement(card));
            });

            // Update pot and chips
            document.getElementById('potAmount').textContent = '$' + gameState.pot;
            document.getElementById('playerChips').textContent = '$' + gameState.playerChips;
            document.getElementById('opponentChips').textContent = '$' + gameState.opponentChips;
        }

        // Create deck of cards
        function createDeck() {
            const suits = ['♠', '♥', '♦', '♣'];
            const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const deck = [];

            suits.forEach(suit => {
                ranks.forEach(rank => {
                    deck.push({ rank, suit });
                });
            });

            return deck;
        }

        // Shuffle deck
        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        // Create card element
        function createCardElement(card, isHidden = false) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card dealing';

            if (isHidden || !card) {
                cardDiv.innerHTML = '<div class="card-back">🎲</div>';
            } else {
                const isRed = card.suit === '♥' || card.suit === '♦';
                const colorClass = isRed ? 'red' : 'black';
                
                cardDiv.innerHTML = `
                    <div class="card-top ${colorClass}">${card.rank}${card.suit}</div>
                    <div class="card-center ${colorClass}">${card.suit}</div>
                    <div class="card-bottom ${colorClass}">${card.rank}${card.suit}</div>
                `;
            }

            return cardDiv;
        }

        // Poker actions
        async function foldHand() {
            showNotification('You folded. Opponent wins!', 'warning');
            await endHand('opponent_won');
        }

        async function checkHand() {
            showNotification('You checked', 'success');
            // TODO: Handle check logic
        }

        async function callBet() {
            const callAmount = gameState.currentBet;
            if (callAmount > gameState.playerChips) {
                showNotification('Not enough chips to call!', 'error');
                return;
            }
            
            gameState.playerChips -= callAmount;
            gameState.pot += callAmount;
            
            showNotification(`You called $${callAmount}`, 'success');
            await updateGameInFirebase();
        }

        async function raiseBet() {
            const raiseAmount = parseInt(document.getElementById('betAmount').value);
            if (raiseAmount > gameState.playerChips) {
                showNotification('Not enough chips to raise!', 'error');
                return;
            }
            
            gameState.playerChips -= raiseAmount;
            gameState.pot += raiseAmount;
            gameState.currentBet = raiseAmount;
            
            showNotification(`You raised $${raiseAmount}`, 'success');
            await updateGameInFirebase();
        }

        async function allIn() {
            const allInAmount = gameState.playerChips;
            gameState.pot += allInAmount;
            gameState.playerChips = 0;
            
            showNotification('You went ALL IN!', 'warning');
            await updateGameInFirebase();
        }

        // Update game in Firebase
        async function updateGameInFirebase() {
            try {
                const { doc, updateDoc } = window.firestoreUtils;
                await updateDoc(doc(window.db, 'pokerGames', gameState.gameId), {
                    pot: gameState.pot,
                    playerChips: gameState.playerChips,
                    opponentChips: gameState.opponentChips,
                    currentBet: gameState.currentBet,
                    turn: gameState.turn === 'player' ? 'opponent' : 'player',
                    updatedAt: new Date().toISOString()
                });

                updateGameDisplay();
            } catch (error) {
                console.error('Error updating game:', error);
                showNotification('Error updating game', 'error');
            }
        }

        // End hand
        async function endHand(result) {
            try {
                const winAmount = gameState.pot;
                let won = false;

                if (result === 'player_won') {
                    won = true;
                    await updateUserBalance(winAmount);
                    showNotification(`You won $${winAmount}! 🏆`, 'success');
                } else {
                    showNotification(`You lost. Better luck next time! 😔`, 'error');
                }

                // Update poker stats
                await updatePokerStats(won, selectedBuyIn);

                // Save hand to history
                const winner = won ? currentUser.username : 'Opponent';
                const gameData = {
                    player1: currentUser.username,
                    player2: 'Opponent',
                    pot: gameState.pot,
                    communityCards: gameState.communityCards,
                    player1Cards: gameState.playerCards,
                    player2Cards: gameState.opponentCards || []
                };
                saveHandToHistory(gameData, winner, winAmount);

                // Clean up game
                setTimeout(() => {
                    returnToLobby();
                }, 3000);

            } catch (error) {
                console.error('Error ending hand:', error);
                showNotification('Error ending hand', 'error');
            }
        }

        // Update user balance
        async function updateUserBalance(amount) {
            currentUser.balance += amount;
            localStorage.setItem('familyBettingUser', JSON.stringify(currentUser));
            
            try {
                const { doc, updateDoc } = window.firestoreUtils;
                await updateDoc(doc(window.db, 'users', currentUser.id), {
                    balance: currentUser.balance
                });
                
                document.getElementById('userBalance').textContent = '$' + currentUser.balance.toLocaleString();
            } catch (error) {
                console.error('Error updating balance:', error);
            }
        }

        // Update poker stats
        async function updatePokerStats(won, amount) {
            try {
                const { doc, getDoc, updateDoc } = window.firestoreUtils;
                
                const userDoc = await getDoc(doc(window.db, 'users', currentUser.id));
                if (!userDoc.exists()) return;
                
                const userData = userDoc.data();
                
                const currentWins = userData.pokerWins || 0;
                const currentLosses = userData.pokerLosses || 0;
                const currentWinnings = userData.pokerWinnings || 0;
                
                if (won) {
                    await updateDoc(doc(window.db, 'users', currentUser.id), {
                        pokerWins: currentWins + 1,
                        pokerWinnings: currentWinnings + amount
                    });
                    pokerStats.wins++;
                    pokerStats.winnings += amount;
                } else {
                    await updateDoc(doc(window.db, 'users', currentUser.id), {
                        pokerLosses: currentLosses + 1
                    });
                    pokerStats.losses++;
                }
                
                updateStatsDisplay();
                
            } catch (error) {
                console.error('Error updating poker stats:', error);
            }
        }

        // Return to lobby
        function returnToLobby() {
            // Stop all listeners
            if (gameListener) {
                gameListener();
                gameListener = null;
            }
            if (chatListener) {
                chatListener();
                chatListener = null;
            }
            if (spectatorListener) {
                spectatorListener();
                spectatorListener = null;
            }

            // Clear current game reference
            currentGame = null;

            // Reset UI
            document.getElementById('gameLobby').style.display = 'block';
            document.getElementById('pokerTable').style.display = 'none';
            document.getElementById('gameMessage').style.display = 'none';
            document.getElementById('gameControls').style.display = 'none';

            // Reset game state
            gameState = {
                gameId: null,
                phase: 'waiting',
                pot: 0,
                playerChips: 0,
                opponentChips: 0,
                playerCards: [],
                opponentCards: [],
                communityCards: [],
                currentBet: 0,
                lastAction: null,
                turn: null,
                smallBlind: 25,
                bigBlind: 50
            };

            currentGame = null;
        }

        // Utility functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Auto-refresh user stats every 30 seconds
        setInterval(updateUserStats, 30000);
    </script>
</body>
</html>
