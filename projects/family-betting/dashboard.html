<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Betting Hub - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            position: relative;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #f44336;
        }

        .notification.warning {
            background: #ff9800;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .balance {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .admin-badge {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
            display: none;
            animation: pulse 2s infinite;
        }

        .admin-badge.show {
            display: inline-block;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0); }
        }

        .logout-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Quick Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            transition: all 0.3s ease;
        }

        .stat-value.positive {
            color: #4caf50;
        }

        .stat-value.negative {
            color: #f44336;
        }

        .stat-value.neutral {
            color: #ff9800;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        /* Betting Sections */
        .betting-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .section-btn {
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .section-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .section-icon {
            font-size: 2em;
        }

        /* Recent Activity */
        .activity-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-text {
            flex: 1;
        }

        .activity-time {
            font-size: 0.8em;
            color: #666;
        }

        /* Chat Section */
        .chat-container {
            grid-column: 1 / -1;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: white;
        }

        .chat-user {
            font-weight: bold;
            color: #667eea;
        }

        .chat-time {
            font-size: 0.8em;
            color: #666;
            margin-left: 10px;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .chat-send {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .chat-send:hover {
            background: #5a67d8;
        }

        /* Money Request Section */
        .money-requests {
            grid-column: 1 / -1;
        }

        /* Custom Bets Section */
        .custom-bets {
            grid-column: 1 / -1;
        }

        .bet-item {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .bet-item.pending {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .bet-item.accepted {
            background: #e8f5e8;
            border-color: #4caf50;
        }

        .bet-item.expired {
            background: #ffebee;
            border-color: #f44336;
        }

        .bet-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #333;
        }

        .bet-details {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .bet-amount {
            font-weight: bold;
            color: #4caf50;
            font-size: 1.1em;
        }

        .bet-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .bet-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .bet-status.pending {
            background: #ff9800;
            color: white;
        }

        .bet-status.accepted {
            background: #4caf50;
            color: white;
        }

        .bet-status.expired {
            background: #f44336;
            color: white;
        }

        .request-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-approve {
            background: #4caf50;
            color: white;
        }

        .btn-approve:hover {
            background: #45a049;
        }

        .btn-deny {
            background: #f44336;
            color: white;
        }

        .btn-deny:hover {
            background: #d32f2f;
        }

        .btn-request {
            background: #ff9800;
            color: white;
        }

        .btn-request:hover {
            background: #f57c00;
        }

        .btn-admin-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .btn-admin-remove:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Blackjack Section */
        .blackjack-section {
            grid-column: 1 / -1;
            text-align: center;
        }

        .game-btn {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .betting-sections {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }

            .admin-badge {
                font-size: 0.8em;
                padding: 5px 10px;
            }

            .main-content {
                padding: 20px 15px;
            }
        }

        /* Loading Animation */
        .loading {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Notification System -->
    <div id="notification" class="notification"></div>

    <!-- Header -->
    <div class="header">
        <div class="logo">🎰💰 Family Betting Hub</div>
        <div class="user-info">
            <div class="admin-badge" id="adminBadge">👑 ADMIN</div>
            <div class="balance" id="userBalance">$0</div>
            <span id="userName">Loading...</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Overview -->
        <div class="dashboard-grid">
            <!-- Quick Stats -->
            <div class="card">
                <div class="card-title">📊 Your Stats</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalBets">0</div>
                        <div class="stat-label">Total Bets</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="winRate">0%</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalWinnings">$0</div>
                        <div class="stat-label">Total Winnings</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="netProfit">$0</div>
                        <div class="stat-label">Net Profit</div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-title">🔄 Recent Activity</div>
                <div class="activity-list" id="activityList">
                    <div class="activity-item">
                        <div class="activity-text">Welcome to Family Betting Hub!</div>
                        <div class="activity-time">Just now</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Betting Sections -->
        <div class="betting-sections">
            <button class="section-btn" onclick="openSportsModal()">
                <div class="section-icon">🏈</div>
                <div>Sports Betting</div>
                <div style="font-size: 0.8em; opacity: 0.8;">NFL, NHL, College Football</div>
            </button>

            <button class="section-btn" onclick="openYesNoModal()">
                <div class="section-icon">❓</div>
                <div>Yes/No Bets</div>
                <div style="font-size: 0.8em; opacity: 0.8;">Simple predictions</div>
            </button>

            <button class="section-btn" onclick="openCustomModal()">
                <div class="section-icon">🎯</div>
                <div>Custom Bets</div>
                <div style="font-size: 0.8em; opacity: 0.8;">Anything goes!</div>
            </button>

            <button class="section-btn" onclick="openSquaresModal()">
                <div class="section-icon">⬜</div>
                <div>Game Squares</div>
                <div style="font-size: 0.8em; opacity: 0.8;">Super Bowl style</div>
            </button>

            <button class="section-btn" onclick="openMarchMadnessModal()">
                <div class="section-icon">🏀</div>
                <div>March Madness</div>
                <div style="font-size: 0.8em; opacity: 0.8;">Bracket Challenge</div>
            </button>
        </div>

        <!-- Chat and Additional Features -->
        <div class="dashboard-grid">
            <!-- Public Chat -->
            <div class="card chat-container">
                <div class="card-title">💬 Family Trash Talk</div>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message">
                        <span class="chat-user">System:</span>
                        Welcome to the family chat! Let the trash talk begin! 🔥
                        <span class="chat-time">Just now</span>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type your message..." maxlength="200">
                    <button class="chat-send" onclick="sendMessage()">Send</button>
                </div>
            </div>

            <!-- Money Requests -->
            <div class="card money-requests">
                <div class="card-title">💸 Money Requests</div>
                <div id="moneyRequestsList">
                    <p style="text-align: center; color: #666; padding: 20px;">No pending requests</p>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-request" onclick="openRequestModal()">Request Money</button>
                </div>
            </div>

            <!-- Custom Bets -->
            <div class="card custom-bets">
                <div class="card-title">🎯 Active Custom Bets</div>
                <div id="customBetsList">
                    <p style="text-align: center; color: #666; padding: 20px;">No active bets</p>
                </div>
            </div>

            <!-- Sports Bets -->
            <div class="card sports-bets">
                <div class="card-title">🏈 Active Sports Bets</div>
                <div id="sportsBetsList">
                    <p style="text-align: center; color: #666; padding: 20px;">No active sports bets</p>
                </div>
            </div>
        </div>

        <!-- Blackjack Section -->
        <div class="card blackjack-section">
            <div class="card-title">🃏 Blackjack Casino</div>
            <p style="margin-bottom: 20px; color: #666;">
                Feeling lucky? Test your skills against the house! 
                <br><strong>Warning:</strong> You can lose all your money here! 💀
            </p>
            <button class="game-btn" onclick="openBlackjack()">Play Blackjack</button>
        </div>

        <!-- Poker Section -->
        <div class="card poker-section">
            <div class="card-title">🎲 Heads-Up Poker</div>
            <p style="margin-bottom: 20px; color: #666;">
                Challenge family members to intense 1v1 poker battles! 
                <br><strong>Texas Hold'em:</strong> Skill meets luck in ultimate showdowns! 🔥
            </p>
            <button class="game-btn" onclick="openPoker()">Play Poker</button>
        </div>
    </div>

    <!-- Modals will be added here via JavaScript -->

    <!-- Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            where, 
            or,
            doc, 
            setDoc, 
            updateDoc, 
            getDoc, 
            onSnapshot,
            orderBy,
            serverTimestamp,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBs0mLN4_HzWx9nGdOjCsewT3X6F69Ysik",
            authDomain: "family-bets-1967f.firebaseapp.com",
            projectId: "family-bets-1967f",
            storageBucket: "family-bets-1967f.firebasestorage.app",
            messagingSenderId: "13304744240",
            appId: "1:13304744240:web:1e9a2c0ddb1703474b60f5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.db = db;
        window.firestoreUtils = { 
            collection, addDoc, getDocs, query, where, or, doc, setDoc, 
            updateDoc, getDoc, onSnapshot, orderBy, serverTimestamp, deleteDoc 
        };

        // Initialize dashboard
        initializeDashboard();
    </script>

    <script>
        // Global variables
        let currentUser = null;
        let chatListener = null;
        let requestsListener = null;
        let customBetsListener = null;
        let sportsBetsListener = null;

        // Initialize Dashboard
        async function initializeDashboard() {
            // Check if user is logged in
            const savedUser = localStorage.getItem('familyBettingUser');
            if (!savedUser) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = JSON.parse(savedUser);
            
            // Update UI with user info
            document.getElementById('userName').textContent = currentUser.username;
            
            // Show admin badge immediately if available in localStorage
            const adminBadge = document.getElementById('adminBadge');
            if (currentUser.isAdmin === 1) {
                adminBadge.classList.add('show');
            }
            
            await updateUserStats();
            
            // Start real-time listeners
            startChatListener();
            startRequestsListener();
            startCustomBetsListener();
            startSportsBetsListener();
            
            // Add welcome activity
            addActivityItem(`👋 Welcome back, ${currentUser.username}!`);
            
            showNotification('Welcome back, ' + currentUser.username + '!', 'success');
        }

        // Update user stats from database
        async function updateUserStats() {
            try {
                const { doc, getDoc } = window.firestoreUtils;
                const userDoc = await getDoc(doc(window.db, 'users', currentUser.id));
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentUser = { ...currentUser, ...userData };
                    localStorage.setItem('familyBettingUser', JSON.stringify(currentUser));
                    
                    // Update UI
                    document.getElementById('userBalance').textContent = '$' + userData.balance.toLocaleString();
                    
                    // Calculate combined betting stats (custom bets + blackjack + sports bets)
                    const customBetsWon = userData.betsWon || 0;
                    const customBetsLost = userData.betsLost || 0;
                    const blackjackWins = userData.blackjackWins || 0;
                    const blackjackHands = userData.blackjackHands || 0;
                    const blackjackLosses = blackjackHands - blackjackWins;
                    const sportsBetsWon = userData.sportsBetsWon || 0;
                    const sportsBetsLost = userData.sportsBetsLost || 0;
                    
                    const totalBets = customBetsWon + customBetsLost + blackjackHands + sportsBetsWon + sportsBetsLost;
                    const totalWins = customBetsWon + blackjackWins + sportsBetsWon;
                    
                    document.getElementById('totalBets').textContent = totalBets;
                    
                    // Show/hide admin badge
                    const adminBadge = document.getElementById('adminBadge');
                    if (userData.isAdmin === 1) {
                        adminBadge.classList.add('show');
                    } else {
                        adminBadge.classList.remove('show');
                    }
                    
                    const winRate = totalBets > 0 ? Math.round((totalWins / totalBets) * 100) : 0;
                    const winRateElement = document.getElementById('winRate');
                    winRateElement.textContent = winRate + '%';
                    
                    // Add color coding for win rate
                    winRateElement.className = 'stat-value';
                    if (winRate >= 60) winRateElement.classList.add('positive');
                    else if (winRate >= 40) winRateElement.classList.add('neutral');
                    else if (totalBets > 0) winRateElement.classList.add('negative');
                    
                    // Combine all winnings
                    const customWinnings = userData.totalWinnings || 0;
                    const blackjackWinnings = userData.blackjackWinnings || 0;
                    const sportsWinnings = userData.sportsWinnings || 0;
                    const combinedWinnings = customWinnings + blackjackWinnings + sportsWinnings;
                    
                    const totalWinningsElement = document.getElementById('totalWinnings');
                    totalWinningsElement.textContent = '$' + combinedWinnings.toLocaleString();
                    totalWinningsElement.className = 'stat-value';
                    if (combinedWinnings > 0) totalWinningsElement.classList.add('positive');
                    
                    // Calculate net profit (winnings - losses)
                    const totalLosses = userData.totalLosses || 0;
                    const sportsLosses = userData.sportsLosses || 0;
                    const allLosses = totalLosses + sportsLosses;
                    const netProfit = combinedWinnings - allLosses;
                    const netProfitElement = document.getElementById('netProfit');
                    netProfitElement.textContent = '$' + netProfit.toLocaleString();
                    netProfitElement.className = 'stat-value';
                    
                    if (netProfit > 0) {
                        netProfitElement.classList.add('positive');
                    } else if (netProfit < 0) {
                        netProfitElement.classList.add('negative');
                    } else {
                        netProfitElement.classList.add('neutral');
                    }
                }
            } catch (error) {
                console.error('Error updating user stats:', error);
                showNotification('Error loading user data', 'error');
            }
        }

        // Chat functionality
        function startChatListener() {
            const { collection, query, orderBy, onSnapshot } = window.firestoreUtils;
            const chatRef = collection(window.db, 'chatMessages');
            const chatQuery = query(chatRef, orderBy('timestamp', 'asc'));
            
            chatListener = onSnapshot(chatQuery, (snapshot) => {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const message = doc.data();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'chat-message';
                    
                    const time = message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString() : 'Now';
                    
                    messageDiv.innerHTML = `
                        <span class="chat-user">${message.username}:</span>
                        ${message.message}
                        <span class="chat-time">${time}</span>
                    `;
                    
                    messagesContainer.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const { collection, addDoc, serverTimestamp } = window.firestoreUtils;
                
                await addDoc(collection(window.db, 'chatMessages'), {
                    username: currentUser.username,
                    userID: currentUser.id,
                    message: message,
                    timestamp: serverTimestamp(),
                    type: 'public'
                });
                
                input.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message', 'error');
            }
        }

        // Money requests functionality
        function startRequestsListener() {
            const { collection, query, where, onSnapshot } = window.firestoreUtils;
            const requestsRef = collection(window.db, 'moneyRequests');
            const requestsQuery = query(requestsRef, where('toUser', '==', currentUser.id), where('status', '==', 'pending'));
            
            requestsListener = onSnapshot(requestsQuery, (snapshot) => {
                const requestsList = document.getElementById('moneyRequestsList');
                
                if (snapshot.empty) {
                    requestsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No pending requests</p>';
                    return;
                }
                
                requestsList.innerHTML = '';
                snapshot.forEach((docSnap) => {
                    const request = docSnap.data();
                    const requestDiv = document.createElement('div');
                    requestDiv.className = 'request-item';
                    
                    requestDiv.innerHTML = `
                        <div>
                            <strong>${request.fromUsername}</strong> wants $${request.amount}
                            <br><small>"${request.message}"</small>
                        </div>
                        <div class="request-actions">
                            <button class="btn btn-approve" onclick="respondToRequest('${docSnap.id}', 'approved')">
                                Approve
                            </button>
                            <button class="btn btn-deny" onclick="respondToRequest('${docSnap.id}', 'denied')">
                                Deny
                            </button>
                        </div>
                    `;
                    
                    requestsList.appendChild(requestDiv);
                });
            });
        }

        async function respondToRequest(requestId, status) {
            try {
                const { doc, getDoc, updateDoc } = window.firestoreUtils;
                
                // Get request details
                const requestDoc = await getDoc(doc(window.db, 'moneyRequests', requestId));
                if (!requestDoc.exists()) return;
                
                const requestData = requestDoc.data();
                
                // Update request status
                await updateDoc(doc(window.db, 'moneyRequests', requestId), {
                    status: status,
                    respondedAt: new Date().toISOString(),
                    responseMessage: status === 'approved' ? 'Approved!' : 'Denied'
                });
                
                if (status === 'approved') {
                    // Transfer money
                    const fromUserRef = doc(window.db, 'users', requestData.fromUser);
                    const toUserRef = doc(window.db, 'users', currentUser.id);
                    
                    // Update balances
                    await updateDoc(fromUserRef, {
                        balance: requestData.fromUserBalance + requestData.amount
                    });
                    
                    await updateDoc(toUserRef, {
                        balance: currentUser.balance - requestData.amount
                    });
                    
                    showNotification(`Sent $${requestData.amount} to ${requestData.fromUsername}`, 'success');
                    addActivityItem(`💸 Sent $${requestData.amount} to ${requestData.fromUsername}`);
                    await updateUserStats();
                } else {
                    showNotification(`Denied money request from ${requestData.fromUsername}`, 'warning');
                    addActivityItem(`❌ Denied money request from ${requestData.fromUsername} ($${requestData.amount})`);
                }
                
            } catch (error) {
                console.error('Error responding to request:', error);
                showNotification('Error processing request', 'error');
            }
        }

        // Custom Bets functionality
        function startCustomBetsListener() {
            const { collection, query, where, onSnapshot, or } = window.firestoreUtils;
            const betsRef = collection(window.db, 'customBets');
            
            // Listen for bets where user is creator or opponent
            const q = query(betsRef, or(
                where("creatorId", "==", currentUser.id),
                where("opponentId", "==", currentUser.id)
            ));
            
            customBetsListener = onSnapshot(q, (snapshot) => {
                const betsList = document.getElementById('customBetsList');
                betsList.innerHTML = '';
                
                if (snapshot.empty) {
                    betsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No active bets</p>';
                    return;
                }
                
                snapshot.forEach((doc) => {
                    const betData = doc.data();
                    const betDiv = createBetElement(doc.id, betData);
                    betsList.appendChild(betDiv);
                });
            });
        }

        // Sports Bets functionality  
        function startSportsBetsListener() {
            const { collection, query, where, onSnapshot, or } = window.firestoreUtils;
            const betsRef = collection(window.db, 'sportsBets');
            
            // Listen for bets where user is creator or opponent
            const q = query(betsRef, or(
                where("creatorId", "==", currentUser.id),
                where("opponentId", "==", currentUser.id)
            ));
            
            sportsBetsListener = onSnapshot(q, (snapshot) => {
                const betsList = document.getElementById('sportsBetsList');
                betsList.innerHTML = '';
                
                if (snapshot.empty) {
                    betsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No active sports bets</p>';
                    return;
                }
                
                snapshot.forEach((doc) => {
                    const betData = doc.data();
                    const betDiv = createSportsBetElement(doc.id, betData);
                    betsList.appendChild(betDiv);
                });
            });
        }

        function createSportsBetElement(betId, betData) {
            const div = document.createElement('div');
            const isCreator = betData.creatorId === currentUser.id;
            const now = new Date();
            const gameDate = new Date(betData.gameTime);
            const isExpired = now > gameDate;
            
            let statusClass = 'pending';
            if (isExpired && betData.status === 'pending') {
                statusClass = 'expired';
            } else if (betData.status === 'accepted') {
                statusClass = 'accepted';
            }
            
            div.className = `bet-item ${statusClass}`;
            
            let actionsHtml = '';
            if (betData.status === 'pending' && !isExpired) {
                if (isCreator) {
                    actionsHtml = `
                        <div class="bet-actions">
                            <button class="btn btn-deny" onclick="cancelSportsBet('${betId}')">Cancel Bet</button>
                        </div>
                    `;
                } else {
                    actionsHtml = `
                        <div class="bet-actions">
                            <button class="btn btn-approve" onclick="acceptSportsBet('${betId}')">Accept Bet</button>
                            <button class="btn btn-deny" onclick="declineSportsBet('${betId}')">Decline</button>
                        </div>
                    `;
                }
            } else if (betData.status === 'accepted') {
                actionsHtml = `
                    <div class="bet-actions">
                        <button class="btn btn-approve" onclick="settleSportsBet('${betId}', '${isCreator ? 'creator_won' : 'opponent_won'}')">I Won!</button>
                        <button class="btn btn-deny" onclick="settleSportsBet('${betId}', '${isCreator ? 'opponent_won' : 'creator_won'}')">They Won</button>
                    </div>
                `;
            }
            
            // Add admin remove button for completed bets
            const isCompleted = betData.status.includes('_won') || betData.status === 'cancelled' || 
                               betData.status === 'declined' || (betData.status === 'pending' && isExpired);
            
            if (isCompleted && currentUser && currentUser.isAdmin === 1) {
                actionsHtml += `
                    <div class="bet-actions" style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                        <button class="btn btn-admin-remove" onclick="adminRemoveSportsBet('${betId}')">🗑️ Admin Remove</button>
                    </div>
                `;
            }
            
            div.innerHTML = `
                <div class="bet-title">🏈 ${betData.league}: ${betData.matchup}</div>
                <div class="bet-details">
                    <p><strong>Challenger's Pick:</strong> ${betData.creatorPick}</p>
                    <p><strong>Challenger:</strong> ${betData.creatorUsername}</p>
                    <p><strong>Amount:</strong> <span class="bet-amount">$${betData.amount}</span></p>
                    <p><strong>Game Time:</strong> ${new Date(betData.gameTime).toLocaleString()}</p>
                    <span class="bet-status ${statusClass}">${isExpired && betData.status === 'pending' ? 'expired' : betData.status}</span>
                </div>
                ${actionsHtml}
            `;
            
            return div;
        }

        function createBetElement(betId, betData) {
            const div = document.createElement('div');
            const isCreator = betData.creatorId === currentUser.id;
            const now = new Date();
            const expiryDate = new Date(betData.expiresAt);
            const isExpired = now > expiryDate;
            
            let statusClass = 'pending';
            if (isExpired && betData.status === 'pending') {
                statusClass = 'expired';
            } else if (betData.status === 'accepted') {
                statusClass = 'accepted';
            }
            
            div.className = `bet-item ${statusClass}`;
            
            let actionsHtml = '';
            if (betData.status === 'pending' && !isExpired) {
                if (isCreator) {
                    actionsHtml = `
                        <div class="bet-actions">
                            <button class="btn btn-deny" onclick="cancelCustomBet('${betId}')">Cancel Bet</button>
                        </div>
                    `;
                } else {
                    actionsHtml = `
                        <div class="bet-actions">
                            <button class="btn btn-approve" onclick="acceptCustomBet('${betId}')">Accept Bet</button>
                            <button class="btn btn-deny" onclick="declineCustomBet('${betId}')">Decline</button>
                        </div>
                    `;
                }
            } else if (betData.status === 'accepted') {
                actionsHtml = `
                    <div class="bet-actions">
                        <button class="btn btn-approve" onclick="settleBet('${betId}', '${isCreator ? 'creator_won' : 'opponent_won'}')">I Won!</button>
                        <button class="btn btn-deny" onclick="settleBet('${betId}', '${isCreator ? 'opponent_won' : 'creator_won'}')">They Won</button>
                    </div>
                `;
            }
            
            // Add admin remove button for completed bets (settled, cancelled, expired)
            const isCompleted = betData.status.includes('_won') || betData.status === 'cancelled' || 
                               betData.status === 'declined' || (betData.status === 'pending' && isExpired);
            
            if (isCompleted && currentUser && currentUser.isAdmin === 1) {
                actionsHtml += `
                    <div class="bet-actions" style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
                        <button class="btn btn-admin-remove" onclick="adminRemoveBet('${betId}')">🗑️ Admin Remove</button>
                    </div>
                `;
            }
            
            div.innerHTML = `
                <div class="bet-title">${betData.title}</div>
                <div class="bet-details">
                    ${betData.description ? `<p>${betData.description}</p>` : ''}
                    <p><strong>Challenger:</strong> ${betData.creatorUsername}</p>
                    <p><strong>Amount:</strong> <span class="bet-amount">$${betData.amount}</span></p>
                    <p><strong>Expires:</strong> ${new Date(betData.expiresAt).toLocaleString()}</p>
                    <span class="bet-status ${statusClass}">${isExpired && betData.status === 'pending' ? 'expired' : betData.status}</span>
                </div>
                ${actionsHtml}
            `;
            
            return div;
        }

        async function acceptCustomBet(betId) {
            try {
                const { doc, getDoc, updateDoc } = window.firestoreUtils;
                
                const betDoc = await getDoc(doc(window.db, 'customBets', betId));
                if (!betDoc.exists()) return;
                
                const betData = betDoc.data();
                
                if (betData.amount > currentUser.balance) {
                    showNotification('Insufficient funds to accept this bet!', 'error');
                    return;
                }
                
                // Update bet status
                await updateDoc(doc(window.db, 'customBets', betId), {
                    status: 'accepted',
                    acceptedAt: new Date().toISOString()
                });
                
                // Deduct money from opponent's balance
                await updateUserBalance(-betData.amount);
                
                showNotification('Bet accepted! May the best person win! 🎯', 'success');
                
            } catch (error) {
                console.error('Error accepting bet:', error);
                showNotification('Failed to accept bet', 'error');
            }
        }

        async function declineCustomBet(betId) {
            try {
                const { doc, updateDoc } = window.firestoreUtils;
                
                await updateDoc(doc(window.db, 'customBets', betId), {
                    status: 'declined',
                    declinedAt: new Date().toISOString()
                });
                
                showNotification('Bet declined', 'success');
                
            } catch (error) {
                console.error('Error declining bet:', error);
                showNotification('Failed to decline bet', 'error');
            }
        }

        async function cancelCustomBet(betId) {
            try {
                const { doc, getDoc, updateDoc } = window.firestoreUtils;
                
                const betDoc = await getDoc(doc(window.db, 'customBets', betId));
                if (!betDoc.exists()) return;
                
                const betData = betDoc.data();
                
                await updateDoc(doc(window.db, 'customBets', betId), {
                    status: 'cancelled',
                    cancelledAt: new Date().toISOString()
                });
                
                // Refund money to creator
                await updateUserBalance(betData.amount);
                
                showNotification('Bet cancelled and money refunded', 'success');
                
            } catch (error) {
                console.error('Error cancelling bet:', error);
                showNotification('Failed to cancel bet', 'error');
            }
        }

        async function settleBet(betId, result) {
            try {
                const { doc, getDoc, updateDoc } = window.firestoreUtils;
                
                const betDoc = await getDoc(doc(window.db, 'customBets', betId));
                if (!betDoc.exists()) return;
                
                const betData = betDoc.data();
                
                await updateDoc(doc(window.db, 'customBets', betId), {
                    status: result,
                    winner: result.includes('creator') ? betData.creatorId : betData.opponentId,
                    settledAt: new Date().toISOString()
                });
                
                // Pay out winnings (2x the bet amount to the winner)
                const isWinner = (result.includes('creator') && betData.creatorId === currentUser.id) ||
                                (result.includes('opponent') && betData.opponentId === currentUser.id);
                
                if (isWinner) {
                    await updateUserBalance(betData.amount * 2);
                    showNotification('Congratulations! You won the bet! 🏆', 'success');
                    
                    // Update winner stats
                    await updateCustomBetStats(currentUser.id, true, betData.amount);
                    
                    // Log activity
                    addActivityItem(`🏆 Won custom bet: "${betData.title}" (+$${betData.amount})`);
                } else {
                    showNotification('Better luck next time! 😔', 'warning');
                    
                    // Update loser stats  
                    await updateCustomBetStats(currentUser.id, false, betData.amount);
                    
                    // Log activity
                    addActivityItem(`😔 Lost custom bet: "${betData.title}" (-$${betData.amount})`);
                }
                
                // Also update the other player's stats
                const otherPlayerId = betData.creatorId === currentUser.id ? betData.opponentId : betData.creatorId;
                const otherPlayerWon = !isWinner;
                await updateCustomBetStats(otherPlayerId, otherPlayerWon, betData.amount);
                
            } catch (error) {
                console.error('Error settling bet:', error);
                showNotification('Failed to settle bet', 'error');
            }
        }

        async function adminRemoveBet(betId) {
            // Double-check admin status
            if (!currentUser || currentUser.isAdmin !== 1) {
                showNotification('Access denied: Admin privileges required', 'error');
                return;
            }

            // Confirm deletion
            if (!confirm('Are you sure you want to permanently remove this bet? This action cannot be undone.')) {
                return;
            }

            try {
                const { doc, deleteDoc } = window.firestoreUtils;
                
                await deleteDoc(doc(window.db, 'customBets', betId));
                showNotification('Bet successfully removed by admin', 'success');
                
            } catch (error) {
                console.error('Error removing bet:', error);
                showNotification('Failed to remove bet', 'error');
            }
        }

        // Sports Bet Action Functions
        async function acceptSportsBet(betId) {
            try {
                const { doc, getDoc, updateDoc } = window.firestoreUtils;
                
                const betDoc = await getDoc(doc(window.db, 'sportsBets', betId));
                if (!betDoc.exists()) return;
                
                const betData = betDoc.data();
                
                if (betData.amount > currentUser.balance) {
                    showNotification('Insufficient funds to accept this sports bet!', 'error');
                    return;
                }
                
                // Update bet status
                await updateDoc(doc(window.db, 'sportsBets', betId), {
                    status: 'accepted',
                    acceptedAt: new Date().toISOString()
                });
                
                // Deduct money from opponent's balance
                await updateUserBalance(-betData.amount);
                
                showNotification('Sports bet accepted! Game on! 🏈', 'success');
                addActivityItem(`🏈 Accepted sports bet: ${betData.matchup} ($${betData.amount})`);
                
            } catch (error) {
                console.error('Error accepting sports bet:', error);
                showNotification('Failed to accept sports bet', 'error');
            }
        }

        async function declineSportsBet(betId) {
            try {
                const { doc, updateDoc } = window.firestoreUtils;
                
                await updateDoc(doc(window.db, 'sportsBets', betId), {
                    status: 'declined',
                    declinedAt: new Date().toISOString()
                });
                
                showNotification('Sports bet declined', 'success');
                
            } catch (error) {
                console.error('Error declining sports bet:', error);
                showNotification('Failed to decline sports bet', 'error');
            }
        }

        async function cancelSportsBet(betId) {
            try {
                const { doc, getDoc, updateDoc } = window.firestoreUtils;
                
                const betDoc = await getDoc(doc(window.db, 'sportsBets', betId));
                if (!betDoc.exists()) return;
                
                const betData = betDoc.data();
                
                await updateDoc(doc(window.db, 'sportsBets', betId), {
                    status: 'cancelled',
                    cancelledAt: new Date().toISOString()
                });
                
                // Refund money to creator
                await updateUserBalance(betData.amount);
                
                showNotification('Sports bet cancelled and refunded', 'success');
                
            } catch (error) {
                console.error('Error cancelling sports bet:', error);
                showNotification('Failed to cancel sports bet', 'error');
            }
        }

        async function settleSportsBet(betId, result) {
            try {
                const { doc, getDoc, updateDoc } = window.firestoreUtils;
                
                const betDoc = await getDoc(doc(window.db, 'sportsBets', betId));
                if (!betDoc.exists()) return;
                
                const betData = betDoc.data();
                
                await updateDoc(doc(window.db, 'sportsBets', betId), {
                    status: result,
                    winner: result.includes('creator') ? betData.creatorId : betData.opponentId,
                    settledAt: new Date().toISOString()
                });
                
                const winnerAmount = betData.amount * 2;
                
                if (result === 'creator_won') {
                    if (betData.creatorId === currentUser.id) {
                        await updateUserBalance(winnerAmount);
                        showNotification(`You won the sports bet! +$${winnerAmount} 🏆`, 'success');
                        addActivityItem(`🏆 Won sports bet: ${betData.matchup} (+$${winnerAmount})`);
                    }
                    await updateSportsBetStats(betData.creatorId, true, betData.amount);
                    await updateSportsBetStats(betData.opponentId, false, betData.amount);
                } else {
                    if (betData.opponentId === currentUser.id) {
                        await updateUserBalance(winnerAmount);
                        showNotification(`You won the sports bet! +$${winnerAmount} 🏆`, 'success');
                        addActivityItem(`🏆 Won sports bet: ${betData.matchup} (+$${winnerAmount})`);
                    }
                    await updateSportsBetStats(betData.opponentId, true, betData.amount);
                    await updateSportsBetStats(betData.creatorId, false, betData.amount);
                }
                
            } catch (error) {
                console.error('Error settling sports bet:', error);
                showNotification('Failed to settle sports bet', 'error');
            }
        }

        async function adminRemoveSportsBet(betId) {
            // Double-check admin status
            if (!currentUser || currentUser.isAdmin !== 1) {
                showNotification('Access denied: Admin privileges required', 'error');
                return;
            }

            // Confirm deletion
            if (!confirm('Are you sure you want to permanently remove this sports bet? This action cannot be undone.')) {
                return;
            }

            try {
                const { doc, deleteDoc } = window.firestoreUtils;
                
                await deleteDoc(doc(window.db, 'sportsBets', betId));
                showNotification('Sports bet successfully removed by admin', 'success');
                
            } catch (error) {
                console.error('Error removing sports bet:', error);
                showNotification('Failed to remove sports bet', 'error');
            }
        }

        async function updateSportsBetStats(userId, won, amount) {
            try {
                const { doc, getDoc, updateDoc } = window.firestoreUtils;
                
                const userDoc = await getDoc(doc(window.db, 'users', userId));
                if (!userDoc.exists()) return;
                
                const userData = userDoc.data();
                
                const currentSportsBetsWon = userData.sportsBetsWon || 0;
                const currentSportsBetsLost = userData.sportsBetsLost || 0;
                const currentSportsWinnings = userData.sportsWinnings || 0;
                const currentSportsLosses = userData.sportsLosses || 0;
                
                if (won) {
                    await updateDoc(doc(window.db, 'users', userId), {
                        sportsBetsWon: currentSportsBetsWon + 1,
                        sportsWinnings: currentSportsWinnings + amount
                    });
                } else {
                    await updateDoc(doc(window.db, 'users', userId), {
                        sportsBetsLost: currentSportsBetsLost + 1,
                        sportsLosses: currentSportsLosses + amount
                    });
                }
                
            } catch (error) {
                console.error('Error updating sports bet stats:', error);
            }
        }

        async function updateCustomBetStats(userId, won, amount) {
            try {
                const { doc, getDoc, updateDoc } = window.firestoreUtils;
                
                const userDoc = await getDoc(doc(window.db, 'users', userId));
                if (!userDoc.exists()) return;
                
                const userData = userDoc.data();
                
                const currentBetsWon = userData.betsWon || 0;
                const currentBetsLost = userData.betsLost || 0;
                const currentTotalWinnings = userData.totalWinnings || 0;
                const currentTotalLosses = userData.totalLosses || 0;
                
                if (won) {
                    await updateDoc(doc(window.db, 'users', userId), {
                        betsWon: currentBetsWon + 1,
                        totalWinnings: currentTotalWinnings + amount  // Amount won (not including original bet)
                    });
                } else {
                    await updateDoc(doc(window.db, 'users', userId), {
                        betsLost: currentBetsLost + 1,
                        totalLosses: currentTotalLosses + amount  // Amount lost
                    });
                }
                
                // Refresh current user's stats if this update was for them
                if (userId === currentUser.id) {
                    await updateUserStats();
                }
                
            } catch (error) {
                console.error('Error updating custom bet stats:', error);
            }
        }

        // Modal functions (will be implemented for each betting type)
        function openSportsModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="modal-title">🏈 Sports Betting</h2>
                    <form id="sportsBetForm">
                        <div class="form-group">
                            <label for="sportsLeague">League</label>
                            <select id="sportsLeague" required onchange="loadTeamsForLeague()">
                                <option value="">Select a league...</option>
                                <option value="nfl">🏈 NFL</option>
                                <option value="nhl">🏒 NHL</option>
                                <option value="ncaaf">🏈 College Football</option>
                            </select>
                        </div>

                        <div class="form-group" id="teamSelectionGroup" style="display: none;">
                            <label for="team1">Team 1</label>
                            <select id="team1" required onchange="updateTeam2Options()">
                                <option value="">Select Team 1...</option>
                            </select>
                        </div>

                        <div class="form-group" id="team2Group" style="display: none;">
                            <label for="team2">Team 2 (vs)</label>
                            <select id="team2" required>
                                <option value="">Select Team 2...</option>
                            </select>
                        </div>

                        <div class="form-group" id="betSelectionGroup" style="display: none;">
                            <label for="betType">Your Bet</label>
                            <select id="betType" required>
                                <option value="">Choose your pick...</option>
                                <option id="team1WinOption" value="">Team 1 Wins</option>
                                <option id="team2WinOption" value="">Team 2 Wins</option>
                            </select>
                        </div>

                        <div class="form-group" id="opponentGroup" style="display: none;">
                            <label for="sportsOpponent">Challenge User</label>
                            <select id="sportsOpponent" required>
                                <option value="">Select opponent...</option>
                            </select>
                        </div>

                        <div class="form-group" id="amountGroup" style="display: none;">
                            <label for="sportsAmount">Bet Amount ($)</label>
                            <input type="number" id="sportsAmount" min="1" max="${currentUser?.balance || 0}" required>
                        </div>

                        <div class="form-group" id="gameTimeGroup" style="display: none;">
                            <label for="gameTime">Game Date/Time</label>
                            <input type="datetime-local" id="gameTime" required>
                        </div>

                        <div class="modal-actions">
                            <button type="button" class="btn btn-deny" onclick="closeModal(this)">Cancel</button>
                            <button type="submit" class="btn btn-approve">Place Sports Bet</button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);
            loadUsersForSportsBet();
            
            // Add form submission handler
            document.getElementById('sportsBetForm').addEventListener('submit', submitSportsBet);
        }

        function openMarchMadnessModal() {
            showNotification('March Madness Bracket Challenge coming soon! 🏀�', 'warning');
        }

        function openYesNoModal() {
            showNotification('Yes/No betting coming soon! ❓', 'warning');
        }

        function openCustomModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 class="modal-title">🎯 Create Custom Bet</h2>
                    <form id="customBetForm">
                        <div class="form-group">
                            <label for="betTitle">Bet Title</label>
                            <input type="text" id="betTitle" placeholder="e.g., Who will win the next game?" required>
                        </div>
                        <div class="form-group">
                            <label for="betDescription">Description (Optional)</label>
                            <textarea id="betDescription" rows="3" placeholder="Add more details about the bet..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="betAmount">Bet Amount ($)</label>
                            <input type="number" id="betAmount" min="1" max="${currentUser.balance}" placeholder="Enter amount" required>
                        </div>
                        <div class="form-group">
                            <label for="betOpponent">Challenge User</label>
                            <select id="betOpponent" required>
                                <option value="">Select a user to challenge</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="betExpiry">Bet Expires</label>
                            <select id="betExpiry" required>
                                <option value="1">1 Hour</option>
                                <option value="6">6 Hours</option>
                                <option value="24" selected>24 Hours</option>
                                <option value="168">1 Week</option>
                                <option value="720">1 Month</option>
                            </select>
                        </div>
                        <div class="modal-actions">
                            <button type="button" onclick="closeModal(this)" class="btn btn-deny">Cancel</button>
                            <button type="submit" class="btn btn-approve">Create Bet</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            loadUsersForCustomBet();
            
            document.getElementById('customBetForm').addEventListener('submit', submitCustomBet);
        }

        function openSquaresModal() {
            showNotification('Game squares coming soon! ⬜', 'warning');
        }

        function openBlackjack() {
            window.location.href = 'blackjack.html';
        }

        function openPoker() {
            window.location.href = 'poker.html';
        }

        function openRequestModal() {
            // Create and show money request modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="close-modal" onclick="closeModal(this)">&times;</button>
                    <div class="modal-title">💸 Request Money</div>
                    <form onsubmit="submitMoneyRequest(event)">
                        <div class="form-group">
                            <label>Select Family Member:</label>
                            <select id="requestToUser" required>
                                <option value="">Choose someone...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount ($):</label>
                            <input type="number" id="requestAmount" min="1" max="10000" required>
                        </div>
                        <div class="form-group">
                            <label>Reason/Message:</label>
                            <textarea id="requestMessage" placeholder="Why do you need this money?" maxlength="200" required></textarea>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-request">Send Request</button>
                            <button type="button" class="btn btn-deny" onclick="closeModal(this)">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            loadUsersForRequest();
        }

        async function loadUsersForRequest() {
            try {
                const { collection, getDocs } = window.firestoreUtils;
                const usersSnapshot = await getDocs(collection(window.db, 'users'));
                const select = document.getElementById('requestToUser');
                
                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (doc.id !== currentUser.id) {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = userData.username;
                        select.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function submitMoneyRequest(event) {
            event.preventDefault();
            
            const toUserId = document.getElementById('requestToUser').value;
            const amount = parseInt(document.getElementById('requestAmount').value);
            const message = document.getElementById('requestMessage').value.trim();
            
            // Check if user can beg (15 min cooldown)
            if (currentUser.lastBegTime) {
                const lastBegTime = new Date(currentUser.lastBegTime);
                const now = new Date();
                const timeDiff = (now - lastBegTime) / (1000 * 60); // minutes
                
                if (timeDiff < 15) {
                    const remainingTime = Math.ceil(15 - timeDiff);
                    showNotification(`You can only beg once every 15 minutes! Wait ${remainingTime} more minutes.`, 'error');
                    return;
                }
            }
            
            try {
                const { collection, addDoc, doc, getDoc, updateDoc } = window.firestoreUtils;
                
                // Get target user's data
                const toUserDoc = await getDoc(doc(window.db, 'users', toUserId));
                const toUserData = toUserDoc.data();
                
                // Create money request
                await addDoc(collection(window.db, 'moneyRequests'), {
                    fromUser: currentUser.id,
                    fromUsername: currentUser.username,
                    fromUserBalance: currentUser.balance,
                    toUser: toUserId,
                    toUsername: toUserData.username,
                    amount: amount,
                    message: message,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                });
                
                // Update user's last beg time
                await updateDoc(doc(window.db, 'users', currentUser.id), {
                    lastBegTime: new Date().toISOString()
                });
                
                closeModal(event.target);
                showNotification(`Money request sent to ${toUserData.username}!`, 'success');
                
            } catch (error) {
                console.error('Error submitting money request:', error);
                showNotification('Failed to send request', 'error');
            }
        }

        // Custom Betting Functions
        async function loadUsersForCustomBet() {
            try {
                const { collection, getDocs } = window.firestoreUtils;
                const usersRef = collection(window.db, 'users');
                const snapshot = await getDocs(usersRef);
                
                const select = document.getElementById('betOpponent');
                select.innerHTML = '<option value="">Select a user to challenge</option>';
                
                snapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.username !== currentUser.username) {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = userData.username;
                        select.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Failed to load users', 'error');
            }
        }

        async function submitCustomBet(event) {
            event.preventDefault();
            
            const title = document.getElementById('betTitle').value.trim();
            const description = document.getElementById('betDescription').value.trim();
            const amount = parseInt(document.getElementById('betAmount').value);
            const opponentId = document.getElementById('betOpponent').value;
            const expiryHours = parseInt(document.getElementById('betExpiry').value);
            
            if (!title || !amount || !opponentId) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showNotification('Insufficient funds!', 'error');
                return;
            }
            
            try {
                const { collection, addDoc } = window.firestoreUtils;
                
                const expiryDate = new Date();
                expiryDate.setHours(expiryDate.getHours() + expiryHours);
                
                const betData = {
                    title: title,
                    description: description || '',
                    amount: amount,
                    creatorId: currentUser.id,
                    creatorUsername: currentUser.username,
                    opponentId: opponentId,
                    status: 'pending', // pending, accepted, creator_won, opponent_won, cancelled, expired
                    createdAt: new Date().toISOString(),
                    expiresAt: expiryDate.toISOString(),
                    winner: null,
                    settledAt: null
                };
                
                await addDoc(collection(window.db, 'customBets'), betData);
                
                // Deduct money from creator's balance
                await updateUserBalance(-amount);
                
                showNotification('Custom bet created successfully!', 'success');
                closeModal(document.querySelector('.modal'));
                
            } catch (error) {
                console.error('Error creating custom bet:', error);
                showNotification('Failed to create bet', 'error');
            }
        }

        async function submitSportsBet(event) {
            event.preventDefault();
            
            const league = document.getElementById('sportsLeague').value;
            const team1 = document.getElementById('team1').value;
            const team2 = document.getElementById('team2').value;
            const betType = document.getElementById('betType').value;
            const opponentId = document.getElementById('sportsOpponent').value;
            const amount = parseInt(document.getElementById('sportsAmount').value);
            const gameTime = document.getElementById('gameTime').value;
            
            if (!league || !team1 || !team2 || !betType || !opponentId || !amount || !gameTime) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showNotification('Insufficient funds!', 'error');
                return;
            }
            
            try {
                const { collection, addDoc } = window.firestoreUtils;
                
                const gameDate = new Date(gameTime);
                if (gameDate <= new Date()) {
                    showNotification('Game time must be in the future!', 'error');
                    return;
                }
                
                const sportsBetData = {
                    type: 'sports',
                    league: league,
                    team1: team1,
                    team2: team2,
                    matchup: `${team1} vs ${team2}`,
                    creatorPick: betType,
                    amount: amount,
                    creatorId: currentUser.id,
                    creatorUsername: currentUser.username,
                    opponentId: opponentId,
                    gameTime: gameTime,
                    status: 'pending', // pending, accepted, creator_won, opponent_won, cancelled, expired
                    createdAt: new Date().toISOString(),
                    expiresAt: gameDate.toISOString(), // Expires when game starts
                    winner: null,
                    settledAt: null
                };
                
                await addDoc(collection(window.db, 'sportsBets'), sportsBetData);
                
                // Deduct money from creator's balance
                await updateUserBalance(-amount);
                
                showNotification('Sports bet created successfully! 🏈', 'success');
                addActivityItem(`🏈 Created sports bet: ${team1} vs ${team2} ($${amount})`);
                closeModal(document.querySelector('.modal'));
                
            } catch (error) {
                console.error('Error creating sports bet:', error);
                showNotification('Failed to create sports bet', 'error');
            }
        }

        async function updateUserBalance(amount) {
            currentUser.balance += amount;
            localStorage.setItem('familyBettingUser', JSON.stringify(currentUser));
            
            try {
                const { doc, updateDoc } = window.firestoreUtils;
                await updateDoc(doc(window.db, 'users', currentUser.id), {
                    balance: currentUser.balance
                });
                
                document.getElementById('userBalance').textContent = '$' + currentUser.balance.toLocaleString();
            } catch (error) {
                console.error('Error updating balance:', error);
            }
        }

        // Sports Betting Functions
        const sportsTeams = {
            nfl: [
                'Arizona Cardinals', 'Atlanta Falcons', 'Baltimore Ravens', 'Buffalo Bills',
                'Carolina Panthers', 'Chicago Bears', 'Cincinnati Bengals', 'Cleveland Browns',
                'Dallas Cowboys', 'Denver Broncos', 'Detroit Lions', 'Green Bay Packers',
                'Houston Texans', 'Indianapolis Colts', 'Jacksonville Jaguars', 'Kansas City Chiefs',
                'Las Vegas Raiders', 'Los Angeles Chargers', 'Los Angeles Rams', 'Miami Dolphins',
                'Minnesota Vikings', 'New England Patriots', 'New Orleans Saints', 'New York Giants',
                'New York Jets', 'Philadelphia Eagles', 'Pittsburgh Steelers', 'San Francisco 49ers',
                'Seattle Seahawks', 'Tampa Bay Buccaneers', 'Tennessee Titans', 'Washington Commanders'
            ],
            nhl: [
                'Anaheim Ducks', 'Arizona Coyotes', 'Boston Bruins', 'Buffalo Sabres',
                'Calgary Flames', 'Carolina Hurricanes', 'Chicago Blackhawks', 'Colorado Avalanche',
                'Columbus Blue Jackets', 'Dallas Stars', 'Detroit Red Wings', 'Edmonton Oilers',
                'Florida Panthers', 'Los Angeles Kings', 'Minnesota Wild', 'Montreal Canadiens',
                'Nashville Predators', 'New Jersey Devils', 'New York Islanders', 'New York Rangers',
                'Ottawa Senators', 'Philadelphia Flyers', 'Pittsburgh Penguins', 'San Jose Sharks',
                'Seattle Kraken', 'St. Louis Blues', 'Tampa Bay Lightning', 'Toronto Maple Leafs',
                'Vancouver Canucks', 'Vegas Golden Knights', 'Washington Capitals', 'Winnipeg Jets'
            ],
            ncaaf: [
                'Alabama Crimson Tide', 'Georgia Bulldogs', 'Michigan Wolverines', 'Texas Longhorns',
                'Ohio State Buckeyes', 'Penn State Nittany Lions', 'Oregon Ducks', 'USC Trojans',
                'Clemson Tigers', 'Florida State Seminoles', 'Miami Hurricanes', 'Notre Dame Fighting Irish',
                'Oklahoma Sooners', 'LSU Tigers', 'Auburn Tigers', 'Florida Gators',
                'Tennessee Volunteers', 'Kentucky Wildcats', 'Wisconsin Badgers', 'Iowa Hawkeyes',
                'Michigan State Spartans', 'Nebraska Cornhuskers', 'UCLA Bruins', 'Washington Huskies',
                'Stanford Cardinal', 'Utah Utes', 'Arizona State Sun Devils', 'Colorado Buffaloes',
                'Texas A&M Aggies', 'Arkansas Razorbacks', 'Mississippi State Bulldogs', 'Ole Miss Rebels'
            ]
        };

        function loadTeamsForLeague() {
            const league = document.getElementById('sportsLeague').value;
            const team1Select = document.getElementById('team1');
            const teamSelectionGroup = document.getElementById('teamSelectionGroup');
            
            if (!league) {
                teamSelectionGroup.style.display = 'none';
                return;
            }

            // Clear and populate team 1 options
            team1Select.innerHTML = '<option value="">Select Team 1...</option>';
            sportsTeams[league].forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                team1Select.appendChild(option);
            });

            teamSelectionGroup.style.display = 'block';
            document.getElementById('team2Group').style.display = 'none';
            document.getElementById('betSelectionGroup').style.display = 'none';
            document.getElementById('opponentGroup').style.display = 'none';
            document.getElementById('amountGroup').style.display = 'none';
            document.getElementById('gameTimeGroup').style.display = 'none';
        }

        function updateTeam2Options() {
            const league = document.getElementById('sportsLeague').value;
            const team1 = document.getElementById('team1').value;
            const team2Select = document.getElementById('team2');
            const team2Group = document.getElementById('team2Group');
            
            if (!team1) {
                team2Group.style.display = 'none';
                return;
            }

            // Clear and populate team 2 options (exclude team 1)
            team2Select.innerHTML = '<option value="">Select Team 2...</option>';
            sportsTeams[league].forEach(team => {
                if (team !== team1) {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    team2Select.appendChild(option);
                }
            });

            team2Group.style.display = 'block';
            
            // Add onchange to team2 to trigger bet options
            team2Select.onchange = updateBetOptions;
        }

        function updateBetOptions() {
            const team1 = document.getElementById('team1').value;
            const team2 = document.getElementById('team2').value;
            
            if (team1 && team2) {
                document.getElementById('team1WinOption').value = team1;
                document.getElementById('team1WinOption').textContent = `${team1} Wins`;
                document.getElementById('team2WinOption').value = team2;
                document.getElementById('team2WinOption').textContent = `${team2} Wins`;
                
                document.getElementById('betSelectionGroup').style.display = 'block';
                document.getElementById('opponentGroup').style.display = 'block';
                document.getElementById('amountGroup').style.display = 'block';
                document.getElementById('gameTimeGroup').style.display = 'block';
            }
        }

        async function loadUsersForSportsBet() {
            try {
                const { collection, getDocs } = window.firestoreUtils;
                const usersSnapshot = await getDocs(collection(window.db, 'users'));
                const sportsOpponentSelect = document.getElementById('sportsOpponent');
                
                sportsOpponentSelect.innerHTML = '<option value="">Select opponent...</option>';
                
                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    if (doc.id !== currentUser.id) {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = userData.username;
                        sportsOpponentSelect.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Utility functions
        function closeModal(element) {
            const modal = element.closest('.modal');
            if (modal) {
                modal.remove();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function addActivityItem(message) {
            const activityList = document.getElementById('activityList');
            const now = new Date().toLocaleTimeString();
            
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            activityItem.innerHTML = `
                <div class="activity-text">${message}</div>
                <div class="activity-time">${now}</div>
            `;
            
            // Add to top of list
            activityList.insertBefore(activityItem, activityList.firstChild);
            
            // Keep only last 10 activities
            while (activityList.children.length > 10) {
                activityList.removeChild(activityList.lastChild);
            }
        }

        function logout() {
            // Stop listeners
            if (chatListener) chatListener();
            if (requestsListener) requestsListener();
            if (customBetsListener) customBetsListener();
            if (sportsBetsListener) sportsBetsListener();
            
            localStorage.removeItem('familyBettingUser');
            window.location.href = 'index.html';
        }

        // Chat input enter key support
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && event.target.id === 'chatInput') {
                sendMessage();
            }
        });

        // Auto-refresh user stats every 30 seconds
        setInterval(updateUserStats, 30000);
    </script>
</body>
</html>
