<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pong — with Settings</title>
  <style>
    :root { color-scheme: dark; }
    html, body { margin: 0; height: 100%; background: #0b0b0b; color: #eaeaea; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    header {
      position: fixed; left: 0; right: 0; top: 0; height: 40px;
      display: flex; align-items: center; gap: 8px; padding: 0 10px; background: #101010cc; backdrop-filter: blur(4px);
      border-bottom: 1px solid #1f1f1f; z-index: 3;
    }
    header .title { font-weight: 700; letter-spacing: 0.3px; font-size: 13px; opacity: 0.9; }
    header .spacer { flex: 1; }
    header .nav-link { display: inline-flex; align-items: center; height: 26px; padding: 0 10px; margin-left: 8px; color: #eaeaea; text-decoration: none; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px; }
    header .nav-link:hover { background: #222; }
    header button {
      height: 26px; padding: 0 10px; font: inherit; color: #eaeaea; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px; cursor: pointer;
    }
    header button:hover { background: #222; }
    .wrap { position: fixed; inset: 40px 0 0 0; display: grid; place-items: center; }
    canvas { image-rendering: pixelated; image-rendering: crisp-edges; background: #000; box-shadow: 0 8px 32px rgba(0,0,0,0.6); border: 1px solid #222; touch-action: none; }
    footer { position: fixed; left: 0; right: 0; bottom: 0; text-align: center; font-size: 12px; opacity: 0.7; padding: 6px 0; pointer-events: none; }
    /* Settings panel */
    #settings {
      position: fixed; top: 48px; right: 10px; width: 260px; max-width: calc(100% - 20px);
      background: #0e0e0e; border: 1px solid #262626; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      padding: 12px; z-index: 4; display: none;
    }
    #settings.open { display: block; }
    #settings h3 { margin: 6px 0 10px; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; margin: 8px 0; }
    .row > label { font-size: 12px; opacity: 0.9; }
    .row > input[type="range"] { width: 130px; }
    .row > select, .row > input[type="checkbox"] { justify-self: end; }
    .hint { font-size: 11px; opacity: 0.7; margin-top: 6px; }
    .k { opacity: 0.7; }
  </style>
</head>
<body>
  <header>
    <div class="title">Pong</div>
    <a href="../../index.html" class="nav-link" title="Home">Home</a>
    <a href="../index.html" class="nav-link" title="Projects">Projects</a>
    <div class="spacer"></div>
    <button id="btn-settings" title="Settings (O)">⚙️</button>
    <button id="btn-fullscreen" title="Fullscreen (F)">⛶</button>
    <button id="btn-reset" title="Reset (R)">Reset</button>
  </header>

  <div id="settings" aria-label="Settings panel">
    <h3>Settings</h3>
    <div class="row">
      <label>AI Right Paddle</label>
      <input id="s-ai" type="checkbox" />
    </div>
    <div class="row">
      <label>AI Difficulty</label>
      <select id="s-ai-diff">
        <option value="easy">Easy</option>
        <option value="normal" selected>Normal</option>
        <option value="hard">Hard</option>
      </select>
    </div>
    <div class="row">
      <label>Paddle Height</label>
      <input id="s-paddle" type="range" min="20" max="60" step="2" />
    </div>
    <div class="row">
      <label>Ball Speed x</label>
      <input id="s-speed" type="range" min="0.8" max="1.8" step="0.05" />
    </div>
    <div class="row">
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Pong — Single File</title>
        <style>
          :root { color-scheme: dark; }
          html, body { margin: 0; height: 100%; background: #0b0b0b; color: #eaeaea; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
          header {
            position: fixed; left: 0; right: 0; top: 0; height: 40px;
            display: flex; align-items: center; gap: 8px; padding: 0 10px; background: #101010cc; backdrop-filter: blur(4px);
            border-bottom: 1px solid #1f1f1f; z-index: 3;
          }
          header .title { font-weight: 700; letter-spacing: 0.3px; font-size: 13px; opacity: 0.9; }
          header .nav-link { display: inline-flex; align-items: center; height: 26px; padding: 0 10px; color: #eaeaea; text-decoration: none; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px; }
          header .nav-link:hover { background: #222; }
          header .spacer { flex: 1; }
          header button { height: 26px; padding: 0 10px; font: inherit; color: #eaeaea; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px; cursor: pointer; }
          header button:hover { background: #222; }
          .wrap { position: fixed; inset: 40px 0 0 0; display: grid; place-items: center; }
          canvas { image-rendering: pixelated; image-rendering: crisp-edges; background: #000; box-shadow: 0 8px 32px rgba(0,0,0,0.6); border: 1px solid #222; touch-action: none; }
          footer { position: fixed; left: 0; right: 0; bottom: 0; text-align: center; font-size: 12px; opacity: 0.7; padding: 6px 0; pointer-events: none; }
          /* Settings panel */
          #settings { position: fixed; top: 48px; right: 10px; width: 260px; max-width: calc(100% - 20px); background: #0e0e0e; border: 1px solid #262626; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); padding: 12px; z-index: 4; display: none; }
          #settings.open { display: block; }
          #settings h3 { margin: 6px 0 10px; font-size: 14px; }
          .row { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; margin: 8px 0; }
          .row > label { font-size: 12px; opacity: 0.9; }
          .row > input[type="range"] { width: 130px; }
          .row > select, .row > input[type="checkbox"] { justify-self: end; }
          .hint { font-size: 11px; opacity: 0.7; margin-top: 6px; }
          .k { opacity: 0.7; }
        </style>
      </head>
      <body>
        <header>
          <div class="title">Pong</div>
          <a href="../../index.html" class="nav-link" title="Home">Home</a>
          <a href="../index.html" class="nav-link" title="Projects">Projects</a>
          <div class="spacer"></div>
          <button id="btn-settings" title="Settings (O)">⚙️</button>
          <button id="btn-fullscreen" title="Fullscreen (F)">⛶</button>
          <button id="btn-reset" title="Reset (R)">Reset</button>
        </header>

        <div id="settings" aria-label="Settings panel">
          <h3>Settings</h3>
          <div class="row"><label>AI Right Paddle</label><input id="s-ai" type="checkbox" /></div>
          <div class="row"><label>AI Difficulty</label>
            <select id="s-ai-diff"><option value="easy">Easy</option><option value="normal" selected>Normal</option><option value="hard">Hard</option></select>
          </div>
          <div class="row"><label>Paddle Height</label><input id="s-paddle" type="range" min="20" max="60" step="2" /></div>
          <div class="row"><label>Ball Speed x</label><input id="s-speed" type="range" min="0.8" max="1.8" step="0.05" /></div>
          <div class="row"><label>Win Score</label>
            <select id="s-win"><option>5</option><option selected>11</option><option>15</option><option>21</option></select>
          </div>
          <div class="row"><label>Theme</label>
            <select id="s-theme"><option value="classic" selected>Classic</option><option value="neon">Neon</option><option value="dmg">DMG</option></select>
          </div>
          <div class="row"><label>Sound</label><input id="s-sound" type="checkbox" /></div>
          <div class="hint">Changes apply immediately and are saved.</div>
        </div>

        <div class="wrap"><canvas id="game" width="320" height="180" aria-label="Pong game canvas"></canvas></div>
        <footer>W/S or Up/Down = P1 • Space = Serve • P = Pause • R = Reset • O = Settings • F = Fullscreen</footer>

        <script type="module">
          // Pong with settings, audio, touch, gamepad. Single-file inline.

          /** @typedef {{x:number,y:number,w:number,h:number}} Rect */
          const GAME_W = 320, GAME_H = 180, TARGET_HZ = 60, FIXED_DT = 1/TARGET_HZ;

          // Persistent settings
          const DEFAULTS = { aiEnabled:true, aiDifficulty:'normal', paddleH:32, ballSpeedMul:1.0, winningScore:11, theme:'classic', sound:true, spin:true };
          const STORE_KEY = 'pong.settings.v1';
          const cfg = loadSettings();

          // DOM
          const canvas = document.getElementById('game');
          const ctx = canvas.getContext('2d', { alpha:false });
          const $ = (id) => document.getElementById(id);

          // Wire UI (after DOM is ready)
          function wireUI(){
            $('#btn-settings')?.addEventListener('click', toggleSettings);
            $('#btn-reset')?.addEventListener('click', () => reset(true));
            $('#btn-fullscreen')?.addEventListener('click', tryFullscreen);
            initSettingsPanel();
          }

          // Key controls
          window.addEventListener('keydown', (e) => {
            if (['ArrowUp','ArrowDown','w','s','W','S',' '].includes(e.key)) e.preventDefault();
            if (e.key === 'p' || e.key === 'P') paused = !paused;
            if (e.key === 'r' || e.key === 'R') reset(true);
            if (e.key === 'a' || e.key === 'A') setCfg('aiEnabled', !cfg.aiEnabled);
            if (e.key === 'o' || e.key === 'O') toggleSettings();
            if (e.key === 'f' || e.key === 'F') tryFullscreen();
            if (e.key === ' ') tryServe();
          }, { passive:false });

          // Scale logical 320x180 to window (letterboxed)
          function resize(){
            const maxX = Math.floor((window.innerWidth) / GAME_W) || 1;
            const maxY = Math.floor((window.innerHeight - 40) / GAME_H) || 1; // minus header
            const scale = Math.max(1, Math.min(maxX, maxY));
            canvas.style.width = (GAME_W * scale) + 'px';
            canvas.style.height = (GAME_H * scale) + 'px';
            canvas.width = GAME_W; canvas.height = GAME_H;
            ctx.imageSmoothingEnabled = false;
          }
          window.addEventListener('resize', resize); resize();

          // Keyboard input state
          const keys = new Set();
          window.addEventListener('keydown', (e) => keys.add(e.key));
          window.addEventListener('keyup', (e) => keys.delete(e.key));

          // Touch controls (drag to set P1)
          let touching = false;
          canvas.addEventListener('pointerdown', (e) => { touching = true; updatePaddleFromPointer(e); });
          canvas.addEventListener('pointermove', (e) => { if (touching) updatePaddleFromPointer(e); });
          canvas.addEventListener('pointerup', () => touching = false);
          function updatePaddleFromPointer(e){ const rect = canvas.getBoundingClientRect(); const y = ((e.clientY - rect.top) / rect.height) * GAME_H; p1.y = clamp(y - p1.h/2, 2, GAME_H - p1.h - 2); }

          // Game state
          /** @type Rect */ const p1 = { x:8, y:GAME_H/2 - DEFAULTS.paddleH/2, w:4, h:cfg.paddleH };
          /** @type Rect */ const p2 = { x:GAME_W - 12, y:GAME_H/2 - DEFAULTS.paddleH/2, w:4, h:cfg.paddleH };
          const ball = { x:GAME_W/2, y:GAME_H/2, r:2.5, vx:0, vy:0 };
          let p1Score=0, p2Score=0, paused=false, awaitingServe=true; let lastTime=performance.now(), acc=0;

          // Themes
          const THEMES = {
            classic:{ bg:'#000', net:'#444', fg:'#fff', text:'#eaeaea', hud:'#9aa0a6' },
            neon:{ bg:'#05060a', net:'#182a35', fg:'#2ee6a6', text:'#b7fff1', hud:'#6ad6ff' },
            dmg:{ bg:'#0f380f', net:'#224422', fg:'#8bac0f', text:'#c4f000', hud:'#9bbc0f' }
          };

          // Audio
          let actx = null; function ensureAudio(){ if (!actx){ try{ actx = new (window.AudioContext || window.webkitAudioContext)(); }catch{} } }
          function beep(freq=440, dur=0.06, type='square', vol=0.03){ if (!cfg.sound) return; ensureAudio(); if (!actx) return; const t0=actx.currentTime; const o=actx.createOscillator(); const g=actx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g).connect(actx.destination); o.start(t0); o.stop(t0+dur); }

          // Helpers
          function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
          function rectCircleOverlap(rect,cx,cy,r){ const nx=clamp(cx,rect.x,rect.x+rect.w); const ny=clamp(cy,rect.y,rect.y+rect.h); const dx=cx-nx, dy=cy-ny; return dx*dx + dy*dy <= r*r; }

          // AI params
          function aiParams(){ switch(cfg.aiDifficulty){ case 'easy': return { speed:110, jitter:0.4 }; case 'hard': return { speed:170, jitter:0.05 }; default: return { speed:140, jitter:0.15 }; } }

          // Core
          function reset(full=false){ p1.h = p2.h = cfg.paddleH; p1.y = GAME_H/2 - p1.h/2; p2.y = GAME_H/2 - p2.h/2; ball.x = GAME_W/2; ball.y = GAME_H/2; ball.vx=0; ball.vy=0; awaitingServe = true; if (full){ p1Score=0; p2Score=0; } }
          function tryServe(){ if (!awaitingServe) return; awaitingServe=false; ensureAudio(); const dir = Math.random()<0.5?-1:1; const base = 100 * cfg.ballSpeedMul; const angle = (Math.random()*0.5 - 0.25); ball.vx = dir * base * (1 + Math.abs(angle)*0.4); ball.vy = base * angle; }
          function score(pointRight){ if (pointRight) p2Score++; else p1Score++; beep(220,0.09,'sawtooth',0.04); if (p1Score >= cfg.winningScore || p2Score >= cfg.winningScore) paused = true; reset(false); }

          function update(dt){
            // P1 movement (W/S or Arrows)
            const P1S = 150; let dy1 = 0;
            if (keys.has('w') || keys.has('W') || keys.has('ArrowUp')) dy1 -= 1;
            if (keys.has('s') || keys.has('S') || keys.has('ArrowDown')) dy1 += 1;
            const p1PrevY = p1.y; p1.y += dy1 * P1S * dt;

            // P2 movement (AI or player via Arrows)
            const p2PrevY = p2.y;
            if (cfg.aiEnabled){ const { speed, jitter } = aiParams(); const targetY = ball.y + (ball.vy * 0.12) - p2.h/2 + ((Math.random()-0.5) * p2.h * jitter); const delta = targetY - p2.y; const maxMove = speed * dt; p2.y += clamp(delta, -maxMove, maxMove); }
            else { const P2S = 150; let dy2 = 0; if (keys.has('ArrowUp')) dy2 -= 1; if (keys.has('ArrowDown')) dy2 += 1; p2.y += dy2 * P2S * dt; }

            // Clamp paddles
            p1.y = clamp(p1.y, 2, GAME_H - p1.h - 2); p2.y = clamp(p2.y, 2, GAME_H - p2.h - 2);

            // Ball physics
            if (!awaitingServe){ ball.x += ball.vx * dt; ball.y += ball.vy * dt;
              // Walls
              if (ball.y - ball.r < 0){ ball.y = ball.r; ball.vy = Math.abs(ball.vy); beep(800,0.03); }
              if (ball.y + ball.r > GAME_H){ ball.y = GAME_H - ball.r; ball.vy = -Math.abs(ball.vy); beep(800,0.03); }
              // Paddle collisions + spin
              const spinFactor = cfg.spin ? 45 : 0;
              if (rectCircleOverlap(p1, ball.x, ball.y, ball.r) && ball.vx < 0){ const hitPos = ((ball.y - (p1.y + p1.h/2)) / (p1.h/2)); const speed = Math.hypot(ball.vx, ball.vy) * 1.05 + 5; const newAngle = hitPos * 0.6; ball.vx = Math.abs(Math.cos(newAngle) * speed); ball.vy = Math.sin(newAngle) * speed + (p1.y - p1PrevY) * spinFactor; ball.x = p1.x + p1.w + ball.r + 0.01; beep(600,0.025); }
              else if (rectCircleOverlap(p2, ball.x, ball.y, ball.r) && ball.vx > 0){ const hitPos = ((ball.y - (p2.y + p2.h/2)) / (p2.h/2)); const speed = Math.hypot(ball.vx, ball.vy) * 1.05 + 5; const newAngle = hitPos * 0.6; ball.vx = -Math.abs(Math.cos(newAngle) * speed); ball.vy = Math.sin(newAngle) * speed + (p2.y - p2PrevY) * spinFactor; ball.x = p2.x - ball.r - 0.01; beep(600,0.025); }
              // Scoring
              if (ball.x < -10) score(true); else if (ball.x > GAME_W + 10) score(false);
            }

            // Gamepad (pad 0 controls P1)
            const pads = navigator.getGamepads ? navigator.getGamepads() : []; const gp = pads && pads[0];
            if (gp && gp.connected){ const y = Math.abs(gp.axes[1]) > 0.12 ? gp.axes[1] : (gp.buttons[12]?.pressed ? -1 : gp.buttons[13]?.pressed ? 1 : 0); p1.y = clamp(p1.y + y * 160 * dt, 2, GAME_H - p1.h - 2); if (gp.buttons[0]?.pressed) tryServe(); }
          }

          function drawNet(theme){ ctx.fillStyle = theme.net; const dashH=6, gap=5, w=2; for (let y=0; y<GAME_H; y+=dashH+gap) ctx.fillRect(GAME_W/2 - w/2, y, w, dashH); }

          let fps=60, fpsAcc=0, fpsFrames=0;
          function draw(){
            const theme = THEMES[cfg.theme] || THEMES.classic;
            ctx.fillStyle = theme.bg; ctx.fillRect(0,0,GAME_W,GAME_H);
            drawNet(theme);
            ctx.fillStyle = theme.fg; ctx.fillRect(p1.x, Math.round(p1.y), p1.w, p1.h); ctx.fillRect(p2.x, Math.round(p2.y), p2.w, p2.h);
            ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = theme.text; ctx.font = '10px monospace'; ctx.textAlign = 'center';
            ctx.fillText(String(p1Score).padStart(2,'0'), GAME_W/2 - 24, 16);
            ctx.fillText(String(p2Score).padStart(2,'0'), GAME_W/2 + 24, 16);
            ctx.textAlign = 'left'; ctx.fillStyle = theme.hud; ctx.fillText(`AI:${cfg.aiEnabled?cfg.aiDifficulty.toUpperCase():'OFF'}`, 6, GAME_H - 6);
            ctx.textAlign = 'right'; ctx.fillText(`${Math.round(fps)} FPS`, GAME_W-6, GAME_H - 6);
            if (paused) overlay('Paused — P to resume'); else if (awaitingServe) overlay('Press Space to serve');
          }

          function overlay(text){ ctx.fillStyle = 'rgba(0,0,0,0.55)'; ctx.fillRect(0,0,GAME_W,GAME_H); const theme = THEMES[cfg.theme] || THEMES.classic; ctx.fillStyle = theme.fg; ctx.font = '12px monospace'; ctx.textAlign = 'center'; ctx.fillText(text, GAME_W/2, GAME_H/2); }

          // Main loop
          function frame(now){ const dt = Math.min(0.25, (now - lastTime) / 1000); lastTime = now; if (!paused){ acc += dt; let steps=0; while (acc >= FIXED_DT && steps < 5){ update(FIXED_DT); acc -= FIXED_DT; steps++; } } fpsAcc += dt; fpsFrames++; if (fpsAcc >= 0.5){ fps = fpsFrames / fpsAcc; fpsAcc = 0; fpsFrames = 0; } draw(); requestAnimationFrame(frame); }

          // Settings helpers
          function initSettingsPanel(){ $('#s-ai').checked = cfg.aiEnabled; $('#s-ai-diff').value = cfg.aiDifficulty; $('#s-paddle').value = cfg.paddleH; $('#s-speed').value = cfg.ballSpeedMul; $('#s-win').value = String(cfg.winningScore); $('#s-theme').value = cfg.theme; $('#s-sound').checked = cfg.sound;
            $('#s-ai').addEventListener('change', (e)=> setCfg('aiEnabled', e.target.checked));
            $('#s-ai-diff').addEventListener('change', (e)=> setCfg('aiDifficulty', e.target.value));
            $('#s-paddle').addEventListener('input', (e)=> setCfg('paddleH', parseInt(e.target.value,10), true));
            $('#s-speed').addEventListener('input', (e)=> setCfg('ballSpeedMul', parseFloat(e.target.value)));
            $('#s-win').addEventListener('change', (e)=> setCfg('winningScore', parseInt(e.target.value,10), true));
            $('#s-theme').addEventListener('change', (e)=> setCfg('theme', e.target.value));
            $('#s-sound').addEventListener('change', (e)=> setCfg('sound', e.target.checked));
          }
          function toggleSettings(){ const panel = $('#settings'); panel.classList.toggle('open'); }
          function setCfg(key, value, resetPositions=false){ cfg[key] = value; saveSettings(); if (key === 'paddleH' || key === 'winningScore') reset(resetPositions); }
          function tryFullscreen(){ const root = document.documentElement; if (!document.fullscreenElement) root.requestFullscreen?.(); else document.exitFullscreen?.(); }

          // Storage
          function loadSettings(){ try{ const raw = localStorage.getItem(STORE_KEY); if (!raw) return { ...DEFAULTS }; const data = JSON.parse(raw); return { ...DEFAULTS, ...data }; } catch { return { ...DEFAULTS }; } }
          function saveSettings(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(cfg)); } catch{} }

          // Init & run
          wireUI(); reset(true); requestAnimationFrame((t)=>{ lastTime = t; requestAnimationFrame(frame); });
        </script>
      </body>
      </html>