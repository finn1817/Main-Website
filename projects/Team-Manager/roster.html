<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roster Management - Sports Team Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .league-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #eee;
            border-radius: 10px;
            background: #f9f9f9;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #27ae60;
        }
        
        button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .player-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .player-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .jersey-number {
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .player-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .navigation {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .nav-button {
            margin: 0 10px;
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
        }
        
        .team-selector {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .hidden {
            display: none;
        }
        
        .injury-tag {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .file-upload {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .player-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="league-info" id="leagueInfo">Loading...</div>
            <h1>üë• Roster Management</h1>
            <p id="teamTitle">Select a team to manage players</p>
        </div>
        
        <div class="content">
            <!-- Team Selection -->
            <div class="team-selector">
                <h2>üìã Select Team</h2>
                <div class="form-row">
                    <div>
                        <label for="teamSelect">Choose Team:</label>
                        <select id="teamSelect" onchange="selectTeam()">
                            <option value="">Select a team...</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: end; gap: 10px;">
                        <button onclick="refreshTeams()" class="btn-success">üîÑ Refresh Teams</button>
                        <button onclick="debugTeamInfo()" class="btn-warning">üîç Debug Info</button>
                        <button onclick="reinitializePage()" class="btn-danger">üîß Fix Issues</button>
                    </div>
                </div>
            </div>
            
            <!-- Add New Player Section -->
            <div class="section" id="addPlayerSection">
                <h2>‚ûï Add New Player</h2>
                <div id="noTeamWarning" class="warning-message">
                    ‚ö†Ô∏è Please select a team first before adding players.
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="playerName">Player Name:</label>
                        <input type="text" id="playerName" placeholder="Full name">
                    </div>
                    <div class="form-group">
                        <label for="jerseyNumber">Jersey Number:</label>
                        <input type="number" id="jerseyNumber" placeholder="##">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="position">Position:</label>
                        <input type="text" id="position" placeholder="e.g., Point Guard, Forward">
                    </div>
                    <div class="form-group">
                        <label for="playerPhone">Phone:</label>
                        <input type="tel" id="playerPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="playerEmail">Email:</label>
                        <input type="email" id="playerEmail" placeholder="Email address">
                    </div>
                    <div class="form-group">
                        <label for="emergencyContact">Emergency Contact:</label>
                        <input type="text" id="emergencyContact" placeholder="Name and phone">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="medicalInfo">Medical Information:</label>
                    <textarea id="medicalInfo" rows="2" placeholder="Allergies, conditions, medications, etc."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Upload Documents:</label>
                    <div class="file-upload">
                        <input type="file" id="playerDocuments" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        <p>Upload medical forms, waivers, photos, etc.</p>
                    </div>
                </div>
                
                <button onclick="addPlayer()" class="btn-success">Add Player</button>
            </div>
            
            <!-- Players List -->
            <div class="section" id="playersSection">
                <h2>üë§ Team Roster</h2>
                <div id="playersContainer">
                    <p>Select a team to view players...</p>
                </div>
            </div>
            
            <!-- Player Stats Modal -->
            <div id="statsModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 id="statsPlayerName">Player Statistics</h2>
                    <div id="statsContent"></div>
                    <button onclick="closeStatsModal()" class="btn-danger">Close</button>
                    <button onclick="savePlayerStats()" class="btn-success">Save Stats</button>
                </div>
            </div>
            
            <div class="navigation">
                <button class="nav-button" onclick="window.location.href='index.html'">üè† Back to League</button>
                <button class="nav-button" onclick="window.location.href='tournament.html'">üèÜ Tournaments</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCeZVcMrPv1-RNmRvJwJR2SdPrNYZ2YLs",
            authDomain: "team-manager-51b49.firebaseapp.com",
            projectId: "team-manager-51b49",
            storageBucket: "team-manager-51b49.firebasestorage.app",
            messagingSenderId: "811968699332",
            appId: "1:811968699332:web:2e2af08d88e6b8a70c2291"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentLeague = null;
        let currentTeam = null;
        let currentPlayer = null;
        let players = [];

        // Load saved data on page load
        window.addEventListener('load', async function() {
            console.log('=== PAGE LOAD START ===');
            
            try {
                await initializePage();
            } catch (error) {
                console.error('Critical error during page initialization:', error);
                alert('Failed to initialize page. Redirecting to main page.');
                localStorage.removeItem('currentLeague');
                localStorage.removeItem('selectedTeam');
                window.location.href = 'index.html';
            }
        });

        async function initializePage() {
            const savedLeague = localStorage.getItem('currentLeague');
            const savedTeam = localStorage.getItem('selectedTeam');
            
            console.log('Page loaded - Saved league:', savedLeague);
            console.log('Page loaded - Saved team:', savedTeam);
            
            if (!savedLeague) {
                console.error('No saved league found');
                alert('Please select a league first');
                window.location.href = 'index.html';
                return;
            }
            
            // Parse and validate league data
            try {
                currentLeague = JSON.parse(savedLeague);
                console.log('Parsed current league:', currentLeague);
                
                // Handle Firestore timestamp objects that might cause issues
                if (currentLeague && currentLeague.createdAt && typeof currentLeague.createdAt === 'object' && currentLeague.createdAt.seconds) {
                    console.log('Converting Firestore timestamp to Date');
                    currentLeague.createdAt = new Date(currentLeague.createdAt.seconds * 1000);
                }
            } catch (error) {
                console.error('Error parsing league data:', error);
                alert('Error parsing league data. Please select a league again.');
                localStorage.removeItem('currentLeague');
                window.location.href = 'index.html';
                return;
            }
            
            if (!currentLeague || !currentLeague.id || !currentLeague.name) {
                console.error('Invalid league data:', currentLeague);
                alert('Invalid league data. Please select a league again.');
                localStorage.removeItem('currentLeague');
                window.location.href = 'index.html';
                return;
            }
            
            // Update UI with league info
            document.getElementById('leagueInfo').textContent = `League: ${currentLeague.name}`;
            console.log('Set league info in UI');
            
            // Parse team data if available
            if (savedTeam) {
                try {
                    currentTeam = JSON.parse(savedTeam);
                    console.log('Parsed current team:', currentTeam);
                    
                    if (currentTeam && currentTeam.name) {
                        document.getElementById('teamTitle').textContent = `Managing: ${currentTeam.name}`;
                        console.log('Updated team title to:', currentTeam.name);
                    } else {
                        console.warn('Parsed team lacks name property:', currentTeam);
                    }
                } catch (error) {
                    console.error('Error parsing saved team:', error);
                    localStorage.removeItem('selectedTeam');
                    currentTeam = null;
                }
            } else {
                console.log('No saved team found');
            }
            
            // Load teams and set up the page
            console.log('About to load teams...');
            const loadedTeams = await loadTeams();
            
            // Set selected team if available
            if (currentTeam && currentTeam.id) {
                console.log('Setting team select to:', currentTeam.id);
                const select = document.getElementById('teamSelect');
                select.value = currentTeam.id;
                
                if (select.value === currentTeam.id) {
                    console.log('Team selection successful');
                    document.getElementById('noTeamWarning').classList.add('hidden');
                    await loadPlayers();
                } else {
                    console.warn('Team not found in options, clearing selection');
                    console.warn('Available teams:', loadedTeams.map(t => t.id));
                    currentTeam = null;
                    localStorage.removeItem('selectedTeam');
                    document.getElementById('noTeamWarning').classList.remove('hidden');
                    document.getElementById('teamTitle').textContent = 'Select a team to manage players';
                }
            } else {
                console.log('No valid team selected, showing warning');
                document.getElementById('noTeamWarning').classList.remove('hidden');
            }
            
            // Final status check
            console.log('=== INITIALIZATION COMPLETE ===');
            console.log('Final state - League:', currentLeague?.name, 'Team:', currentTeam?.name);
            
            // Verification check
            if (currentLeague) {
                console.log('‚úÖ League successfully loaded:', currentLeague.name, 'ID:', currentLeague.id);
            } else {
                console.error('‚ùå League failed to load');
            }
            
            if (currentTeam) {
                console.log('‚úÖ Team successfully loaded:', currentTeam.name, 'ID:', currentTeam.id);
            } else {
                console.log('‚ö†Ô∏è No team loaded (this is OK if none was selected)');
            }
            
            // Show a helpful message if no teams are available
            if (loadedTeams && loadedTeams.length === 0) {
                document.getElementById('playersContainer').innerHTML = `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 1px solid #ffeaa7;">
                        <h3 style="color: #856404; margin-bottom: 10px;">‚ö†Ô∏è No Teams Available</h3>
                        <p>No teams found in this league. Please:</p>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>Go back to the <a href="index.html" style="color: #007bff;">League Dashboard</a></li>
                            <li>Add a team using the "Add New Team" section</li>
                            <li>Return here to manage players</li>
                        </ol>
                    </div>
                `;
            }
            
            console.log('=== PAGE LOAD COMPLETE ===');
        }

        async function loadTeams() {
            if (!currentLeague || !currentLeague.id) {
                console.error('Cannot load teams - no current league or league ID');
                throw new Error('No current league available');
            }

            try {
                console.log('Loading teams for league ID:', currentLeague.id);
                const q = query(collection(db, "teams"), where("leagueId", "==", currentLeague.id));
                const querySnapshot = await getDocs(q);
                
                const select = document.getElementById('teamSelect');
                if (!select) {
                    throw new Error('Team select element not found');
                }
                
                select.innerHTML = '<option value="">Select a team...</option>';

                let teamCount = 0;
                const teams = [];
                
                querySnapshot.forEach((doc) => {
                    const team = doc.data();
                    teams.push({ id: doc.id, ...team });
                    console.log('Found team:', doc.id, team);
                    
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${team.teamName || team.name} (Coach: ${team.coachName})`;
                    option.dataset.teamName = team.teamName || team.name;
                    option.dataset.coachName = team.coachName;
                    select.appendChild(option);
                    teamCount++;
                });

                console.log(`Successfully loaded ${teamCount} teams for league: ${currentLeague.name}`);
                
                if (teamCount === 0) {
                    console.warn('No teams found for league');
                    const noTeamsOption = document.createElement('option');
                    noTeamsOption.value = "";
                    noTeamsOption.textContent = "No teams found - create one first";
                    noTeamsOption.disabled = true;
                    select.appendChild(noTeamsOption);
                    
                    // Show message to user
                    const container = document.getElementById('playersContainer');
                    if (container) {
                        container.innerHTML = '<p style="color: #e67e22; font-weight: bold;">No teams found in this league. Please go back to the main page and create a team first.</p>';
                    }
                }

                return teams;

            } catch (error) {
                console.error('Error loading teams:', error);
                const select = document.getElementById('teamSelect');
                if (select) {
                    select.innerHTML = '<option value="">Error loading teams</option>';
                }
                throw new Error(`Failed to load teams: ${error.message}`);
            }
        }

        window.refreshTeams = async function() {
            await loadTeams();
        }

        window.debugTeamInfo = function() {
            console.log('=== COMPREHENSIVE DEBUG INFO ===');
            console.log('Current League:', currentLeague);
            console.log('Current Team:', currentTeam);
            
            const rawLeague = localStorage.getItem('currentLeague');
            const rawTeam = localStorage.getItem('selectedTeam');
            console.log('LocalStorage - currentLeague (raw):', rawLeague);
            console.log('LocalStorage - selectedTeam (raw):', rawTeam);
            
            // Try to parse localStorage data to see if it's valid
            try {
                const parsedLeague = JSON.parse(rawLeague);
                console.log('LocalStorage league parses to:', parsedLeague);
            } catch (e) {
                console.error('League localStorage parse error:', e);
            }
            
            try {
                const parsedTeam = JSON.parse(rawTeam);
                console.log('LocalStorage team parses to:', parsedTeam);
            } catch (e) {
                console.error('Team localStorage parse error:', e);
            }
            
            const select = document.getElementById('teamSelect');
            console.log('Team select element:', select);
            console.log('Team select value:', select?.value);
            if (select) {
                console.log('Team select options:', Array.from(select.options).map(opt => ({
                    value: opt.value, 
                    text: opt.textContent, 
                    teamName: opt.dataset.teamName,
                    coachName: opt.dataset.coachName
                })));
            }
            
            // Check form elements
            const formElements = {
                playerName: document.getElementById('playerName')?.value,
                jerseyNumber: document.getElementById('jerseyNumber')?.value,
                position: document.getElementById('position')?.value,
            };
            console.log('Form elements:', formElements);
            
            const debugInfo = `=== TEAM MANAGER DEBUG INFO ===

üèÜ LEAGUE STATUS:
${currentLeague ? '‚úÖ League: ' + currentLeague.name + ' (ID: ' + currentLeague.id + ')' : '‚ùå No League Selected'}

üë• TEAM STATUS:
${currentTeam ? '‚úÖ Team: ' + currentTeam.name + ' (ID: ' + currentTeam.id + ')' : '‚ùå No Team Selected'}

üìã SELECT DROPDOWN:
Value: "${select.value}"
Options Count: ${select.options.length}

üíæ LOCALSTORAGE:
League: ${localStorage.getItem('currentLeague') ? 'EXISTS' : 'MISSING'}
Team: ${localStorage.getItem('selectedTeam') ? 'EXISTS' : 'MISSING'}

üìù FORM STATUS:
Player Name Field: ${formElements.playerName !== undefined ? 'EXISTS' : 'MISSING'}

Check browser console for detailed logs.`;
            
            alert(debugInfo);
        }

        // Manual re-initialization function
        window.reinitializePage = async function() {
            console.log('=== MANUAL RE-INITIALIZATION ===');
            
            try {
                // Clear current state
                currentLeague = null;
                currentTeam = null;
                
                // Re-run initialization
                await initializePage();
                
                alert('Page re-initialized successfully!');
            } catch (error) {
                console.error('Re-initialization failed:', error);
                alert('Re-initialization failed: ' + error.message);
            }
        }

        window.selectTeam = async function() {
            try {
                const select = document.getElementById('teamSelect');
                const selectedOption = select.options[select.selectedIndex];
                
                console.log('Team selection changed:', select.value);
                console.log('Selected option:', selectedOption);
                
                if (select.value) {
                    currentTeam = {
                        id: select.value,
                        name: selectedOption.dataset.teamName || selectedOption.textContent,
                        coachName: selectedOption.dataset.coachName
                    };
                    
                    console.log('Setting currentTeam to:', currentTeam);
                    
                    // Validate team data
                    if (!currentTeam.id || !currentTeam.name) {
                        console.error('Invalid team data:', currentTeam);
                        alert('Invalid team selection. Please try again.');
                        return;
                    }
                    
                    localStorage.setItem('selectedTeam', JSON.stringify(currentTeam));
                    document.getElementById('teamTitle').textContent = `Managing: ${currentTeam.name}`;
                    document.getElementById('noTeamWarning').classList.add('hidden');
                    
                    console.log('Loading players for selected team...');
                    await loadPlayers();
                    
                } else {
                    console.log('No team selected, clearing current team');
                    currentTeam = null;
                    localStorage.removeItem('selectedTeam');
                    document.getElementById('teamTitle').textContent = 'Select a team to manage players';
                    document.getElementById('noTeamWarning').classList.remove('hidden');
                    document.getElementById('playersContainer').innerHTML = '<p>Select a team to view players...</p>';
                }
            } catch (error) {
                console.error('Error in selectTeam:', error);
                alert('Error selecting team: ' + error.message);
            }
        }

        async function loadPlayers() {
            if (!currentTeam || !currentTeam.id) {
                console.log('Cannot load players - no current team or team ID');
                return;
            }

            try {
                console.log('Loading players for team:', currentTeam.id, currentTeam.name);
                const q = query(collection(db, "players"), where("teamId", "==", currentTeam.id));
                const querySnapshot = await getDocs(q);
                
                players = [];
                querySnapshot.forEach((doc) => {
                    players.push({ id: doc.id, ...doc.data() });
                });

                console.log(`Loaded ${players.length} players for team: ${currentTeam.name}`);
                displayPlayers();
            } catch (error) {
                console.error('Error loading players:', error);
                const container = document.getElementById('playersContainer');
                if (container) {
                    container.innerHTML = `<p style="color: red;">Error loading players: ${error.message}</p>`;
                }
            }
        }

        function displayPlayers() {
            const container = document.getElementById('playersContainer');
            
            if (players.length === 0) {
                container.innerHTML = '<p>No players added yet. Add your first player above!</p>';
                return;
            }

            container.innerHTML = '';
            
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-card';
                
                const injuryTag = player.injuries && player.injuries.length > 0 ? 
                    '<span class="injury-tag">‚ö†Ô∏è INJURED</span>' : '';
                
                playerDiv.innerHTML = `
                    <div class="player-header">
                        <div class="player-name">${player.name}${injuryTag}</div>
                        <div class="jersey-number">#${player.jerseyNumber || 'N/A'}</div>
                    </div>
                    <div class="player-details">
                        <div><strong>Position:</strong> ${player.position || 'N/A'}</div>
                        <div><strong>Phone:</strong> ${player.phone || 'N/A'}</div>
                        <div><strong>Email:</strong> ${player.email || 'N/A'}</div>
                        <div><strong>Emergency Contact:</strong> ${player.emergencyContact || 'N/A'}</div>
                    </div>
                    ${player.medicalInfo ? `<div><strong>Medical Info:</strong> ${player.medicalInfo}</div>` : ''}
                    <div style="margin-top: 15px;">
                        <button onclick="editPlayerStats('${player.id}')" class="btn-success">üìä Edit Stats</button>
                        <button onclick="addInjury('${player.id}')" class="btn-warning">ü©π Add Injury</button>
                        <button onclick="deletePlayer('${player.id}')" class="btn-danger">üóëÔ∏è Delete</button>
                    </div>
                `;
                container.appendChild(playerDiv);
            });
        }

        window.addPlayer = async function() {
            console.log('=== ADD PLAYER START ===');
            console.log('Current Team:', currentTeam);
            console.log('Current League:', currentLeague);
            
            // Comprehensive validation
            if (!currentLeague) {
                console.error('No current league found');
                alert('No league selected. Please refresh the page and select a league first.');
                window.location.href = 'index.html';
                return;
            }
            
            if (!currentLeague.id || !currentLeague.name) {
                console.error('Invalid league data:', currentLeague);
                alert('Invalid league data. Please refresh and select a league again.');
                localStorage.removeItem('currentLeague');
                window.location.href = 'index.html';
                return;
            }
            
            if (!currentTeam) {
                console.error('No current team found');
                alert('Please select a team first using the dropdown above.');
                return;
            }
            
            if (!currentTeam.id || !currentTeam.name) {
                console.error('Invalid team data:', currentTeam);
                alert('Invalid team selection. Please select a team again from the dropdown.');
                currentTeam = null;
                localStorage.removeItem('selectedTeam');
                return;
            }
            
            console.log('Validation passed - League:', currentLeague.name, 'Team:', currentTeam.name);

            const name = document.getElementById('playerName').value.trim();
            const jerseyNumber = document.getElementById('jerseyNumber').value;
            const position = document.getElementById('position').value.trim();
            const phone = document.getElementById('playerPhone').value.trim();
            const email = document.getElementById('playerEmail').value.trim();
            const emergencyContact = document.getElementById('emergencyContact').value.trim();
            const medicalInfo = document.getElementById('medicalInfo').value.trim();
            const files = document.getElementById('playerDocuments').files;

            if (!name) {
                alert('Player name is required');
                return;
            }

            try {
                console.log('Attempting to add player with teamId:', currentTeam.id, 'and leagueId:', currentLeague.id);
                
                // Upload documents if any
                const documentUrls = [];
                for (let file of files) {
                    const storageRef = ref(storage, `players/${currentTeam.id}/${name}/${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    documentUrls.push({ name: file.name, url: downloadURL });
                }

                const playerData = {
                    name: name,
                    jerseyNumber: jerseyNumber,
                    position: position,
                    phone: phone,
                    email: email,
                    emergencyContact: emergencyContact,
                    medicalInfo: medicalInfo,
                    teamId: currentTeam.id,
                    teamName: currentTeam.name,
                    leagueId: currentLeague.id,
                    leagueName: currentLeague.name,
                    documents: documentUrls,
                    stats: {
                        gamesPlayed: 0,
                        points: 0,
                        assists: 0,
                        rebounds: 0,
                        steals: 0,
                        blocks: 0
                    },
                    injuries: [],
                    createdAt: new Date()
                };

                console.log('Player data to be added:', playerData);

                const docRef = await addDoc(collection(db, "players"), playerData);
                console.log('Player added successfully with ID:', docRef.id);

                // Clear form
                document.getElementById('playerName').value = '';
                document.getElementById('jerseyNumber').value = '';
                document.getElementById('position').value = '';
                document.getElementById('playerPhone').value = '';
                document.getElementById('playerEmail').value = '';
                document.getElementById('emergencyContact').value = '';
                document.getElementById('medicalInfo').value = '';
                document.getElementById('playerDocuments').value = '';

                alert('Player added successfully!');
                loadPlayers();
            } catch (error) {
                alert('Error adding player: ' + error.message);
            }
        }

        window.editPlayerStats = function(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            currentPlayer = player;
            document.getElementById('statsPlayerName').textContent = `${player.name} - Statistics`;
            
            const stats = player.stats || {};
            document.getElementById('statsContent').innerHTML = `
                <div style="background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h3>Game Statistics</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label>Games Played:</label>
                            <input type="number" id="gamesPlayed" value="${stats.gamesPlayed || 0}">
                        </div>
                        <div>
                            <label>Points:</label>
                            <input type="number" id="points" value="${stats.points || 0}">
                        </div>
                        <div>
                            <label>Assists:</label>
                            <input type="number" id="assists" value="${stats.assists || 0}">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div>
                            <label>Rebounds:</label>
                            <input type="number" id="rebounds" value="${stats.rebounds || 0}">
                        </div>
                        <div>
                            <label>Steals:</label>
                            <input type="number" id="steals" value="${stats.steals || 0}">
                        </div>
                        <div>
                            <label>Blocks:</label>
                            <input type="number" id="blocks" value="${stats.blocks || 0}">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statsModal').classList.remove('hidden');
        }

        window.savePlayerStats = async function() {
            if (!currentPlayer) return;

            const stats = {
                gamesPlayed: parseInt(document.getElementById('gamesPlayed').value) || 0,
                points: parseInt(document.getElementById('points').value) || 0,
                assists: parseInt(document.getElementById('assists').value) || 0,
                rebounds: parseInt(document.getElementById('rebounds').value) || 0,
                steals: parseInt(document.getElementById('steals').value) || 0,
                blocks: parseInt(document.getElementById('blocks').value) || 0
            };

            try {
                await updateDoc(doc(db, "players", currentPlayer.id), { stats: stats });
                alert('Stats updated successfully!');
                closeStatsModal();
                loadPlayers();
            } catch (error) {
                alert('Error updating stats: ' + error.message);
            }
        }

        window.closeStatsModal = function() {
            document.getElementById('statsModal').classList.add('hidden');
            currentPlayer = null;
        }

        window.addInjury = async function(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            const injury = prompt('Enter injury description:');
            if (!injury) return;

            const injuries = player.injuries || [];
            injuries.push({
                description: injury,
                date: new Date().toLocaleDateString(),
                status: 'active'
            });

            try {
                await updateDoc(doc(db, "players", playerId), { injuries: injuries });
                alert('Injury added');
                loadPlayers();
            } catch (error) {
                alert('Error adding injury: ' + error.message);
            }
        }

        window.deletePlayer = async function(playerId) {
            if (!confirm('Are you sure you want to delete this player? This action cannot be undone.')) return;

            try {
                await deleteDoc(doc(db, "players", playerId));
                alert('Player deleted successfully');
                loadPlayers();
            } catch (error) {
                alert('Error deleting player: ' + error.message);
            }
        }
    </script>
</body>
</html>