<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roster Management - Sports Team Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .league-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #eee;
            border-radius: 10px;
            background: #f9f9f9;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #27ae60;
        }
        
        button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .player-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .player-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .jersey-number {
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .player-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .navigation {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .nav-button {
            margin: 0 10px;
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
        }
        
        .team-selector {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .hidden {
            display: none;
        }
        
        .injury-tag {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .file-upload {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .player-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="league-info" id="leagueInfo">Loading...</div>
            <h1>üë• Roster Management</h1>
            <p id="teamTitle">Select a team to manage players</p>
        </div>
        
        <div class="content">
            <!-- Team Selection -->
            <div class="team-selector">
                <h2>üìã Select Team</h2>
                <div class="form-row">
                    <div>
                        <label for="teamSelect">Choose Team:</label>
                        <select id="teamSelect" onchange="selectTeam()">
                            <option value="">Select a team...</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: end; gap: 10px;">
                        <button onclick="refreshTeams()" class="btn-success">üîÑ Refresh Teams</button>
                        <button onclick="debugTeamInfo()" class="btn-warning">üîç Debug Info</button>
                    </div>
                </div>
            </div>
            
            <!-- Add New Player Section -->
            <div class="section" id="addPlayerSection">
                <h2>‚ûï Add New Player</h2>
                <div id="noTeamWarning" class="warning-message">
                    ‚ö†Ô∏è Please select a team first before adding players.
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="playerName">Player Name:</label>
                        <input type="text" id="playerName" placeholder="Full name">
                    </div>
                    <div class="form-group">
                        <label for="jerseyNumber">Jersey Number:</label>
                        <input type="number" id="jerseyNumber" placeholder="##">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="position">Position:</label>
                        <input type="text" id="position" placeholder="e.g., Point Guard, Forward">
                    </div>
                    <div class="form-group">
                        <label for="playerPhone">Phone:</label>
                        <input type="tel" id="playerPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="playerEmail">Email:</label>
                        <input type="email" id="playerEmail" placeholder="Email address">
                    </div>
                    <div class="form-group">
                        <label for="emergencyContact">Emergency Contact:</label>
                        <input type="text" id="emergencyContact" placeholder="Name and phone">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="medicalInfo">Medical Information:</label>
                    <textarea id="medicalInfo" rows="2" placeholder="Allergies, conditions, medications, etc."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Upload Documents:</label>
                    <div class="file-upload">
                        <input type="file" id="playerDocuments" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        <p>Upload medical forms, waivers, photos, etc.</p>
                    </div>
                </div>
                
                <button onclick="addPlayer()" class="btn-success">Add Player</button>
            </div>
            
            <!-- Players List -->
            <div class="section" id="playersSection">
                <h2>üë§ Team Roster</h2>
                <div id="playersContainer">
                    <p>Select a team to view players...</p>
                </div>
            </div>
            
            <!-- Player Stats Modal -->
            <div id="statsModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 id="statsPlayerName">Player Statistics</h2>
                    <div id="statsContent"></div>
                    <button onclick="closeStatsModal()" class="btn-danger">Close</button>
                    <button onclick="savePlayerStats()" class="btn-success">Save Stats</button>
                </div>
            </div>
            
            <div class="navigation">
                <button class="nav-button" onclick="window.location.href='index.html'">üè† Back to League</button>
                <button class="nav-button" onclick="window.location.href='tournament.html'">üèÜ Tournaments</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCeZVcMrPv1-RNmRvJwJR2SdPrNYZ2YLs",
            authDomain: "team-manager-51b49.firebaseapp.com",
            projectId: "team-manager-51b49",
            storageBucket: "team-manager-51b49.firebasestorage.app",
            messagingSenderId: "811968699332",
            appId: "1:811968699332:web:2e2af08d88e6b8a70c2291"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentLeague = null;
        let currentTeam = null;
        let currentPlayer = null;
        let players = [];

        // Load saved data on page load
        window.addEventListener('load', function() {
            const savedLeague = localStorage.getItem('currentLeague');
            const savedTeam = localStorage.getItem('selectedTeam');
            
            console.log('Page loaded - Saved league:', savedLeague);
            console.log('Page loaded - Saved team:', savedTeam);
            
            if (!savedLeague) {
                alert('Please select a league first');
                window.location.href = 'index.html';
                return;
            }
            
            try {
                currentLeague = JSON.parse(savedLeague);
                console.log('Parsed current league:', currentLeague);
                document.getElementById('leagueInfo').textContent = `League: ${currentLeague.name}`;
                
                if (savedTeam) {
                    currentTeam = JSON.parse(savedTeam);
                    console.log('Parsed current team:', currentTeam);
                    document.getElementById('teamTitle').textContent = `Managing: ${currentTeam.name}`;
                }
                
                loadTeams().then(() => {
                    if (currentTeam && currentTeam.id) {
                        document.getElementById('teamSelect').value = currentTeam.id;
                        document.getElementById('noTeamWarning').classList.add('hidden');
                        loadPlayers();
                    } else {
                        console.log('No valid team selected, showing warning');
                        document.getElementById('noTeamWarning').classList.remove('hidden');
                    }
                }).catch(error => {
                    console.error('Error in loadTeams:', error);
                    alert('Error loading teams: ' + error.message);
                });
                
            } catch (error) {
                console.error('Error parsing saved data:', error);
                alert('Error loading saved data. Please start over.');
                localStorage.removeItem('currentLeague');
                localStorage.removeItem('selectedTeam');
                window.location.href = 'index.html';
            }
        });

        async function loadTeams() {
            if (!currentLeague) {
                console.log('No current league found');
                return;
            }

            try {
                console.log('Loading teams for league:', currentLeague.id);
                const q = query(collection(db, "teams"), where("leagueId", "==", currentLeague.id));
                const querySnapshot = await getDocs(q);
                
                const select = document.getElementById('teamSelect');
                select.innerHTML = '<option value="">Select a team...</option>';

                let teamCount = 0;
                querySnapshot.forEach((doc) => {
                    const team = doc.data();
                    console.log('Found team:', doc.id, team);
                    
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${team.teamName || team.name} (Coach: ${team.coachName})`;
                    option.dataset.teamName = team.teamName || team.name;
                    select.appendChild(option);
                    teamCount++;
                });

                console.log(`Loaded ${teamCount} teams`);
                
                if (teamCount === 0) {
                    const noTeamsOption = document.createElement('option');
                    noTeamsOption.value = "";
                    noTeamsOption.textContent = "No teams found - create one first";
                    noTeamsOption.disabled = true;
                    select.appendChild(noTeamsOption);
                }

            } catch (error) {
                console.error('Error loading teams:', error);
                alert('Error loading teams: ' + error.message);
            }
        }

        window.refreshTeams = async function() {
            await loadTeams();
        }

        window.debugTeamInfo = function() {
            console.log('=== DEBUG INFO ===');
            console.log('Current League:', currentLeague);
            console.log('Current Team:', currentTeam);
            console.log('LocalStorage - currentLeague:', localStorage.getItem('currentLeague'));
            console.log('LocalStorage - selectedTeam:', localStorage.getItem('selectedTeam'));
            
            const select = document.getElementById('teamSelect');
            console.log('Team select value:', select.value);
            console.log('Team select options:', Array.from(select.options).map(opt => ({value: opt.value, text: opt.textContent, dataset: opt.dataset})));
            
            alert(`Debug Info (check console for details):
            
League: ${currentLeague ? currentLeague.name : 'NULL'}
Team: ${currentTeam ? currentTeam.name + ' (ID: ' + currentTeam.id + ')' : 'NULL'}
Select Value: ${select.value}
            `);
        }

        window.selectTeam = function() {
            const select = document.getElementById('teamSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            console.log('Team selection changed:', select.value);
            console.log('Selected option:', selectedOption);
            
            if (select.value) {
                currentTeam = {
                    id: select.value,
                    name: selectedOption.dataset.teamName || selectedOption.textContent
                };
                
                console.log('Setting currentTeam to:', currentTeam);
                localStorage.setItem('selectedTeam', JSON.stringify(currentTeam));
                document.getElementById('teamTitle').textContent = `Managing: ${currentTeam.name}`;
                document.getElementById('noTeamWarning').classList.add('hidden');
                loadPlayers();
            } else {
                currentTeam = null;
                localStorage.removeItem('selectedTeam');
                document.getElementById('teamTitle').textContent = 'Select a team to manage players';
                document.getElementById('noTeamWarning').classList.remove('hidden');
                document.getElementById('playersContainer').innerHTML = '<p>Select a team to view players...</p>';
            }
        }

        async function loadPlayers() {
            if (!currentTeam) return;

            try {
                const q = query(collection(db, "players"), where("teamId", "==", currentTeam.id));
                const querySnapshot = await getDocs(q);
                
                players = [];
                querySnapshot.forEach((doc) => {
                    players.push({ id: doc.id, ...doc.data() });
                });

                displayPlayers();
            } catch (error) {
                console.error('Error loading players:', error);
            }
        }

        function displayPlayers() {
            const container = document.getElementById('playersContainer');
            
            if (players.length === 0) {
                container.innerHTML = '<p>No players added yet. Add your first player above!</p>';
                return;
            }

            container.innerHTML = '';
            
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-card';
                
                const injuryTag = player.injuries && player.injuries.length > 0 ? 
                    '<span class="injury-tag">‚ö†Ô∏è INJURED</span>' : '';
                
                playerDiv.innerHTML = `
                    <div class="player-header">
                        <div class="player-name">${player.name}${injuryTag}</div>
                        <div class="jersey-number">#${player.jerseyNumber || 'N/A'}</div>
                    </div>
                    <div class="player-details">
                        <div><strong>Position:</strong> ${player.position || 'N/A'}</div>
                        <div><strong>Phone:</strong> ${player.phone || 'N/A'}</div>
                        <div><strong>Email:</strong> ${player.email || 'N/A'}</div>
                        <div><strong>Emergency Contact:</strong> ${player.emergencyContact || 'N/A'}</div>
                    </div>
                    ${player.medicalInfo ? `<div><strong>Medical Info:</strong> ${player.medicalInfo}</div>` : ''}
                    <div style="margin-top: 15px;">
                        <button onclick="editPlayerStats('${player.id}')" class="btn-success">üìä Edit Stats</button>
                        <button onclick="addInjury('${player.id}')" class="btn-warning">ü©π Add Injury</button>
                        <button onclick="deletePlayer('${player.id}')" class="btn-danger">üóëÔ∏è Delete</button>
                    </div>
                `;
                container.appendChild(playerDiv);
            });
        }

        window.addPlayer = async function() {
            // Debug current team state
            console.log('Current Team:', currentTeam);
            console.log('Current League:', currentLeague);
            
            if (!currentTeam || !currentTeam.id) {
                alert('Please select a team first. Current team: ' + (currentTeam ? JSON.stringify(currentTeam) : 'null'));
                return;
            }

            if (!currentLeague || !currentLeague.id) {
                alert('No league selected. Please go back and select a league.');
                return;
            }

            const name = document.getElementById('playerName').value.trim();
            const jerseyNumber = document.getElementById('jerseyNumber').value;
            const position = document.getElementById('position').value.trim();
            const phone = document.getElementById('playerPhone').value.trim();
            const email = document.getElementById('playerEmail').value.trim();
            const emergencyContact = document.getElementById('emergencyContact').value.trim();
            const medicalInfo = document.getElementById('medicalInfo').value.trim();
            const files = document.getElementById('playerDocuments').files;

            if (!name) {
                alert('Player name is required');
                return;
            }

            try {
                console.log('Attempting to add player with teamId:', currentTeam.id, 'and leagueId:', currentLeague.id);
                
                // Upload documents if any
                const documentUrls = [];
                for (let file of files) {
                    const storageRef = ref(storage, `players/${currentTeam.id}/${name}/${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    documentUrls.push({ name: file.name, url: downloadURL });
                }

                const playerData = {
                    name: name,
                    jerseyNumber: jerseyNumber,
                    position: position,
                    phone: phone,
                    email: email,
                    emergencyContact: emergencyContact,
                    medicalInfo: medicalInfo,
                    teamId: currentTeam.id,
                    teamName: currentTeam.name,
                    leagueId: currentLeague.id,
                    leagueName: currentLeague.name,
                    documents: documentUrls,
                    stats: {
                        gamesPlayed: 0,
                        points: 0,
                        assists: 0,
                        rebounds: 0,
                        steals: 0,
                        blocks: 0
                    },
                    injuries: [],
                    createdAt: new Date()
                };

                console.log('Player data to be added:', playerData);

                const docRef = await addDoc(collection(db, "players"), playerData);
                console.log('Player added successfully with ID:', docRef.id);

                // Clear form
                document.getElementById('playerName').value = '';
                document.getElementById('jerseyNumber').value = '';
                document.getElementById('position').value = '';
                document.getElementById('playerPhone').value = '';
                document.getElementById('playerEmail').value = '';
                document.getElementById('emergencyContact').value = '';
                document.getElementById('medicalInfo').value = '';
                document.getElementById('playerDocuments').value = '';

                alert('Player added successfully!');
                loadPlayers();
            } catch (error) {
                alert('Error adding player: ' + error.message);
            }
        }

        window.editPlayerStats = function(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            currentPlayer = player;
            document.getElementById('statsPlayerName').textContent = `${player.name} - Statistics`;
            
            const stats = player.stats || {};
            document.getElementById('statsContent').innerHTML = `
                <div style="background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h3>Game Statistics</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label>Games Played:</label>
                            <input type="number" id="gamesPlayed" value="${stats.gamesPlayed || 0}">
                        </div>
                        <div>
                            <label>Points:</label>
                            <input type="number" id="points" value="${stats.points || 0}">
                        </div>
                        <div>
                            <label>Assists:</label>
                            <input type="number" id="assists" value="${stats.assists || 0}">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div>
                            <label>Rebounds:</label>
                            <input type="number" id="rebounds" value="${stats.rebounds || 0}">
                        </div>
                        <div>
                            <label>Steals:</label>
                            <input type="number" id="steals" value="${stats.steals || 0}">
                        </div>
                        <div>
                            <label>Blocks:</label>
                            <input type="number" id="blocks" value="${stats.blocks || 0}">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statsModal').classList.remove('hidden');
        }

        window.savePlayerStats = async function() {
            if (!currentPlayer) return;

            const stats = {
                gamesPlayed: parseInt(document.getElementById('gamesPlayed').value) || 0,
                points: parseInt(document.getElementById('points').value) || 0,
                assists: parseInt(document.getElementById('assists').value) || 0,
                rebounds: parseInt(document.getElementById('rebounds').value) || 0,
                steals: parseInt(document.getElementById('steals').value) || 0,
                blocks: parseInt(document.getElementById('blocks').value) || 0
            };

            try {
                await updateDoc(doc(db, "players", currentPlayer.id), { stats: stats });
                alert('Stats updated successfully!');
                closeStatsModal();
                loadPlayers();
            } catch (error) {
                alert('Error updating stats: ' + error.message);
            }
        }

        window.closeStatsModal = function() {
            document.getElementById('statsModal').classList.add('hidden');
            currentPlayer = null;
        }

        window.addInjury = async function(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            const injury = prompt('Enter injury description:');
            if (!injury) return;

            const injuries = player.injuries || [];
            injuries.push({
                description: injury,
                date: new Date().toLocaleDateString(),
                status: 'active'
            });

            try {
                await updateDoc(doc(db, "players", playerId), { injuries: injuries });
                alert('Injury added');
                loadPlayers();
            } catch (error) {
                alert('Error adding injury: ' + error.message);
            }
        }

        window.deletePlayer = async function(playerId) {
            if (!confirm('Are you sure you want to delete this player? This action cannot be undone.')) return;

            try {
                await deleteDoc(doc(db, "players", playerId));
                alert('Player deleted successfully');
                loadPlayers();
            } catch (error) {
                alert('Error deleting player: ' + error.message);
            }
        }
    </script>
</body>
</html>