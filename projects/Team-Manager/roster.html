<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roster Management - Sports Team Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .league-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #eee;
            border-radius: 10px;
            background: #f9f9f9;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #27ae60;
        }
        
        button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .player-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .player-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .jersey-number {
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .player-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .navigation {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .nav-button {
            margin: 0 10px;
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
        }
        
        .team-selector {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .hidden {
            display: none;
        }
        
        .injury-tag {
            background: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .file-upload {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .warning-message {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #ffeaa7;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .player-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="league-info" id="leagueInfo">Loading...</div>
            <h1>üë• Roster Management</h1>
            <p id="teamTitle">Select a team to manage players</p>
        </div>
        
        <div class="content">
            <!-- Team Selection -->
            <div class="team-selector">
                <h2>üìã Select Team</h2>
                <div class="form-row">
                    <div>
                        <label for="teamSelect">Choose Team:</label>
                        <select id="teamSelect" onchange="selectTeam()">
                            <option value="">Select a team...</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button onclick="emergencySync()" class="btn-success">ÔøΩ Refresh</button>
                    </div>
                </div>
            </div>
            
            <!-- Add New Player Section -->
            <div class="section" id="addPlayerSection">
                <h2>‚ûï Add New Player</h2>
                <div id="noTeamWarning" class="warning-message">
                    ‚ö†Ô∏è Please select a team first before adding players.
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="playerName">Player Name:</label>
                        <input type="text" id="playerName" placeholder="Full name">
                    </div>
                    <div class="form-group">
                        <label for="jerseyNumber">Jersey Number:</label>
                        <input type="number" id="jerseyNumber" placeholder="##">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="position">Position:</label>
                        <input type="text" id="position" placeholder="e.g., Point Guard, Forward">
                    </div>
                    <div class="form-group">
                        <label for="playerPhone">Phone:</label>
                        <input type="tel" id="playerPhone" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="playerEmail">Email:</label>
                        <input type="email" id="playerEmail" placeholder="Email address">
                    </div>
                    <div class="form-group">
                        <label for="emergencyContact">Emergency Contact:</label>
                        <input type="text" id="emergencyContact" placeholder="Name and phone">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="medicalInfo">Medical Information:</label>
                    <textarea id="medicalInfo" rows="2" placeholder="Allergies, conditions, medications, etc."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Upload Documents:</label>
                    <div class="file-upload">
                        <input type="file" id="playerDocuments" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                        <p>Upload medical forms, waivers, photos, etc.</p>
                    </div>
                </div>
                
                <button onclick="addPlayer()" class="btn-success">Add Player</button>
            </div>
            
            <!-- Players List -->
            <div class="section" id="playersSection">
                <h2>üë§ Team Roster</h2>
                <div id="playersContainer">
                    <p>Select a team to view players...</p>
                </div>
            </div>
            
            <!-- Player Stats Modal -->
            <div id="statsModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 id="statsPlayerName">Player Statistics</h2>
                    <div id="statsContent"></div>
                    <button onclick="closeStatsModal()" class="btn-danger">Close</button>
                    <button onclick="savePlayerStats()" class="btn-success">Save Stats</button>
                </div>
            </div>
            
            <!-- Edit Player Modal -->
            <div id="editPlayerModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 id="editPlayerName">Edit Player Information</h2>
                    <div id="editPlayerContent">
                        <div class="form-row">
                            <div>
                                <label for="editPlayerNameInput">Player Name:</label>
                                <input type="text" id="editPlayerNameInput" placeholder="Full name">
                            </div>
                            <div>
                                <label for="editJerseyNumber">Jersey Number:</label>
                                <input type="number" id="editJerseyNumber" placeholder="##">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label for="editPosition">Position:</label>
                                <input type="text" id="editPosition" placeholder="e.g., Point Guard, Forward">
                            </div>
                            <div>
                                <label for="editPlayerPhone">Phone:</label>
                                <input type="tel" id="editPlayerPhone" placeholder="Phone number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editPlayerEmail">Email:</label>
                            <input type="email" id="editPlayerEmail" placeholder="Email address">
                        </div>
                        <div class="form-group">
                            <label for="editEmergencyContact">Emergency Contact:</label>
                            <input type="text" id="editEmergencyContact" placeholder="Name and phone">
                        </div>
                        <div class="form-group">
                            <label for="editMedicalInfo">Medical Information:</label>
                            <textarea id="editMedicalInfo" rows="3" placeholder="Allergies, conditions, medications, etc."></textarea>
                        </div>
                    </div>
                    <button onclick="closeEditPlayerModal()" class="btn-danger">Cancel</button>
                    <button onclick="savePlayerEdit()" class="btn-success">Save Changes</button>
                </div>
            </div>
            
            <div class="navigation">
                <button class="nav-button" onclick="window.location.href='index.html'">üè† Back to League</button>
                <button class="nav-button" onclick="window.location.href='tournament.html'">üèÜ Tournaments</button>
                <button onclick="emergencySync()" class="btn-success">üîÑ Refresh</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBCeZVcMrPv1-RNmRvJwJR2SdPrNYZ2YLs",
            authDomain: "team-manager-51b49.firebaseapp.com",
            projectId: "team-manager-51b49",
            storageBucket: "team-manager-51b49.firebasestorage.app",
            messagingSenderId: "811968699332",
            appId: "1:811968699332:web:2e2af08d88e6b8a70c2291"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentLeague = null;
        let currentTeam = null;
        let currentPlayer = null;
        let players = [];
        let sessionId = null;

        // Database-driven initialization
        window.addEventListener('load', async function() {
            console.log('=== DATABASE-DRIVEN PAGE LOAD START ===');
            
            try {
                await initializeFromDatabase();
            } catch (error) {
                console.error('Database initialization failed:', error);
                alert('Failed to load data. Redirecting to main page.');
                window.location.href = 'index.html';
            }
        });

        async function initializeFromDatabase() {
            console.log('üéØ Starting database-driven initialization');
            
            // Try multiple methods to get league/team info
            let leagueId = null;
            let teamId = null;
            
            // Method 1: URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            leagueId = urlParams.get('league');
            teamId = urlParams.get('team');
            
            console.log('URL params - league:', leagueId, 'team:', teamId);
            
            // Method 2: Session storage (more reliable than localStorage)
            if (!leagueId) {
                leagueId = sessionStorage.getItem('currentLeagueId');
                console.log('Session storage league:', leagueId);
            }
            
            if (!teamId) {
                teamId = sessionStorage.getItem('currentTeamId');
                console.log('Session storage team:', teamId);
            }
            
            // Method 3: Fallback to localStorage
            if (!leagueId) {
                const savedLeague = localStorage.getItem('currentLeague');
                if (savedLeague) {
                    try {
                        const parsed = JSON.parse(savedLeague);
                        leagueId = parsed.id;
                        console.log('localStorage fallback league:', leagueId);
                    } catch (e) {
                        console.error('localStorage parse error:', e);
                    }
                }
            }
            
            if (!teamId) {
                const savedTeam = localStorage.getItem('selectedTeam');
                if (savedTeam) {
                    try {
                        const parsed = JSON.parse(savedTeam);
                        teamId = parsed.id;
                        console.log('localStorage fallback team:', teamId);
                    } catch (e) {
                        console.error('localStorage team parse error:', e);
                    }
                }
            }
            
            if (!leagueId) {
                console.error('‚ùå No league ID found anywhere');
                alert('No league selected. Please start from the main page.');
                window.location.href = 'index.html';
                return;
            }
            
            console.log('‚úÖ Found league ID:', leagueId);
            
            // Load league data from database
            await loadLeagueFromDatabase(leagueId);
            
            // Load team data if available
            if (teamId) {
                await loadTeamFromDatabase(teamId);
            }
            
            // Load teams and set up UI
            await loadTeams();
            
            // Load players if team is selected
            if (currentTeam) {
                await loadPlayers();
            }
            
            console.log('‚úÖ Database initialization complete');
            console.log('League:', currentLeague?.name, 'Team:', currentTeam?.name);
        }

        async function loadLeagueFromDatabase(leagueId) {
            console.log('üèÜ Loading league from database:', leagueId);
            
            try {
                const docRef = doc(db, "leagues", leagueId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    currentLeague = { id: docSnap.id, ...docSnap.data() };
                    
                    // Store in session for reliability
                    sessionStorage.setItem('currentLeagueId', leagueId);
                    sessionStorage.setItem('currentLeague', JSON.stringify(currentLeague));
                    
                    // Update UI
                    document.getElementById('leagueInfo').textContent = `League: ${currentLeague.name}`;
                    
                    console.log('‚úÖ League loaded successfully:', currentLeague.name);
                } else {
                    throw new Error('League not found in database');
                }
            } catch (error) {
                console.error('‚ùå Failed to load league:', error);
                throw error;
            }
        }

        async function loadTeamFromDatabase(teamId) {
            console.log('üë• Loading team from database:', teamId);
            
            try {
                const docRef = doc(db, "teams", teamId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const teamData = docSnap.data();
                    currentTeam = { 
                        id: docSnap.id, 
                        name: teamData.teamName || teamData.name,
                        coachName: teamData.coachName,
                        ...teamData
                    };
                    
                    // Store in session
                    sessionStorage.setItem('currentTeamId', teamId);
                    sessionStorage.setItem('currentTeam', JSON.stringify(currentTeam));
                    
                    // Update UI
                    document.getElementById('teamTitle').textContent = `Managing: ${currentTeam.name}`;
                    document.getElementById('noTeamWarning').classList.add('hidden');
                    
                    console.log('‚úÖ Team loaded successfully:', currentTeam.name);
                } else {
                    console.warn('‚ö†Ô∏è Team not found in database:', teamId);
                    // Don't throw error, just clear team selection
                    currentTeam = null;
                    sessionStorage.removeItem('currentTeamId');
                    sessionStorage.removeItem('currentTeam');
                }
            } catch (error) {
                console.error('‚ùå Failed to load team:', error);
                // Don't throw error, just clear team selection
                currentTeam = null;
            }
        }

        // Keep the old function for the reinitializePage call, but make it use new system
        async function initializePage() {
            console.log('üîÑ Using legacy initialization wrapper');
            await initializeFromDatabase();
        }

        async function loadTeams() {
            if (!currentLeague || !currentLeague.id) {
                console.error('Cannot load teams - no current league or league ID');
                throw new Error('No current league available');
            }

            try {
                console.log('Loading teams for league ID:', currentLeague.id);
                const q = query(collection(db, "teams"), where("leagueId", "==", currentLeague.id));
                const querySnapshot = await getDocs(q);
                
                const select = document.getElementById('teamSelect');
                if (!select) {
                    throw new Error('Team select element not found');
                }
                
                select.innerHTML = '<option value="">Select a team...</option>';

                let teamCount = 0;
                const teams = [];
                
                querySnapshot.forEach((doc) => {
                    const team = doc.data();
                    teams.push({ id: doc.id, ...team });
                    console.log('Found team:', doc.id, team);
                    
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${team.teamName || team.name} (Coach: ${team.coachName})`;
                    option.dataset.teamName = team.teamName || team.name;
                    option.dataset.coachName = team.coachName;
                    select.appendChild(option);
                    teamCount++;
                });

                console.log(`Successfully loaded ${teamCount} teams for league: ${currentLeague.name}`);
                
                if (teamCount === 0) {
                    console.warn('No teams found for league');
                    const noTeamsOption = document.createElement('option');
                    noTeamsOption.value = "";
                    noTeamsOption.textContent = "No teams found - create one first";
                    noTeamsOption.disabled = true;
                    select.appendChild(noTeamsOption);
                    
                    // Show message to user
                    const container = document.getElementById('playersContainer');
                    if (container) {
                        container.innerHTML = '<p style="color: #e67e22; font-weight: bold;">No teams found in this league. Please go back to the main page and create a team first.</p>';
                    }
                }

                return teams;

            } catch (error) {
                console.error('Error loading teams:', error);
                const select = document.getElementById('teamSelect');
                if (select) {
                    select.innerHTML = '<option value="">Error loading teams</option>';
                }
                throw new Error(`Failed to load teams: ${error.message}`);
            }
        }

        // Refresh teams - now points to emergency sync for a clean user experience
        window.refreshTeams = async function() {
            await emergencySync();
        }

        // Refresh data from localStorage - reliable data sync
        window.emergencySync = async function() {
            console.log('ÔøΩ Refreshing data from localStorage');
            
            try {
                // Get from localStorage and set variables directly
                const rawLeague = localStorage.getItem('currentLeague');
                const rawTeam = localStorage.getItem('selectedTeam');
                
                if (rawLeague) {
                    const parsed = JSON.parse(rawLeague);
                    currentLeague = {
                        id: parsed.id,
                        name: parsed.name,
                        creatorName: parsed.creatorName,
                        sport: parsed.sport,
                        password: parsed.password,
                        description: parsed.description
                    };
                    console.log('‚úÖ Emergency league sync:', currentLeague.name);
                    
                    // Update UI
                    document.getElementById('leagueInfo').textContent = `League: ${currentLeague.name}`;
                }
                
                if (rawTeam) {
                    const parsed = JSON.parse(rawTeam);
                    currentTeam = {
                        id: parsed.id,
                        name: parsed.name,
                        coachName: parsed.coachName || 'Unknown'
                    };
                    console.log('‚úÖ Emergency team sync:', currentTeam.name);
                    
                    // Update UI
                    document.getElementById('teamTitle').textContent = `Managing: ${currentTeam.name}`;
                    document.getElementById('noTeamWarning').classList.add('hidden');
                }
                
                // Now load teams and players
                if (currentLeague) {
                    await loadTeams();
                    
                    if (currentTeam) {
                        // Set team select
                        const select = document.getElementById('teamSelect');
                        if (select) {
                            select.value = currentTeam.id;
                        }
                        
                        await loadPlayers();
                    }
                }
                
                console.log(`‚úÖ Refresh complete - League: ${currentLeague?.name}, Team: ${currentTeam?.name}`);
                
            } catch (error) {
                console.error('‚ùå Refresh failed:', error);
                alert('Failed to refresh data: ' + error.message);
            }
        }



        window.selectTeam = async function() {
            try {
                const select = document.getElementById('teamSelect');
                
                if (select.value) {
                    console.log('üéØ Team selected, loading from database:', select.value);
                    
                    // Load team directly from database
                    await loadTeamFromDatabase(select.value);
                    
                    if (currentTeam) {
                        // Update dropdown to reflect loaded team
                        const selectedOption = select.options[select.selectedIndex];
                        
                        // Update UI
                        document.getElementById('teamTitle').textContent = `Managing: ${currentTeam.name}`;
                        document.getElementById('noTeamWarning').classList.add('hidden');
                        
                        // Load players
                        await loadPlayers();
                        
                        console.log('‚úÖ Team selection complete:', currentTeam.name);
                    } else {
                        alert('Failed to load team data. Please try again.');
                    }
                    
                } else {
                    console.log('üîÑ Clearing team selection');
                    currentTeam = null;
                    sessionStorage.removeItem('currentTeamId');
                    sessionStorage.removeItem('currentTeam');
                    localStorage.removeItem('selectedTeam');
                    
                    document.getElementById('teamTitle').textContent = 'Select a team to manage players';
                    document.getElementById('noTeamWarning').classList.remove('hidden');
                    document.getElementById('playersContainer').innerHTML = '<p>Select a team to view players...</p>';
                }
            } catch (error) {
                console.error('Error in selectTeam:', error);
                alert('Error selecting team: ' + error.message);
            }
        }

        async function loadPlayers() {
            if (!currentTeam || !currentTeam.id) {
                console.log('Cannot load players - no current team or team ID');
                return;
            }

            try {
                console.log('Loading players for team:', currentTeam.id, currentTeam.name);
                const q = query(collection(db, "players"), where("teamId", "==", currentTeam.id));
                const querySnapshot = await getDocs(q);
                
                players = [];
                querySnapshot.forEach((doc) => {
                    players.push({ id: doc.id, ...doc.data() });
                });

                console.log(`Loaded ${players.length} players for team: ${currentTeam.name}`);
                displayPlayers();
            } catch (error) {
                console.error('Error loading players:', error);
                const container = document.getElementById('playersContainer');
                if (container) {
                    container.innerHTML = `<p style="color: red;">Error loading players: ${error.message}</p>`;
                }
            }
        }

        function displayPlayers() {
            const container = document.getElementById('playersContainer');
            
            if (players.length === 0) {
                container.innerHTML = '<p>No players added yet. Add your first player above!</p>';
                return;
            }

            container.innerHTML = '';
            
            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-card';
                
                const injuryTag = player.injuries && player.injuries.length > 0 ? 
                    '<span class="injury-tag">‚ö†Ô∏è INJURED</span>' : '';
                
                playerDiv.innerHTML = `
                    <div class="player-header">
                        <div class="player-name">${player.name}${injuryTag}</div>
                        <div class="jersey-number">#${player.jerseyNumber || 'N/A'}</div>
                    </div>
                    <div class="player-details">
                        <div><strong>Position:</strong> ${player.position || 'N/A'}</div>
                        <div><strong>Phone:</strong> ${player.phone || 'N/A'}</div>
                        <div><strong>Email:</strong> ${player.email || 'N/A'}</div>
                        <div><strong>Emergency Contact:</strong> ${player.emergencyContact || 'N/A'}</div>
                    </div>
                    ${player.medicalInfo ? `<div><strong>Medical Info:</strong> ${player.medicalInfo}</div>` : ''}
                    <div style="margin-top: 15px;">
                        <button onclick="editPlayer('${player.id}')" class="btn-success">‚úèÔ∏è Edit Player</button>
                        <button onclick="editPlayerStats('${player.id}')" class="btn-success">üìä Edit Stats</button>
                        <button onclick="addInjury('${player.id}')" class="btn-warning">ü©π Add Injury</button>
                        <button onclick="deletePlayer('${player.id}')" class="btn-danger">üóëÔ∏è Delete</button>
                    </div>
                `;
                container.appendChild(playerDiv);
            });
        }

        window.addPlayer = async function() {
            console.log('=== ADD PLAYER START ===');
            console.log('Current Team:', currentTeam);
            console.log('Current League:', currentLeague);
            
            // Comprehensive validation
            if (!currentLeague) {
                console.error('No current league found');
                alert('No league selected. Please refresh the page and select a league first.');
                window.location.href = 'index.html';
                return;
            }
            
            if (!currentLeague.id || !currentLeague.name) {
                console.error('Invalid league data:', currentLeague);
                alert('Invalid league data. Please refresh and select a league again.');
                localStorage.removeItem('currentLeague');
                window.location.href = 'index.html';
                return;
            }
            
            if (!currentTeam) {
                console.error('No current team found');
                alert('Please select a team first using the dropdown above.');
                return;
            }
            
            if (!currentTeam.id || !currentTeam.name) {
                console.error('Invalid team data:', currentTeam);
                alert('Invalid team selection. Please select a team again from the dropdown.');
                currentTeam = null;
                localStorage.removeItem('selectedTeam');
                return;
            }
            
            console.log('Validation passed - League:', currentLeague.name, 'Team:', currentTeam.name);

            const name = document.getElementById('playerName').value.trim();
            const jerseyNumber = document.getElementById('jerseyNumber').value;
            const position = document.getElementById('position').value.trim();
            const phone = document.getElementById('playerPhone').value.trim();
            const email = document.getElementById('playerEmail').value.trim();
            const emergencyContact = document.getElementById('emergencyContact').value.trim();
            const medicalInfo = document.getElementById('medicalInfo').value.trim();
            const files = document.getElementById('playerDocuments').files;

            if (!name) {
                alert('Player name is required');
                return;
            }

            try {
                console.log('Attempting to add player with teamId:', currentTeam.id, 'and leagueId:', currentLeague.id);
                
                // Upload documents if any
                const documentUrls = [];
                for (let file of files) {
                    const storageRef = ref(storage, `players/${currentTeam.id}/${name}/${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    documentUrls.push({ name: file.name, url: downloadURL });
                }

                const playerData = {
                    name: name,
                    jerseyNumber: jerseyNumber,
                    position: position,
                    phone: phone,
                    email: email,
                    emergencyContact: emergencyContact,
                    medicalInfo: medicalInfo,
                    teamId: currentTeam.id,
                    teamName: currentTeam.name,
                    leagueId: currentLeague.id,
                    leagueName: currentLeague.name,
                    documents: documentUrls,
                    stats: {
                        gamesPlayed: 0,
                        points: 0,
                        assists: 0,
                        rebounds: 0,
                        steals: 0,
                        blocks: 0
                    },
                    injuries: [],
                    createdAt: new Date()
                };

                console.log('Player data to be added:', playerData);

                const docRef = await addDoc(collection(db, "players"), playerData);
                console.log('Player added successfully with ID:', docRef.id);

                // Clear form
                document.getElementById('playerName').value = '';
                document.getElementById('jerseyNumber').value = '';
                document.getElementById('position').value = '';
                document.getElementById('playerPhone').value = '';
                document.getElementById('playerEmail').value = '';
                document.getElementById('emergencyContact').value = '';
                document.getElementById('medicalInfo').value = '';
                document.getElementById('playerDocuments').value = '';

                alert('Player added successfully!');
                loadPlayers();
            } catch (error) {
                alert('Error adding player: ' + error.message);
            }
        }

        window.editPlayerStats = function(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            currentPlayer = player;
            document.getElementById('statsPlayerName').textContent = `${player.name} - Statistics`;
            
            const stats = player.stats || {};
            document.getElementById('statsContent').innerHTML = `
                <div style="background: #ecf0f1; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <h3>Game Statistics</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label>Games Played:</label>
                            <input type="number" id="gamesPlayed" value="${stats.gamesPlayed || 0}">
                        </div>
                        <div>
                            <label>Points:</label>
                            <input type="number" id="points" value="${stats.points || 0}">
                        </div>
                        <div>
                            <label>Assists:</label>
                            <input type="number" id="assists" value="${stats.assists || 0}">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div>
                            <label>Rebounds:</label>
                            <input type="number" id="rebounds" value="${stats.rebounds || 0}">
                        </div>
                        <div>
                            <label>Steals:</label>
                            <input type="number" id="steals" value="${stats.steals || 0}">
                        </div>
                        <div>
                            <label>Blocks:</label>
                            <input type="number" id="blocks" value="${stats.blocks || 0}">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('statsModal').classList.remove('hidden');
        }

        window.savePlayerStats = async function() {
            if (!currentPlayer) return;

            const stats = {
                gamesPlayed: parseInt(document.getElementById('gamesPlayed').value) || 0,
                points: parseInt(document.getElementById('points').value) || 0,
                assists: parseInt(document.getElementById('assists').value) || 0,
                rebounds: parseInt(document.getElementById('rebounds').value) || 0,
                steals: parseInt(document.getElementById('steals').value) || 0,
                blocks: parseInt(document.getElementById('blocks').value) || 0
            };

            try {
                await updateDoc(doc(db, "players", currentPlayer.id), { stats: stats });
                alert('Stats updated successfully!');
                closeStatsModal();
                loadPlayers();
            } catch (error) {
                alert('Error updating stats: ' + error.message);
            }
        }

        window.closeStatsModal = function() {
            document.getElementById('statsModal').classList.add('hidden');
            currentPlayer = null;
        }

        window.editPlayer = function(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            currentPlayer = player;
            
            // Populate the edit form with current player data
            document.getElementById('editPlayerName').textContent = `Edit: ${player.name}`;
            document.getElementById('editPlayerNameInput').value = player.name || '';
            document.getElementById('editJerseyNumber').value = player.jerseyNumber || '';
            document.getElementById('editPosition').value = player.position || '';
            document.getElementById('editPlayerPhone').value = player.phone || '';
            document.getElementById('editPlayerEmail').value = player.email || '';
            document.getElementById('editEmergencyContact').value = player.emergencyContact || '';
            document.getElementById('editMedicalInfo').value = player.medicalInfo || '';
            
            document.getElementById('editPlayerModal').classList.remove('hidden');
        }

        window.savePlayerEdit = async function() {
            if (!currentPlayer) return;

            // Get updated values from the form
            const updatedData = {
                name: document.getElementById('editPlayerNameInput').value.trim(),
                jerseyNumber: parseInt(document.getElementById('editJerseyNumber').value) || null,
                position: document.getElementById('editPosition').value.trim(),
                phone: document.getElementById('editPlayerPhone').value.trim(),
                email: document.getElementById('editPlayerEmail').value.trim(),
                emergencyContact: document.getElementById('editEmergencyContact').value.trim(),
                medicalInfo: document.getElementById('editMedicalInfo').value.trim()
            };

            // Validation
            if (!updatedData.name) {
                alert('Player name is required');
                return;
            }

            try {
                // Update the player in the database
                await updateDoc(doc(db, "players", currentPlayer.id), updatedData);
                
                alert('Player updated successfully!');
                closeEditPlayerModal();
                loadPlayers(); // Refresh the player list
                
            } catch (error) {
                console.error('Error updating player:', error);
                alert('Error updating player: ' + error.message);
            }
        }

        window.closeEditPlayerModal = function() {
            document.getElementById('editPlayerModal').classList.add('hidden');
            currentPlayer = null;
        }

        window.addInjury = async function(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            const injury = prompt('Enter injury description:');
            if (!injury) return;

            const injuries = player.injuries || [];
            injuries.push({
                description: injury,
                date: new Date().toLocaleDateString(),
                status: 'active'
            });

            try {
                await updateDoc(doc(db, "players", playerId), { injuries: injuries });
                alert('Injury added');
                loadPlayers();
            } catch (error) {
                alert('Error adding injury: ' + error.message);
            }
        }

        window.deletePlayer = async function(playerId) {
            if (!confirm('Are you sure you want to delete this player? This action cannot be undone.')) return;

            try {
                await deleteDoc(doc(db, "players", playerId));
                alert('Player deleted successfully');
                loadPlayers();
            } catch (error) {
                alert('Error deleting player: ' + error.message);
            }
        }
    </script>
</body>
</html>