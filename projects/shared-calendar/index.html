<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareCal - Collaborative Calendar</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #dbeafe;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-light: #64748b;
            --text-muted: #94a3b8;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            color: var(--text);
        }

        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .floating-shapes {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 25s infinite linear;
        }

        .shape:nth-child(1) { width: 60px; height: 60px; left: 10%; animation-delay: 0s; }
        .shape:nth-child(2) { width: 80px; height: 80px; left: 20%; animation-delay: 3s; }
        .shape:nth-child(3) { width: 40px; height: 40px; left: 60%; animation-delay: 6s; }
        .shape:nth-child(4) { width: 70px; height: 70px; left: 80%; animation-delay: 9s; }
        .shape:nth-child(5) { width: 30px; height: 30px; left: 70%; animation-delay: 12s; }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* main app container */
        .app-container {
            position: relative;
            z-index: 10;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* header */
        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-title h1 {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .user-name {
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
        }

        /* auth section */
        .auth-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .auth-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-subtitle {
            color: var(--text-light);
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: white;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            width: 100%;
            margin-bottom: 15px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            width: 100%;
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .toggle-auth {
            margin-top: 20px;
            color: var(--text-light);
        }

        .toggle-auth a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .toggle-auth a:hover {
            text-decoration: underline;
        }

        /* calendar selection screen */
        .calendar-selection {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            min-height: 500px;
        }

        .selection-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text);
        }

        .selection-subtitle {
            color: var(--text-light);
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .calendar-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .calendar-option {
            background: white;
            border: 2px solid var(--border);
            border-radius: 15px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .calendar-option:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .option-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .option-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }

        .option-description {
            color: var(--text-light);
            line-height: 1.5;
        }

        .calendar-list {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
        }

        .calendar-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-item:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .calendar-info h3 {
            margin: 0 0 5px 0;
            color: var(--text);
        }

        .calendar-info p {
            margin: 0;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .calendar-actions {
            display: flex;
            gap: 10px;
        }

        /* calendar main content */
        .calendar-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-height: 600px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .calendar-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            min-width: 200px;
        }

        .nav-btn {
            padding: 10px 15px;
            background: var(--primary-light);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: var(--primary);
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        .view-controls {
            display: flex;
            gap: 10px;
            background: var(--border);
            border-radius: 10px;
            padding: 5px;
        }

        .view-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            background: transparent;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
        }

        .calendar-actions-header {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn-sm {
            padding: 10px 20px;
            font-size: 0.9rem;
        }

        /* month view */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .calendar-day-header {
            background: var(--primary);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .calendar-day {
            background: white;
            min-height: 100px;
            padding: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .calendar-day:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: var(--text-muted);
        }

        .calendar-day.today {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .calendar-day.has-events {
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
            border-left: 4px solid var(--primary);
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .day-events {
            font-size: 0.8rem;
        }

        .event-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin: 1px;
        }

        /* week view */
        .week-view {
            display: none;
        }

        .week-view.active {
            display: block;
        }

        .week-header {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .week-time-header {
            background: var(--primary);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .week-day-header {
            background: var(--primary);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .week-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: 0 0 12px 12px;
            overflow: hidden;
        }

        .week-time-slot {
            background: #f8f9fa;
            padding: 10px 5px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-light);
            border-bottom: 1px solid var(--border);
        }

        .week-day-slot {
            background: white;
            min-height: 60px;
            padding: 5px;
            position: relative;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .week-day-slot:hover {
            background: var(--primary-light);
        }

        .week-event {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* day view */
        .day-view {
            display: none;
        }

        .day-view.active {
            display: block;
        }

        .day-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
        }

        .day-date {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .day-weekday {
            font-size: 1rem;
            opacity: 0.9;
        }

        .day-schedule {
            background: white;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
        }

        .day-time-slot {
            display: flex;
            border-bottom: 1px solid var(--border);
            min-height: 80px;
        }

        .day-time {
            width: 100px;
            background: #f8f9fa;
            padding: 15px 10px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 600;
        }

        .day-content {
            flex: 1;
            padding: 10px 15px;
            position: relative;
            cursor: pointer;
        }

        .day-content:hover {
            background: var(--primary-light);
        }

        .day-event {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: var(--shadow);
        }

        .day-event-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .day-event-details {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* loading states */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* alert messages */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert-error {
            background: linear-gradient(135deg, #fef2f2, #fecaca);
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .alert-info {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 0;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
            position: relative;
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            background: var(--gradient-primary);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-field {
            position: relative;
        }

        .form-field label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: white;
        }

        .form-field textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal-actions {
            padding: 20px 30px;
            background: #f8f9fa;
            border-radius: 0 0 20px 20px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        /* hidden utility */
        .hidden {
            display: none !important;
        }

        /* responsive */
        @media (max-width: 768px) {
            .app-container {
                padding: 15px;
            }

            .app-header {
                flex-direction: column;
                gap: 15px;
            }

            .calendar-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .calendar-actions-header {
                flex-wrap: wrap;
            }

            .calendar-grid {
                font-size: 0.9rem;
            }

            .calendar-day {
                min-height: 80px;
                padding: 5px;
            }

            .auth-card {
                margin: 20px;
                padding: 30px 25px;
            }

            .modal {
                width: 95%;
                max-height: 95vh;
                margin: 10px;
            }

            .modal-header,
            .modal-body,
            .modal-actions {
                padding: 20px 25px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .week-grid {
                grid-template-columns: 60px repeat(7, 1fr);
            }

            .day-time {
                width: 80px;
            }

            .calendar-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="background-animation">
        <div class="floating-shapes">
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
        </div>
    </div>

    <!-- authentication section -->
    <div id="auth-section" class="auth-section">
        <div class="auth-card">
            <h1 class="auth-title">📅 ShareCal</h1>
            <p class="auth-subtitle">Collaborative calendar for teams and friends</p>
            
            <!-- sign in form -->
            <div id="signin-form">
                <form id="signin-form-element">
                    <div class="form-group">
                        <label class="form-label" for="signin-email">Email or Username</label>
                        <input type="text" id="signin-email" class="form-input" placeholder="Enter email or username..." required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signin-password">Password</label>
                        <input type="password" id="signin-password" class="form-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="signin-btn">
                        🔐 Sign In
                    </button>
                </form>
                <div class="toggle-auth">
                    Don't have an account? <a href="#" onclick="showSignUp()">Create one here</a>
                </div>
                <div style="margin-top: 15px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; font-size: 0.9rem; color: var(--primary);">
                    <strong>🔧 Test Admin Access:</strong><br>
                    Username: <code>dfinn</code><br>
                    Password: <code>p@ssw0rd</code>
                </div>
            </div>

            <!-- sign up form -->
            <div id="signup-form" class="hidden">
                <form id="signup-form-element">
                    <div class="form-group">
                        <label class="form-label" for="signup-name">Full Name</label>
                        <input type="text" id="signup-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signup-email">Email Address</label>
                        <input type="email" id="signup-email" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signup-password">Password</label>
                        <input type="password" id="signup-password" class="form-input" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="signup-confirm">Confirm Password</label>
                        <input type="password" id="signup-confirm" class="form-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="signup-btn">
                        ✨ Create Account
                    </button>
                </form>
                <div class="toggle-auth">
                    Already have an account? <a href="#" onclick="showSignIn()">Sign in here</a>
                </div>
            </div>

            <div id="auth-loading" class="loading hidden">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- calendar selection screen -->
    <div id="calendar-selection" class="app-container hidden">
        <header class="app-header">
            <div class="app-title">
                <h1>📅 ShareCal</h1>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar-select" onclick="showAccountModal()">U</div>
                <span class="user-name" id="user-name-select" onclick="showAccountModal()">User</span>
                <button class="btn btn-secondary btn-sm" onclick="signOut()">Sign Out</button>
            </div>
        </header>

        <div class="calendar-selection">
            <h2 class="selection-title">Welcome to ShareCal!</h2>
            <p class="selection-subtitle">Choose how you'd like to get started with your calendar</p>
            
            <div class="calendar-options">
                <div class="calendar-option" onclick="showCreateCalendarModal()">
                    <div class="option-icon">📅</div>
                    <h3 class="option-title">Create New Calendar</h3>
                    <p class="option-description">Start fresh with a new personal or team calendar</p>
                </div>
                
                <div class="calendar-option" onclick="showJoinCalendarModal()">
                    <div class="option-icon">🔗</div>
                    <h3 class="option-title">Join Existing Calendar</h3>
                    <p class="option-description">Use a share code to join someone else's calendar</p>
                </div>
            </div>

            <div id="user-calendars" class="calendar-list hidden">
                <h3 style="margin-bottom: 20px; color: var(--text);">Your Calendars</h3>
                <div id="calendars-container">
                    <!-- user calendars will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- main app -->
    <div id="main-app" class="app-container hidden">
        <!-- header -->
        <header class="app-header">
            <div class="app-title">
                <h1>📅 ShareCal</h1>
                <span id="current-calendar-name" style="font-size: 1rem; color: var(--text-light); font-weight: 500;"></span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar" onclick="showAccountModal()">U</div>
                <span class="user-name" id="user-name" onclick="showAccountModal()">User</span>
                <button class="btn btn-secondary btn-sm" onclick="backToCalendarSelection()">Switch Calendar</button>
                <button class="btn btn-secondary btn-sm" onclick="signOut()">Sign Out</button>
            </div>
        </header>

        <!-- calendar container -->
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="nav-btn" onclick="previousPeriod()">‹ Previous</button>
                    <h2 class="calendar-title" id="calendar-title">Loading...</h2>
                    <button class="nav-btn" onclick="nextPeriod()">Next ›</button>
                </div>
                
                <div class="view-controls">
                    <button class="view-btn active" data-view="month" onclick="switchView('month')">Month</button>
                    <button class="view-btn" data-view="week" onclick="switchView('week')">Week</button>
                    <button class="view-btn" data-view="day" onclick="switchView('day')">Day</button>
                </div>
                
                <div class="calendar-actions-header">
                    <button class="btn btn-primary btn-sm" onclick="showEventModal()">+ Add Event</button>
                    <button class="btn btn-secondary btn-sm" onclick="showShareModal()">🔗 Share</button>
                    <button class="btn btn-secondary btn-sm" onclick="todayView()">Today</button>
                </div>
            </div>

            <div id="calendar-loading" class="loading">
                <div class="spinner"></div>
            </div>

            <!-- month view -->
            <div id="month-view" class="month-view">
                <div id="calendar-grid" class="calendar-grid hidden">
                    <!-- day headers -->
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>
                    <!-- calendar days will be generated here -->
                </div>
            </div>

            <!-- week view -->
            <div id="week-view" class="week-view">
                <div class="week-header">
                    <div class="week-time-header">Time</div>
                    <div class="week-day-header" id="week-day-0">Sun</div>
                    <div class="week-day-header" id="week-day-1">Mon</div>
                    <div class="week-day-header" id="week-day-2">Tue</div>
                    <div class="week-day-header" id="week-day-3">Wed</div>
                    <div class="week-day-header" id="week-day-4">Thu</div>
                    <div class="week-day-header" id="week-day-5">Fri</div>
                    <div class="week-day-header" id="week-day-6">Sat</div>
                </div>
                <div id="week-grid" class="week-grid">
                    <!-- week grid will be generated here -->
                </div>
            </div>

            <!-- day view -->
            <div id="day-view" class="day-view">
                <div class="day-header">
                    <div class="day-date" id="day-date">Today</div>
                    <div class="day-weekday" id="day-weekday">Monday</div>
                </div>
                <div id="day-schedule" class="day-schedule">
                    <!-- day schedule will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- create calendar modal -->
    <div id="create-calendar-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Create New Calendar</h3>
                <button class="modal-close" onclick="closeCreateCalendarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="create-calendar-form">
                    <div class="form-row full">
                        <div class="form-field">
                            <label for="calendar-name">Calendar Name *</label>
                            <input type="text" id="calendar-name" placeholder="Enter calendar name..." required>
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-field">
                            <label for="calendar-description">Description</label>
                            <textarea id="calendar-description" placeholder="Describe your calendar..."></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="calendar-type">Calendar Type</label>
                            <select id="calendar-type">
                                <option value="personal">Personal</option>
                                <option value="team">Team/Group</option>
                                <option value="project">Project</option>
                                <option value="family">Family</option>
                                <option value="event">Event Planning</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="calendar-color">Calendar Color</label>
                            <select id="calendar-color">
                                <option value="#3b82f6">Blue</option>
                                <option value="#10b981">Green</option>
                                <option value="#f59e0b">Orange</option>
                                <option value="#ef4444">Red</option>
                                <option value="#8b5cf6">Purple</option>
                                <option value="#06b6d4">Cyan</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-field">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="calendar-public">
                                Make this calendar public (others can join with share code)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeCreateCalendarModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createCalendar()">Create Calendar</button>
            </div>
        </div>
    </div>

    <!-- join calendar modal -->
    <div id="join-calendar-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Join Calendar</h3>
                <button class="modal-close" onclick="closeJoinCalendarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row full">
                    <div class="form-field">
                        <label for="join-code">Calendar Share Code</label>
                        <input type="text" id="join-code" placeholder="Enter 8-character code..." maxlength="8" style="text-transform: uppercase;">
                    </div>
                </div>
                <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 10px;">
                    Ask the calendar owner for their share code to join their calendar.
                </p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeJoinCalendarModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="joinCalendarWithCode()">Join Calendar</button>
            </div>
        </div>
    </div>

    <!-- account settings modal -->
    <div id="account-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Account Settings</h3>
                <button class="modal-close" onclick="closeAccountModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="account-form">
                    <div class="form-row">
                        <div class="form-field">
                            <label for="account-name">Full Name</label>
                            <input type="text" id="account-name" required>
                        </div>
                        <div class="form-field">
                            <label for="account-email">Email Address</label>
                            <input type="email" id="account-email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="account-timezone">Timezone</label>
                            <select id="account-timezone">
                                <option value="America/New_York">Eastern Time</option>
                                <option value="America/Chicago">Central Time</option>
                                <option value="America/Denver">Mountain Time</option>
                                <option value="America/Los_Angeles">Pacific Time</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="account-theme">Theme</label>
                            <select id="account-theme">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="auto">Auto</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-field">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="account-notifications">
                                Enable email notifications
                            </label>
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-field">
                            <label for="account-bio">Bio (Optional)</label>
                            <textarea id="account-bio" placeholder="Tell others about yourself..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeAccountModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateAccount()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- event modal (simplified for brevity - same as before) -->
    <div id="event-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="event-modal-title">Create New Event</h3>
                <button class="modal-close" onclick="closeEventModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="event-form">
                    <div class="form-row full">
                        <div class="form-field">
                            <label for="event-title">Event Title *</label>
                            <input type="text" id="event-title" placeholder="Enter event title..." required>
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-field">
                            <label for="event-description">Description</label>
                            <textarea id="event-description" placeholder="Add event description..."></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="event-start-date">Start Date *</label>
                            <input type="date" id="event-start-date" required>
                        </div>
                        <div class="form-field">
                            <label for="event-start-time">Start Time</label>
                            <input type="time" id="event-start-time">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="event-end-date">End Date</label>
                            <input type="date" id="event-end-date">
                        </div>
                        <div class="form-field">
                            <label for="event-end-time">End Time</label>
                            <input type="time" id="event-end-time">
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-field">
                            <label for="event-location">Location</label>
                            <input type="text" id="event-location" placeholder="Add location...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-field">
                            <label for="event-category">Category</label>
                            <select id="event-category">
                                <option value="general">General</option>
                                <option value="work">Work</option>
                                <option value="personal">Personal</option>
                                <option value="meeting">Meeting</option>
                                <option value="deadline">Deadline</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="event-priority">Priority</label>
                            <select id="event-priority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeEventModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEvent()">
                    <span id="save-btn-text">Create Event</span>
                </button>
            </div>
        </div>
    </div>

    <!-- share modal -->
    <div id="share-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Share Calendar</h3>
                <button class="modal-close" onclick="closeShareModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: #f8f9fa; border: 2px dashed var(--primary); border-radius: 10px; padding: 20px; text-align: center; margin: 20px 0;">
                    <h4>Calendar Share Code</h4>
                    <div style="font-family: monospace; font-size: 1.5rem; font-weight: bold; color: var(--primary); letter-spacing: 2px; margin: 10px 0;" id="calendar-share-code">
                        Loading...
                    </div>
                    <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 10px;">
                        Share this code with others to give them access to your calendar
                    </p>
                    <button class="btn btn-primary btn-sm" onclick="copyShareCode()" style="margin-top: 15px;">
                        📋 Copy Code
                    </button>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeShareModal()">Close</button>
                <button type="button" class="btn btn-success" onclick="generateNewShareCode()">
                    🔄 Generate New Code
                </button>
            </div>
        </div>
    </div>

    <!-- firebase and app scripts -->
    <script type="module">
        // import firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut as firebaseSignOut, onAuthStateChanged, updateProfile, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCl5DIursKTk6lWz2trEebcwexmywdJ_vA",
            authDomain: "calendar-app-5e02a.firebaseapp.com",
            projectId: "calendar-app-5e02a",
            storageBucket: "calendar-app-5e02a.firebasestorage.app",
            messagingSenderId: "326997250821",
            appId: "1:326997250821:web:3674e28132d99968539d6c"
        };

        // initialize firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // set auth persistence to local (stays logged in after refresh)
        setPersistence(auth, browserLocalPersistence).catch((error) => {
            console.error('Error setting auth persistence:', error);
        });

        // global variables
        let currentUser = null;
        let currentDate = new Date();
        let currentCalendarId = null;
        let currentCalendarData = null;
        let currentView = 'month';
        let eventsListener = null;
        let userSession = null;
        let currentEventId = null;

        // utility function for generating random codes
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // session management for custom auth
        function saveUserSession(userData) {
            const sessionData = {
                uid: userData.uid,
                email: userData.email || '',
                displayName: userData.displayName || userData.username,
                isCustomAuth: userData.isCustomAuth || false,
                timestamp: Date.now()
            };
            localStorage.setItem('sharecal_session', JSON.stringify(sessionData));
        }

        function loadUserSession() {
            try {
                const sessionData = localStorage.getItem('sharecal_session');
                if (sessionData) {
                    const parsed = JSON.parse(sessionData);
                    // check if session is less than 7 days old
                    if (Date.now() - parsed.timestamp < 7 * 24 * 60 * 60 * 1000) {
                        return parsed;
                    } else {
                        localStorage.removeItem('sharecal_session');
                    }
                }
            } catch (error) {
                console.error('Error loading session:', error);
                localStorage.removeItem('sharecal_session');
            }
            return null;
        }

        function clearUserSession() {
            localStorage.removeItem('sharecal_session');
        }

        // authentication functions
        window.showSignUp = function() {
            document.getElementById('signin-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
        };

        window.showSignIn = function() {
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('signin-form').classList.remove('hidden');
        };

        // sign up
        document.getElementById('signup-form-element').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm').value;

            if (password !== confirmPassword) {
                showAlert('Passwords do not match!', 'error');
                return;
            }

            showAuthLoading(true);

            try {
                // create user with firebase auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // update the user's display name
                await updateProfile(user, { displayName: name });

                // create user profile in firestore
                await setDoc(doc(db, 'accounts', user.uid), {
                    name: name,
                    email: email,
                    createdAt: new Date(),
                    preferences: {
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        theme: 'light',
                        notifications: true
                    },
                    profile: {
                        firstName: name.split(' ')[0] || '',
                        lastName: name.split(' ').slice(1).join(' ') || '',
                        displayName: name,
                        bio: ''
                    }
                });

                showAlert('Account created successfully! Welcome to ShareCal!', 'success');
                
            } catch (error) {
                console.error('Signup error:', error);
                showAlert(error.message, 'error');
            } finally {
                showAuthLoading(false);
            }
        });

        // sign in
        document.getElementById('signin-form-element').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const emailOrUsername = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;

            showAuthLoading(true);

            try {
                // first try test user login (username-based)
                const testLoginSuccess = await loginWithTestCredentials(emailOrUsername, password);
                
                if (!testLoginSuccess) {
                    // if test login fails, try regular firebase auth (email-based only)
                    if (emailOrUsername.includes('@')) {
                        await signInWithEmailAndPassword(auth, emailOrUsername, password);
                        showAlert('Welcome back!', 'success');
                    } else {
                        throw new Error('Invalid username or password');
                    }
                } else {
                    showAlert('Welcome back!', 'success');
                }
            } catch (error) {
                console.error('Signin error:', error);
                if (error.code === 'auth/invalid-email') {
                    showAlert('Please enter a valid email address', 'error');
                } else if (error.code === 'auth/user-not-found') {
                    showAlert('No account found with this email', 'error');
                } else if (error.code === 'auth/wrong-password') {
                    showAlert('Incorrect password', 'error');
                } else {
                    showAlert(error.message || 'Sign in failed', 'error');
                }
            } finally {
                showAuthLoading(false);
            }
        });

        // sign out
        window.signOut = async function() {
            try {
                // handle custom auth users
                if (currentUser && currentUser.isCustomAuth) {
                    currentUser = null;
                    userSession = null;
                    clearUserSession();
                    showAuthSection();
                    if (eventsListener) {
                        eventsListener();
                        eventsListener = null;
                    }
                    showAlert('Signed out successfully', 'info');
                } else {
                    // handle firebase auth users
                    await firebaseSignOut(auth);
                    clearUserSession();
                    showAlert('Signed out successfully', 'info');
                }
            } catch (error) {
                console.error('Signout error:', error);
                showAlert('Error signing out', 'error');
            }
        };

        // auth state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                saveUserSession(user);
                await loadUserProfile();
                showCalendarSelection();
                await loadUserCalendars();
            } else {
                // check for custom auth session
                const session = loadUserSession();
                if (session && session.isCustomAuth) {
                    currentUser = session;
                    userSession = session;
                    await loadUserProfile();
                    showCalendarSelection();
                    await loadUserCalendars();
                } else {
                    currentUser = null;
                    userSession = null;
                    showAuthSection();
                    if (eventsListener) {
                        eventsListener();
                        eventsListener = null;
                    }
                }
            }
        });

        // initialize test admin user on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await createTestAdminUser();
        });

        // create test admin user if it doesn't exist
        async function createTestAdminUser() {
            try {
                // check if admin user already exists
                const adminQuery = query(
                    collection(db, 'accounts'),
                    where('username', '==', 'dfinn')
                );
                
                const adminSnapshot = await getDocs(adminQuery);
                
                if (adminSnapshot.empty) {
                    console.log('Creating test admin user...');
                    
                    // create the test admin user account document
                    const testUserRef = await addDoc(collection(db, 'accounts'), {
                        username: 'dfinn',
                        password: 'p@ssw0rd',
                        isAdmin: 1,
                        email: 'dfinn@testcalendar.com',
                        name: 'Danny Finn',
                        createdDate: new Date(),
                        lastLoggedIP: '127.0.0.1',
                        lastLoginDate: null,
                        lastLoginTime: null,
                        loginCount: 0,
                        accountStatus: 'active',
                        preferences: {
                            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                            theme: 'light',
                            notifications: true,
                            language: 'en'
                        },
                        profile: {
                            firstName: 'Danny',
                            lastName: 'Finn',
                            displayName: 'Danny Finn',
                            avatar: '',
                            bio: 'Test admin user for ShareCal'
                        }
                    });

                    console.log('Test admin user created');
                } else {
                    console.log('Test admin user already exists');
                }
            } catch (error) {
                console.error('Error creating test admin user:', error);
            }
        }

        // enhanced login system for test user
        async function loginWithTestCredentials(username, password) {
            try {
                const userQuery = query(
                    collection(db, 'accounts'),
                    where('username', '==', username)
                );
                
                const userSnapshot = await getDocs(userQuery);
                
                if (!userSnapshot.empty) {
                    const userDoc = userSnapshot.docs[0];
                    const userData = userDoc.data();
                    
                    if (userData.password === password) {
                        // successful login - update login info
                        const now = new Date();
                        const currentIP = await getCurrentIP();
                        
                        await updateDoc(doc(db, 'accounts', userDoc.id), {
                            lastLoginDate: now.toISOString().split('T')[0],
                            lastLoginTime: now.toTimeString().split(' ')[0],
                            lastLoggedIP: currentIP,
                            loginCount: (userData.loginCount || 0) + 1
                        });

                        // create a mock user session for custom auth users
                        currentUser = {
                            uid: userDoc.id,
                            email: userData.email || '',
                            displayName: userData.name || userData.username,
                            isCustomAuth: true
                        };
                        
                        userSession = currentUser;
                        saveUserSession(currentUser);
                        
                        console.log('Custom auth successful for:', userData.username);
                        await loadUserProfile();
                        showCalendarSelection();
                        await loadUserCalendars();
                        return true;
                    } else {
                        showAlert('Invalid password', 'error');
                        return false;
                    }
                } else {
                    return false;
                }
            } catch (error) {
                console.error('Error with test login:', error);
                return false;
            }
        }

        async function getCurrentIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return '127.0.0.1';
            }
        }

        // load user profile and set up UI
        async function loadUserProfile() {
            try {
                const userDoc = await getDoc(doc(db, 'accounts', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const displayName = userData.name || userData.username || 'User';
                    const avatarLetter = displayName.charAt(0).toUpperCase();
                    
                    // update all user info elements
                    document.querySelectorAll('[id^="user-name"]').forEach(el => {
                        el.textContent = displayName;
                        if (userData.isAdmin === 1) {
                            el.innerHTML = `${displayName} <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px;">ADMIN</span>`;
                        }
                    });
                    
                    document.querySelectorAll('[id^="user-avatar"]').forEach(el => {
                        el.textContent = avatarLetter;
                    });
                } else {
                    const displayName = currentUser.displayName || 'User';
                    const avatarLetter = displayName.charAt(0).toUpperCase();
                    
                    document.querySelectorAll('[id^="user-name"]').forEach(el => {
                        el.textContent = displayName;
                    });
                    
                    document.querySelectorAll('[id^="user-avatar"]').forEach(el => {
                        el.textContent = avatarLetter;
                    });
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        // calendar management functions
        async function loadUserCalendars() {
            try {
                // get calendars owned by user
                const ownedQuery = query(
                    collection(db, 'calendars'),
                    where('owner', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                
                const ownedSnapshot = await getDocs(ownedQuery);
                
                // get calendars shared with user
                const sharedQuery = query(
                    collection(db, 'user_calendars'),
                    where('userId', '==', currentUser.uid)
                );
                
                const sharedSnapshot = await getDocs(sharedQuery);
                
                const calendarsContainer = document.getElementById('calendars-container');
                calendarsContainer.innerHTML = '';
                
                let hasCalendars = false;
                
                // display owned calendars
                ownedSnapshot.forEach(doc => {
                    hasCalendars = true;
                    const calendar = doc.data();
                    createCalendarItem(doc.id, calendar, true);
                });
                
                // display shared calendars
                for (const shareDoc of sharedSnapshot.docs) {
                    const shareData = shareDoc.data();
                    const calendarDoc = await getDoc(doc(db, 'calendars', shareData.calendarId));
                    if (calendarDoc.exists()) {
                        hasCalendars = true;
                        const calendar = calendarDoc.data();
                        createCalendarItem(calendarDoc.id, calendar, false, shareData.permissions);
                    }
                }
                
                if (hasCalendars) {
                    document.getElementById('user-calendars').classList.remove('hidden');
                } else {
                    document.getElementById('user-calendars').classList.add('hidden');
                }
                
            } catch (error) {
                console.error('Error loading calendars:', error);
            }
        }

        function createCalendarItem(calendarId, calendarData, isOwner, permissions = null) {
            const calendarsContainer = document.getElementById('calendars-container');
            
            const calendarItem = document.createElement('div');
            calendarItem.className = 'calendar-item';
            calendarItem.onclick = () => selectCalendar(calendarId, calendarData);
            
            const roleText = isOwner ? 'Owner' : `Member (${permissions?.role || 'viewer'})`;
            
            calendarItem.innerHTML = `
                <div class="calendar-info">
                    <h3>${calendarData.name}</h3>
                    <p>${calendarData.description || 'No description'} • ${roleText}</p>
                </div>
                <div class="calendar-actions">
                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); selectCalendar('${calendarId}', ${JSON.stringify(calendarData).replace(/"/g, '&quot;')})">
                        Open
                    </button>
                </div>
            `;
            
            calendarsContainer.appendChild(calendarItem);
        }

        // calendar selection functions
        function showCalendarSelection() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('calendar-selection').classList.remove('hidden');
        }

        function showMainApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('calendar-selection').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }

        function showAuthSection() {
            document.getElementById('calendar-selection').classList.add('hidden');
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('auth-section').classList.remove('hidden');
        }

        window.backToCalendarSelection = function() {
            if (eventsListener) {
                eventsListener();
                eventsListener = null;
            }
            currentCalendarId = null;
            currentCalendarData = null;
            showCalendarSelection();
            loadUserCalendars();
        };

        async function selectCalendar(calendarId, calendarData) {
            currentCalendarId = calendarId;
            currentCalendarData = calendarData;
            
            // update UI
            document.getElementById('current-calendar-name').textContent = calendarData.name;
            
            showMainApp();
            setupEventsListener();
            renderCurrentView();
        }

        // create calendar modal functions
        window.showCreateCalendarModal = function() {
            document.getElementById('create-calendar-modal').classList.add('show');
            document.body.style.overflow = 'hidden';
        };

        window.closeCreateCalendarModal = function() {
            document.getElementById('create-calendar-modal').classList.remove('show');
            document.body.style.overflow = 'auto';
            document.getElementById('create-calendar-form').reset();
        };

        window.createCalendar = async function() {
            const name = document.getElementById('calendar-name').value.trim();
            const description = document.getElementById('calendar-description').value.trim();
            const type = document.getElementById('calendar-type').value;
            const color = document.getElementById('calendar-color').value;
            const isPublic = document.getElementById('calendar-public').checked;
            
            if (!name) {
                showAlert('Please enter a calendar name', 'error');
                return;
            }
            
            try {
                const calendarData = {
                    name: name,
                    description: description,
                    type: type,
                    owner: currentUser.uid,
                    createdAt: new Date(),
                    isPublic: isPublic,
                    shareCode: generateRandomCode(),
                    shareSettings: {
                        public: isPublic,
                        allowCreate: false,
                        allowEdit: false,
                        notifications: true
                    },
                    settings: {
                        color: color,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    }
                };
                
                const calendarRef = await addDoc(collection(db, 'calendars'), calendarData);
                
                showAlert('Calendar created successfully!', 'success');
                closeCreateCalendarModal();
                
                // automatically select the new calendar
                selectCalendar(calendarRef.id, calendarData);
                
            } catch (error) {
                console.error('Error creating calendar:', error);
                showAlert('Error creating calendar. Please try again.', 'error');
            }
        };

        // join calendar modal functions
        window.showJoinCalendarModal = function() {
            document.getElementById('join-calendar-modal').classList.add('show');
            document.body.style.overflow = 'hidden';
        };

        window.closeJoinCalendarModal = function() {
            document.getElementById('join-calendar-modal').classList.remove('show');
            document.body.style.overflow = 'auto';
            document.getElementById('join-code').value = '';
        };

        window.joinCalendarWithCode = async function() {
            const code = document.getElementById('join-code').value.trim().toUpperCase();
            
            if (!code || code.length !== 8) {
                showAlert('Please enter a valid 8-character code', 'error');
                return;
            }
            
            try {
                const calendarsQuery = query(
                    collection(db, 'calendars'),
                    where('shareCode', '==', code)
                );
                
                const calendarsSnapshot = await getDocs(calendarsQuery);
                
                if (calendarsSnapshot.empty) {
                    showAlert('Calendar not found. Please check the code.', 'error');
                    return;
                }
                
                const calendar = calendarsSnapshot.docs[0];
                const calendarData = calendar.data();
                
                if (!calendarData.shareSettings?.public && calendarData.owner !== currentUser.uid) {
                    showAlert('This calendar is not publicly accessible', 'error');
                    return;
                }
                
                // check if user is already a member
                const existingQuery = query(
                    collection(db, 'user_calendars'),
                    where('userId', '==', currentUser.uid),
                    where('calendarId', '==', calendar.id)
                );
                
                const existingSnapshot = await getDocs(existingQuery);
                
                if (!existingSnapshot.empty) {
                    showAlert('You are already a member of this calendar', 'info');
                    closeJoinCalendarModal();
                    return;
                }
                
                // add user to calendar
                await addDoc(collection(db, 'user_calendars'), {
                    calendarId: calendar.id,
                    userId: currentUser.uid,
                    permissions: {
                        view: true,
                        create: calendarData.shareSettings?.allowCreate || false,
                        edit: calendarData.shareSettings?.allowEdit || false
                    },
                    role: 'member',
                    addedAt: new Date()
                });
                
                showAlert(`Successfully joined "${calendarData.name}"!`, 'success');
                closeJoinCalendarModal();
                loadUserCalendars();
                
            } catch (error) {
                console.error('Error joining calendar:', error);
                showAlert('Error joining calendar', 'error');
            }
        };

        // account modal functions
        window.showAccountModal = function() {
            loadAccountData();
            document.getElementById('account-modal').classList.add('show');
            document.body.style.overflow = 'hidden';
        };

        window.closeAccountModal = function() {
            document.getElementById('account-modal').classList.remove('show');
            document.body.style.overflow = 'auto';
        };

        async function loadAccountData() {
            try {
                const userDoc = await getDoc(doc(db, 'accounts', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    document.getElementById('account-name').value = userData.name || '';
                    document.getElementById('account-email').value = userData.email || '';
                    document.getElementById('account-timezone').value = userData.preferences?.timezone || 'America/New_York';
                    document.getElementById('account-theme').value = userData.preferences?.theme || 'light';
                    document.getElementById('account-notifications').checked = userData.preferences?.notifications !== false;
                    document.getElementById('account-bio').value = userData.profile?.bio || '';
                } else {
                    // populate with current user data
                    document.getElementById('account-name').value = currentUser.displayName || '';
                    document.getElementById('account-email').value = currentUser.email || '';
                    document.getElementById('account-timezone').value = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    document.getElementById('account-theme').value = 'light';
                    document.getElementById('account-notifications').checked = true;
                    document.getElementById('account-bio').value = '';
                }
            } catch (error) {
                console.error('Error loading account data:', error);
            }
        }

        window.updateAccount = async function() {
            const name = document.getElementById('account-name').value.trim();
            const email = document.getElementById('account-email').value.trim();
            const timezone = document.getElementById('account-timezone').value;
            const theme = document.getElementById('account-theme').value;
            const notifications = document.getElementById('account-notifications').checked;
            const bio = document.getElementById('account-bio').value.trim();
            
            if (!name || !email) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const updateData = {
                    name: name,
                    email: email,
                    preferences: {
                        timezone: timezone,
                        theme: theme,
                        notifications: notifications
                    },
                    profile: {
                        firstName: name.split(' ')[0] || '',
                        lastName: name.split(' ').slice(1).join(' ') || '',
                        displayName: name,
                        bio: bio
                    },
                    updatedAt: new Date()
                };
                
                await updateDoc(doc(db, 'accounts', currentUser.uid), updateData);
                
                // update firebase auth profile if not custom auth
                if (!currentUser.isCustomAuth) {
                    await updateProfile(auth.currentUser, { displayName: name });
                }
                
                // update current user object
                currentUser.displayName = name;
                if (!currentUser.isCustomAuth) {
                    currentUser.email = email;
                }
                
                // refresh UI
                await loadUserProfile();
                
                showAlert('Account updated successfully!', 'success');
                closeAccountModal();
                
            } catch (error) {
                console.error('Error updating account:', error);
                showAlert('Error updating account. Please try again.', 'error');
            }
        };

        // view switching functions
        window.switchView = function(view) {
            currentView = view;
            
            // update view buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === view) {
                    btn.classList.add('active');
                }
            });
            
            // hide all views
            document.getElementById('month-view').classList.remove('active');
            document.getElementById('week-view').classList.remove('active');
            document.getElementById('day-view').classList.remove('active');
            
            // show selected view
            document.getElementById(`${view}-view`).classList.add('active');
            
            renderCurrentView();
        };

        function renderCurrentView() {
            switch (currentView) {
                case 'month':
                    renderMonthView();
                    break;
                case 'week':
                    renderWeekView();
                    break;
                case 'day':
                    renderDayView();
                    break;
            }
        }

        // month view rendering
        function renderMonthView() {
            document.getElementById('calendar-loading').classList.add('hidden');
            document.getElementById('calendar-grid').classList.remove('hidden');
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // update calendar title
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            document.getElementById('calendar-title').textContent = `${monthNames[month]} ${year}`;
            
            // clear existing calendar days (keep headers)
            const calendarGrid = document.getElementById('calendar-grid');
            const dayElements = calendarGrid.querySelectorAll('.calendar-day');
            dayElements.forEach(el => el.remove());
            
            // generate calendar days
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const today = new Date();
            
            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                if (currentDay.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                if (currentDay.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                dayElement.innerHTML = `
                    <div class="day-number">${currentDay.getDate()}</div>
                    <div class="day-events" id="events-${currentDay.getTime()}"></div>
                `;
                
                dayElement.onclick = () => showEventModal(currentDay);
                calendarGrid.appendChild(dayElement);
            }
            
            loadEventsForMonth();
        }

        // week view rendering
        function renderWeekView() {
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
            
            // update week headers
            const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                document.getElementById(`week-day-${i}`).textContent = `${weekDays[i]} ${day.getDate()}`;
            }
            
            // update title
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            document.getElementById('calendar-title').textContent = 
                `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;
            
            // generate time slots
            const weekGrid = document.getElementById('week-grid');
            weekGrid.innerHTML = '';
            
            for (let hour = 0; hour < 24; hour++) {
                // time slot
                const timeSlot = document.createElement('div');
                timeSlot.className = 'week-time-slot';
                timeSlot.textContent = `${hour.toString().padStart(2, '0')}:00`;
                weekGrid.appendChild(timeSlot);
                
                // day slots for this hour
                for (let day = 0; day < 7; day++) {
                    const daySlot = document.createElement('div');
                    daySlot.className = 'week-day-slot';
                    daySlot.dataset.hour = hour;
                    daySlot.dataset.day = day;
                    
                    const slotDate = new Date(startOfWeek);
                    slotDate.setDate(startOfWeek.getDate() + day);
                    slotDate.setHours(hour, 0, 0, 0);
                    
                    daySlot.onclick = () => showEventModal(slotDate);
                    weekGrid.appendChild(daySlot);
                }
            }
            
            loadEventsForWeek();
        }

        // day view rendering
        function renderDayView() {
            const dayDate = document.getElementById('day-date');
            const dayWeekday = document.getElementById('day-weekday');
            
            dayDate.textContent = currentDate.toLocaleDateString();
            dayWeekday.textContent = currentDate.toLocaleDateString('en-US', { weekday: 'long' });
            
            document.getElementById('calendar-title').textContent = 
                currentDate.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            
            // generate day schedule
            const daySchedule = document.getElementById('day-schedule');
            daySchedule.innerHTML = '';
            
            for (let hour = 0; hour < 24; hour++) {
                const timeSlot = document.createElement('div');
                timeSlot.className = 'day-time-slot';
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'day-time';
                timeDiv.textContent = `${hour.toString().padStart(2, '0')}:00`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'day-content';
                contentDiv.dataset.hour = hour;
                
                const slotDate = new Date(currentDate);
                slotDate.setHours(hour, 0, 0, 0);
                
                contentDiv.onclick = () => showEventModal(slotDate);
                
                timeSlot.appendChild(timeDiv);
                timeSlot.appendChild(contentDiv);
                daySchedule.appendChild(timeSlot);
            }
            
            loadEventsForDay();
        }

        // event loading functions
        async function loadEventsForMonth() {
            if (!currentCalendarId) return;
            
            try {
                const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                
                const eventsQuery = query(
                    collection(db, 'events'),
                    where('calendarId', '==', currentCalendarId),
                    where('startDate', '>=', startOfMonth),
                    where('startDate', '<=', endOfMonth),
                    orderBy('startDate', 'asc')
                );
                
                const eventsSnapshot = await getDocs(eventsQuery);
                
                // clear existing events
                document.querySelectorAll('.day-events').forEach(el => el.innerHTML = '');
                document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('has-events'));
                
                // display events
                eventsSnapshot.forEach(doc => {
                    const event = doc.data();
                    const eventDate = event.startDate.toDate();
                    
                    // find the matching day element
                    const dayElements = document.querySelectorAll('.calendar-day');
                    dayElements.forEach(dayEl => {
                        const dayNumberEl = dayEl.querySelector('.day-number');
                        if (dayNumberEl) {
                            const dayNumber = parseInt(dayNumberEl.textContent);
                            const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), dayNumber);
                            
                            if (eventDate.toDateString() === dayDate.toDateString()) {
                                dayEl.classList.add('has-events');
                                const dayEventsEl = dayEl.querySelector('.day-events');
                                if (dayEventsEl) {
                                    const eventDot = document.createElement('div');
                                    eventDot.className = 'event-dot';
                                    eventDot.style.background = event.color || '#3b82f6';
                                    eventDot.title = event.title;
                                    dayEventsEl.appendChild(eventDot);
                                }
                            }
                        }
                    });
                });
                
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        async function loadEventsForWeek() {
            if (!currentCalendarId) return;
            
            try {
                const startOfWeek = new Date(currentDate);
                startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                startOfWeek.setHours(0, 0, 0, 0);
                
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999);
                
                const eventsQuery = query(
                    collection(db, 'events'),
                    where('calendarId', '==', currentCalendarId),
                    where('startDate', '>=', startOfWeek),
                    where('startDate', '<=', endOfWeek),
                    orderBy('startDate', 'asc')
                );
                
                const eventsSnapshot = await getDocs(eventsQuery);
                
                // clear existing events
                document.querySelectorAll('.week-day-slot').forEach(el => el.innerHTML = '');
                
                // display events
                eventsSnapshot.forEach(doc => {
                    const event = doc.data();
                    const eventDate = event.startDate.toDate();
                    const dayOfWeek = eventDate.getDay();
                    const hour = eventDate.getHours();
                    
                    const daySlot = document.querySelector(`[data-day="${dayOfWeek}"][data-hour="${hour}"]`);
                    if (daySlot) {
                        const eventElement = document.createElement('div');
                        eventElement.className = 'week-event';
                        eventElement.style.background = event.color || '#3b82f6';
                        eventElement.textContent = event.title;
                        eventElement.title = event.description || event.title;
                        eventElement.onclick = (e) => {
                            e.stopPropagation();
                            showEventDetails(doc.id, event);
                        };
                        daySlot.appendChild(eventElement);
                    }
                });
                
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        async function loadEventsForDay() {
            if (!currentCalendarId) return;
            
            try {
                const startOfDay = new Date(currentDate);
                startOfDay.setHours(0, 0, 0, 0);
                
                const endOfDay = new Date(currentDate);
                endOfDay.setHours(23, 59, 59, 999);
                
                const eventsQuery = query(
                    collection(db, 'events'),
                    where('calendarId', '==', currentCalendarId),
                    where('startDate', '>=', startOfDay),
                    where('startDate', '<=', endOfDay),
                    orderBy('startDate', 'asc')
                );
                
                const eventsSnapshot = await getDocs(eventsQuery);
                
                // clear existing events
                document.querySelectorAll('.day-content').forEach(el => el.innerHTML = '');
                
                // display events
                eventsSnapshot.forEach(doc => {
                    const event = doc.data();
                    const eventDate = event.startDate.toDate();
                    const hour = eventDate.getHours();
                    
                    const contentDiv = document.querySelector(`[data-hour="${hour}"]`);
                    if (contentDiv) {
                        const eventElement = document.createElement('div');
                        eventElement.className = 'day-event';
                        eventElement.style.background = `linear-gradient(135deg, ${event.color || '#3b82f6'}, ${event.color || '#2563eb'})`;
                        
                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'day-event-title';
                        titleDiv.textContent = event.title;
                        
                        const detailsDiv = document.createElement('div');
                        detailsDiv.className = 'day-event-details';
                        detailsDiv.textContent = `${eventDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}${event.location ? ' • ' + event.location : ''}`;
                        
                        eventElement.appendChild(titleDiv);
                        eventElement.appendChild(detailsDiv);
                        
                        eventElement.onclick = (e) => {
                            e.stopPropagation();
                            showEventDetails(doc.id, event);
                        };
                        
                        contentDiv.appendChild(eventElement);
                    }
                });
                
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        // navigation functions
        window.previousPeriod = function() {
            switch (currentView) {
                case 'month':
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    break;
                case 'week':
                    currentDate.setDate(currentDate.getDate() - 7);
                    break;
                case 'day':
                    currentDate.setDate(currentDate.getDate() - 1);
                    break;
            }
            renderCurrentView();
        };

        window.nextPeriod = function() {
            switch (currentView) {
                case 'month':
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    break;
                case 'week':
                    currentDate.setDate(currentDate.getDate() + 7);
                    break;
                case 'day':
                    currentDate.setDate(currentDate.getDate() + 1);
                    break;
            }
            renderCurrentView();
        };

        window.todayView = function() {
            currentDate = new Date();
            renderCurrentView();
        };

        // setup real-time events listener
        function setupEventsListener() {
            if (eventsListener) {
                eventsListener();
            }

            const eventsQuery = query(
                collection(db, 'events'),
                where('calendarId', '==', currentCalendarId),
                orderBy('startDate', 'asc')
            );

            eventsListener = onSnapshot(eventsQuery, (snapshot) => {
                renderCurrentView();
            });
        }

        // event modal functions (simplified)
        window.showEventModal = function(date = null, eventId = null, eventData = null) {
            const modal = document.getElementById('event-modal');
            const modalTitle = document.getElementById('event-modal-title');
            const saveBtnText = document.getElementById('save-btn-text');
            
            document.getElementById('event-form').reset();
            
            if (eventId && eventData) {
                currentEventId = eventId;
                modalTitle.textContent = 'Edit Event';
                saveBtnText.textContent = 'Update Event';
                populateEventForm(eventData);
            } else {
                currentEventId = null;
                modalTitle.textContent = 'Create New Event';
                saveBtnText.textContent = 'Create Event';
                
                if (date) {
                    const dateStr = date.toISOString().split('T')[0];
                    const timeStr = date.toTimeString().slice(0, 5);
                    document.getElementById('event-start-date').value = dateStr;
                    document.getElementById('event-end-date').value = dateStr;
                    document.getElementById('event-start-time').value = timeStr;
                }
            }
            
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        };

        window.closeEventModal = function() {
            document.getElementById('event-modal').classList.remove('show');
            document.body.style.overflow = 'auto';
            currentEventId = null;
        };

        function populateEventForm(eventData) {
            document.getElementById('event-title').value = eventData.title || '';
            document.getElementById('event-description').value = eventData.description || '';
            document.getElementById('event-location').value = eventData.location || '';
            document.getElementById('event-category').value = eventData.category || 'general';
            document.getElementById('event-priority').value = eventData.priority || 'medium';
            
            if (eventData.startDate) {
                const startDate = eventData.startDate.toDate();
                document.getElementById('event-start-date').value = startDate.toISOString().split('T')[0];
                document.getElementById('event-start-time').value = startDate.toTimeString().slice(0, 5);
            }
            
            if (eventData.endDate) {
                const endDate = eventData.endDate.toDate();
                document.getElementById('event-end-date').value = endDate.toISOString().split('T')[0];
                document.getElementById('event-end-time').value = endDate.toTimeString().slice(0, 5);
            }
        }

        window.saveEvent = async function() {
            const title = document.getElementById('event-title').value.trim();
            if (!title) {
                showAlert('Please enter an event title', 'error');
                return;
            }
            
            const startDate = document.getElementById('event-start-date').value;
            const startTime = document.getElementById('event-start-time').value || '09:00';
            const endDate = document.getElementById('event-end-date').value || startDate;
            const endTime = document.getElementById('event-end-time').value || '10:00';
            
            const startDateTime = new Date(`${startDate}T${startTime}`);
            const endDateTime = new Date(`${endDate}T${endTime}`);
            
            const eventData = {
                title: title,
                description: document.getElementById('event-description').value.trim(),
                location: document.getElementById('event-location').value.trim(),
                category: document.getElementById('event-category').value,
                priority: document.getElementById('event-priority').value,
                startDate: startDateTime,
                endDate: endDateTime,
                color: '#3b82f6', // default color
                calendarId: currentCalendarId,
                createdBy: currentUser.uid,
                createdAt: new Date(),
                updatedAt: new Date()
            };
            
            try {
                if (currentEventId) {
                    await updateDoc(doc(db, 'events', currentEventId), {
                        ...eventData,
                        updatedAt: new Date()
                    });
                    showAlert('Event updated successfully!', 'success');
                } else {
                    await addDoc(collection(db, 'events'), eventData);
                    showAlert('Event created successfully!', 'success');
                }
                
                closeEventModal();
                renderCurrentView();
            } catch (error) {
                console.error('Error saving event:', error);
                showAlert('Error saving event. Please try again.', 'error');
            }
        };

        window.showEventDetails = function(eventId, eventData) {
            showEventModal(null, eventId, eventData);
        };

        // share modal functions
        window.showShareModal = async function() {
            if (!currentCalendarData) return;
            
            document.getElementById('calendar-share-code').textContent = currentCalendarData.shareCode || 'Loading...';
            document.getElementById('share-modal').classList.add('show');
            document.body.style.overflow = 'hidden';
        };

        window.closeShareModal = function() {
            document.getElementById('share-modal').classList.remove('show');
            document.body.style.overflow = 'auto';
        };

        window.copyShareCode = function() {
            const code = document.getElementById('calendar-share-code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showAlert('Share code copied to clipboard!', 'success');
            }).catch(() => {
                showAlert('Failed to copy code', 'error');
            });
        };

        window.generateNewShareCode = async function() {
            try {
                const newCode = generateRandomCode();
                await updateDoc(doc(db, 'calendars', currentCalendarId), {
                    shareCode: newCode
                });
                
                currentCalendarData.shareCode = newCode;
                document.getElementById('calendar-share-code').textContent = newCode;
                showAlert('New share code generated!', 'success');
            } catch (error) {
                console.error('Error generating new code:', error);
                showAlert('Error generating new code', 'error');
            }
        };

        // UI helper functions
        function showAuthLoading(show) {
            const loadingEl = document.getElementById('auth-loading');
            const signInForm = document.getElementById('signin-form');
            const signUpForm = document.getElementById('signup-form');
            
            if (show) {
                loadingEl.classList.remove('hidden');
                signInForm.classList.add('hidden');
                signUpForm.classList.add('hidden');
            } else {
                loadingEl.classList.add('hidden');
                if (signUpForm.classList.contains('hidden')) {
                    signInForm.classList.remove('hidden');
                } else {
                    signUpForm.classList.remove('hidden');
                }
            }
        }

        function showAlert(message, type) {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;

            // determine container based on current screen
            let container;
            if (!document.getElementById('auth-section').classList.contains('hidden')) {
                container = document.querySelector('.auth-card');
            } else if (!document.getElementById('calendar-selection').classList.contains('hidden')) {
                container = document.querySelector('.calendar-selection');
            } else {
                container = document.querySelector('.calendar-container');
            }
            
            if (container) {
                container.appendChild(alert);
                
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 5000);
            }
        }

        // keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.modal-overlay.show');
                modals.forEach(modal => {
                    if (modal.id === 'event-modal') closeEventModal();
                    else if (modal.id === 'share-modal') closeShareModal();
                    else if (modal.id === 'account-modal') closeAccountModal();
                    else if (modal.id === 'create-calendar-modal') closeCreateCalendarModal();
                    else if (modal.id === 'join-calendar-modal') closeJoinCalendarModal();
                });
            }
        });

        // close modals on backdrop click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                const modalId = e.target.id;
                if (modalId === 'event-modal') closeEventModal();
                else if (modalId === 'share-modal') closeShareModal();
                else if (modalId === 'account-modal') closeAccountModal();
                else if (modalId === 'create-calendar-modal') closeCreateCalendarModal();
                else if (modalId === 'join-calendar-modal') closeJoinCalendarModal();
            }
        });

        // auto-uppercase join code input
        document.getElementById('join-code').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });
    </script>
</body>
</html>