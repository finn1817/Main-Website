<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Password Manager & Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <!-- Firebase Auth -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    /* css custom properties for consistent theming */
    :root {
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --success-color: #4caf50;
      --success-hover: #45a049;
      --danger-color: #dc3545;
      --danger-hover: #bd2130;
      --warning-color: #ffc107;
      --warning-hover: #e0a800;
      --card-bg-light: rgba(255, 255, 255, 0.95);
      --card-bg-dark: rgba(20, 20, 20, 0.95);
      --text-light: #333;
      --text-dark: #f0f0f0;
      --text-secondary-light: #555;
      --text-secondary-dark: #ccc;
      --border-radius: 15px;
      --shadow-light: 0 10px 30px rgba(0, 0, 0, 0.1);
      --shadow-dark: 0 10px 30px rgba(0, 0, 0, 0.5);
      --transition-speed: 0.3s;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: all var(--transition-speed) ease;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: url("/Main-Website/assets/images/background-light.jpg") center/cover no-repeat;
      background-attachment: fixed;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    body.dark {
      background: url("/Main-Website/assets/images/background-dark.jpg") center/cover no-repeat;
      background-attachment: fixed;
    }

    /* animated background particles */
    .particles-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      background: rgba(0, 123, 255, 0.1);
      border-radius: 50%;
      animation: float-particle 20s linear infinite;
    }

    @keyframes float-particle {
      0% {
        transform: translateY(100vh) translateX(0) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) translateX(50px) rotate(360deg);
        opacity: 0;
      }
    }

    /* main container with enhanced styling */
    .container {
      background: var(--card-bg-light);
      backdrop-filter: blur(20px);
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
      max-width: 900px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      z-index: 10;
    }

    body.dark .container {
      background: var(--card-bg-dark);
      box-shadow: var(--shadow-dark);
      border-color: rgba(255, 255, 255, 0.1);
    }

    /* subtle hover effect for main container */
    .container:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 40px rgba(0, 123, 255, 0.15);
    }

    body.dark .container:hover {
      box-shadow: 0 15px 40px rgba(0, 123, 255, 0.25);
    }

    /* enhanced typography */
    h1 {
      color: var(--text-light);
      font-size: 2.2em;
      font-weight: 700;
      margin-bottom: 20px;
      background: linear-gradient(135deg, var(--primary-color), #4dabf7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
    }

    body.dark h1 {
      color: var(--text-dark);
    }

    h2 {
      color: var(--text-light);
      font-size: 1.5em;
      font-weight: 600;
      margin: 25px 0 15px 0;
      position: relative;
      display: inline-block;
    }

    body.dark h2 {
      color: var(--text-dark);
    }

    /* decorative line under section headers */
    h2::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: linear-gradient(135deg, var(--primary-color), #4dabf7);
      border-radius: 2px;
    }

    p {
      color: var(--text-secondary-light);
      font-size: 1rem;
      font-weight: 400;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    body.dark p {
      color: var(--text-secondary-dark);
    }

    /* form styles */
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--text-light);
    }

    body.dark label {
      color: var(--text-dark);
    }

    input, select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s, box-shadow 0.3s;
      background: rgba(255, 255, 255, 0.8);
      color: var(--text-light);
    }

    body.dark input, body.dark select {
      border-color: #444;
      background: rgba(40, 40, 40, 0.8);
      color: var(--text-dark);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    }

    /* button styles */
    .btn {
      display: inline-block;
      padding: 12px 24px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      text-decoration: none;
    }

    .btn:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-success {
      background: var(--success-color);
    }

    .btn-success:hover {
      background: var(--success-hover);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .btn-danger {
      background: var(--danger-color);
    }

    .btn-danger:hover {
      background: var(--danger-hover);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }

    .btn-warning {
      background: var(--warning-color);
      color: #333;
    }

    .btn-warning:hover {
      background: var(--warning-hover);
      box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-block {
      display: block;
      width: 100%;
    }

    /* layout styles */
    .app-container {
      display: none;
    }

    .auth-screen {
      text-align: center;
      max-width: 400px;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }

    body.dark .tabs {
      border-color: #444;
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 600;
      color: var(--text-secondary-light);
      position: relative;
    }

    body.dark .tab {
      color: var(--text-secondary-dark);
    }

    .tab.active {
      color: var(--primary-color);
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      width: 100%;
      height: 3px;
      background: var(--primary-color);
      border-radius: 3px 3px 0 0;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* password list styles */
    .password-list {
      margin-top: 20px;
      border-radius: 10px;
      overflow: hidden;
    }

    .password-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #eee;
      background: rgba(255, 255, 255, 0.7);
      transition: background 0.3s;
    }

    body.dark .password-item {
      border-color: #333;
      background: rgba(40, 40, 40, 0.7);
    }

    .password-item:hover {
      background: rgba(0, 123, 255, 0.05);
    }

    body.dark .password-item:hover {
      background: rgba(0, 123, 255, 0.15);
    }

    .password-item:last-child {
      border-bottom: none;
    }

    .password-info {
      flex: 1;
      text-align: left;
    }

    .website-name {
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 5px;
    }

    body.dark .website-name {
      color: var(--text-dark);
    }

    .username {
      font-size: 0.9rem;
      color: var(--text-secondary-light);
    }

    body.dark .username {
      color: var(--text-secondary-dark);
    }

    .password-actions {
      display: flex;
      gap: 10px;
    }

    .password-actions button {
      padding: 8px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: rgba(0, 123, 255, 0.1);
      color: var(--primary-color);
      transition: all 0.3s;
    }

    body.dark .password-actions button {
      background: rgba(0, 123, 255, 0.2);
    }

    .password-actions button:hover {
      background: rgba(0, 123, 255, 0.2);
      transform: translateY(-2px);
    }

    body.dark .password-actions button:hover {
      background: rgba(0, 123, 255, 0.3);
    }

    /* generator styles */
    .password-generator {
      background: rgba(0, 123, 255, 0.05);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    body.dark .password-generator {
      background: rgba(0, 123, 255, 0.1);
    }

    .generated-password {
      font-family: monospace;
      font-size: 1.2rem;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.8);
      border: 1px dashed #ddd;
      border-radius: 8px;
      margin: 15px 0;
      word-break: break-all;
      text-align: center;
      position: relative;
    }

    body.dark .generated-password {
      background: rgba(40, 40, 40, 0.8);
      border-color: #444;
      color: var(--text-dark);
    }

    .options-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
    }

    .slider-container {
      margin-bottom: 20px;
    }

    .slider-container label {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .slider-container label span {
      font-weight: 600;
      color: var(--primary-color);
    }

    .slider {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    body.dark .slider {
      background: #444;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      transition: all 0.3s;
    }

    .slider::-webkit-slider-thumb:hover {
      background: var(--primary-hover);
      transform: scale(1.1);
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      transition: all 0.3s;
      border: none;
    }

    .slider::-moz-range-thumb:hover {
      background: var(--primary-hover);
      transform: scale(1.1);
    }

    /* password strength meter */
    .password-strength {
      margin-top: 10px;
    }

    .strength-meter {
      height: 5px;
      border-radius: 5px;
      margin-top: 5px;
      background: #ddd;
      overflow: hidden;
    }

    .strength-meter-fill {
      height: 100%;
      width: 0;
      transition: width 0.3s, background 0.3s;
    }

    .strength-text {
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 5px;
      text-align: right;
    }

    /* strength levels */
    .strength-very-weak .strength-meter-fill {
      width: 20%;
      background: #ff4d4d;
    }

    .strength-weak .strength-meter-fill {
      width: 40%;
      background: #ffa64d;
    }

    .strength-medium .strength-meter-fill {
      width: 60%;
      background: #ffee4d;
    }

    .strength-strong .strength-meter-fill {
      width: 80%;
      background: #9cff4d;
    }

    .strength-very-strong .strength-meter-fill {
      width: 100%;
      background: #4dff88;
    }

    /* animated copy button */
    .copy-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .copy-btn:hover {
      background: var(--primary-hover);
    }

    .copy-btn.copied {
      background: var(--success-color);
    }

    /* security badge */
    .security-badge {
      display: inline-block;
      background: linear-gradient(135deg, #2c3e50, #4ca1af);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .security-badge svg {
      width: 16px;
      height: 16px;
      vertical-align: middle;
      margin-right: 5px;
    }

    /* auth tabs */
    .auth-tabs {
      display: flex;
      margin-bottom: 20px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ddd;
    }

    body.dark .auth-tabs {
      border-color: #444;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-weight: 600;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.5);
      color: var(--text-secondary-light);
      transition: all 0.3s;
    }

    body.dark .auth-tab {
      background: rgba(40, 40, 40, 0.5);
      color: var(--text-secondary-dark);
    }

    .auth-tab.active {
      background: var(--primary-color);
      color: white;
    }

    .auth-content {
      display: none;
    }

    .auth-content.active {
      display: block;
      animation: fadeIn 0.5s ease forwards;
    }

    /* enhanced scrollbar */
    .container::-webkit-scrollbar {
      width: 8px;
    }

    .container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.05);
      border-radius: 10px;
    }

    .container::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--primary-color), #4dabf7);
      border-radius: 10px;
    }

    .container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #0056b3, #007bff);
    }

    body.dark .container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    /* enhanced navigation buttons */
    .back-to-home {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 12px 24px;
      background: linear-gradient(135deg, var(--success-color), #45a049);
      color: white;
      text-decoration: none;
      font-weight: 600;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      transition: all var(--transition-speed) ease;
      z-index: 100;
      backdrop-filter: blur(5px);
    }

    .back-to-home:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
      background: linear-gradient(135deg, #45a049, #388e3c);
    }

    .toggle-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 1.3em;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      transition: all var(--transition-speed) ease;
      z-index: 100;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toggle-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1) rotate(180deg);
      box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
    }

    /* empty state */
    .empty-state {
      padding: 40px 20px;
      text-align: center;
    }

    .empty-state-icon {
      font-size: 3rem;
      color: var(--text-secondary-light);
      margin-bottom: 15px;
      opacity: 0.5;
    }

    body.dark .empty-state-icon {
      color: var(--text-secondary-dark);
    }

    .empty-state-text {
      font-size: 1.2rem;
      color: var(--text-secondary-light);
      margin-bottom: 20px;
    }

    body.dark .empty-state-text {
      color: var(--text-secondary-dark);
    }

    /* alert messages */
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .alert-success {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.3);
      color: var(--success-color);
    }

    .alert-danger {
      background: rgba(220, 53, 69, 0.1);
      border: 1px solid rgba(220, 53, 69, 0.3);
      color: var(--danger-color);
    }

    .alert-warning {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      color: #856404;
    }

    .alert-info {
      background: rgba(0, 123, 255, 0.1);
      border: 1px solid rgba(0, 123, 255, 0.3);
      color: var(--primary-color);
    }

    /* user profile */
    .user-profile {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px;
      background: rgba(0, 123, 255, 0.05);
      border-radius: 10px;
    }

    body.dark .user-profile {
      background: rgba(0, 123, 255, 0.1);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      margin-right: 10px;
    }

    .user-info {
      flex: 1;
      text-align: left;
    }

    .user-email {
      font-size: 0.9rem;
      color: var(--text-secondary-light);
    }

    body.dark .user-email {
      color: var(--text-secondary-dark);
    }

    /* responsive design improvements */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
        max-height: 90vh;
      }

      h1 {
        font-size: 1.8em;
      }

      h2 {
        font-size: 1.3em;
      }

      .back-to-home {
        top: 15px;
        left: 15px;
        padding: 10px 15px;
        font-size: 0.9em;
      }

      .toggle-btn {
        top: 15px;
        right: 15px;
        width: 45px;
        height: 45px;
        font-size: 1.1em;
      }

      .password-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .password-actions {
        margin-top: 10px;
        align-self: flex-end;
      }

      .options-container {
        grid-template-columns: 1fr;
      }
    }

    /* animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }

    /* password visibility toggle */
    .password-field {
      position: relative;
    }

    .toggle-password {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-secondary-light);
      cursor: pointer;
      font-size: 1.1rem;
    }

    body.dark .toggle-password {
      color: var(--text-secondary-dark);
    }

    /* loader */
    .loader {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid rgba(0, 123, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    .loader-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
    }

    .loader-text {
      margin-top: 15px;
      color: var(--text-secondary-light);
      font-weight: 500;
    }

    body.dark .loader-text {
      color: var(--text-secondary-dark);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* tooltip styles */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }

    .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.85rem;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .tooltip-text::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* master password setup section */
    .master-password-setup {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: rgba(0, 123, 255, 0.05);
      border-radius: 10px;
    }

    body.dark .master-password-setup {
      background: rgba(0, 123, 255, 0.1);
    }
  </style>
</head>
<body>
  <!-- floating particles background -->
  <div class="particles-container" id="particlesContainer"></div>

  <!-- theme toggle button -->
  <button class="toggle-btn" id="theme-toggle" aria-label="Toggle Theme">üåô</button>

  <!-- back to home link -->
  <a href="https://finn1817.github.io/Main-Website/" class="back-to-home">‚Üê Back to Home</a>
  
  <div class="container">
    <!-- Authentication Screen -->
    <div id="auth-screen" class="auth-screen fade-in">
      <h1>Secure Password Vault</h1>
      
      <div class="security-badge">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        Firebase Authentication
      </div>
      
      <p>Your passwords are securely encrypted and stored in the cloud. Access them from any device.</p>
      
      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">Login</div>
        <div class="auth-tab" data-tab="signup">Sign Up</div>
      </div>
      
      <!-- Login Form -->
      <div id="login-content" class="auth-content active">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" placeholder="Enter your email">
        </div>
        
        <div class="form-group password-field">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" placeholder="Enter your password">
          <button type="button" class="toggle-password" id="toggle-login-password">üëÅÔ∏è</button>
        </div>
        
        <div id="login-error" class="alert alert-danger" style="display: none;"></div>
        
        <button id="login-btn" class="btn btn-primary btn-block">Login</button>
        
        <p style="margin-top: 15px; font-size: 0.9rem;">
          <a href="#" id="forgot-password-link">Forgot your password?</a>
        </p>
      </div>
      
      <!-- Sign Up Form -->
      <div id="signup-content" class="auth-content">
        <div class="form-group">
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" placeholder="Enter your email">
        </div>
        
        <div class="form-group password-field">
          <label for="signup-password">Password</label>
          <input type="password" id="signup-password" placeholder="Choose a strong password">
          <button type="button" class="toggle-password" id="toggle-signup-password">üëÅÔ∏è</button>
        </div>
        
        <div class="password-strength">
          <div class="strength-meter">
            <div class="strength-meter-fill" id="signup-password-strength-meter"></div>
          </div>
          <div class="strength-text" id="signup-password-strength-text"></div>
        </div>
        
        <div class="form-group password-field">
          <label for="confirm-password">Confirm Password</label>
          <input type="password" id="confirm-password" placeholder="Confirm your password">
          <button type="button" class="toggle-password" id="toggle-confirm-password">üëÅÔ∏è</button>
        </div>
        
        <div id="signup-error" class="alert alert-danger" style="display: none;"></div>
        
        <button id="signup-btn" class="btn btn-success btn-block">Create Account</button>
      </div>
      
      <!-- Password Reset Form -->
      <div id="reset-password-content" class="auth-content">
        <h2>Reset Password</h2>
        <p>Enter your email address and we'll send you a link to reset your password.</p>
        
        <div class="form-group">
          <label for="reset-email">Email</label>
          <input type="email" id="reset-email" placeholder="Enter your email">
        </div>
        
        <div id="reset-message" class="alert alert-info" style="display: none;"></div>
        
        <button id="reset-password-btn" class="btn btn-primary btn-block">Send Reset Link</button>
        
        <p style="margin-top: 15px;">
          <a href="#" id="back-to-login-link">Back to Login</a>
        </p>
      </div>
      
      <!-- Loading State -->
      <div id="auth-loading" style="display: none;" class="loader-container">
        <div class="loader"></div>
        <div class="loader-text">Authenticating...</div>
      </div>
    </div>
    
    <!-- Master Password Setup (after first sign-in) -->
    <div id="master-password-setup" class="master-password-setup fade-in">
      <h1>Set Up Your Master Password</h1>
      
      <div class="security-badge">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        AES-256 Encryption
      </div>
      
      <p>Create a master password to encrypt your vault. This password is separate from your account password and is used to encrypt your data.</p>
      <p><strong>Important:</strong> This password is never stored anywhere. If you forget it, your data cannot be recovered.</p>
      
      <div class="form-group password-field">
        <label for="master-password">Master Password</label>
        <input type="password" id="master-password" placeholder="Create a strong master password">
        <button type="button" class="toggle-password" id="toggle-master-password">üëÅÔ∏è</button>
      </div>
      
      <div class="form-group password-field">
        <label for="confirm-master-password">Confirm Master Password</label>
        <input type="password" id="confirm-master-password" placeholder="Confirm your master password">
        <button type="button" class="toggle-password" id="toggle-confirm-master">üëÅÔ∏è</button>
      </div>
      
      <div class="password-strength">
        <div class="strength-meter">
          <div class="strength-meter-fill" id="master-password-strength-meter"></div>
        </div>
        <div class="strength-text" id="master-password-strength-text"></div>
      </div>
      
      <div id="master-password-error" class="alert alert-danger" style="display: none;"></div>
      
      <button id="create-vault-btn" class="btn btn-success btn-block">Create Secure Vault</button>
    </div>
    
    <!-- Unlock Vault (for returning users) -->
    <div id="unlock-vault" class="master-password-setup fade-in">
      <h1>Unlock Your Vault</h1>
      
      <div class="security-badge">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        AES-256 Encryption
      </div>
      
      <p>Enter your master password to decrypt your vault.</p>
      
      <div class="form-group password-field">
        <label for="unlock-master-password">Master Password</label>
        <input type="password" id="unlock-master-password" placeholder="Enter your master password">
        <button type="button" class="toggle-password" id="toggle-unlock-password">üëÅÔ∏è</button>
      </div>
      
      <div id="unlock-error" class="alert alert-danger" style="display: none;">
        Incorrect master password. Please try again.
      </div>
      
      <button id="unlock-vault-btn" class="btn btn-primary btn-block">Unlock Vault</button>
      
      <p style="margin-top: 20px; font-size: 0.9rem;">
        <span class="tooltip">
          Forgot your master password?
          <span class="tooltip-text">Since your data is encrypted with your master password, we cannot recover it. You'll need to reset your vault and start over.</span>
        </span>
        <button id="reset-vault-btn" class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem; margin-left: 10px;">Reset Vault</button>
      </p>
    </div>
    
    <!-- Main App (Hidden initially) -->
    <div id="app-container" class="app-container">
      <h1>Password Vault</h1>
      
      <div class="user-profile">
        <div class="user-avatar" id="user-avatar">U</div>
        <div class="user-info">
          <div class="user-name" id="user-name">User</div>
          <div class="user-email" id="user-email">user@example.com</div>
        </div>
        <button id="sign-out-btn" class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem;">Sign Out</button>
      </div>
      
      <div class="security-badge">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        AES-256 Encryption
      </div>
      
      <div class="tabs">
        <div class="tab active" data-tab="passwords">Saved Passwords</div>
        <div class="tab" data-tab="generator">Password Generator</div>
        <div class="tab" data-tab="settings">Settings</div>
      </div>
      
      <!-- Passwords Tab -->
      <div id="passwords-tab" class="tab-content active">
        <div class="password-generator">
          <h2>Add New Password</h2>
          
          <div class="form-group">
            <label for="website">Website or Service</label>
            <input type="text" id="website" placeholder="e.g., Facebook, Gmail, Twitter">
          </div>
          
          <div class="form-group">
            <label for="username">Username or Email</label>
            <input type="text" id="username" placeholder="Your username or email for this site">
          </div>
          
          <div class="form-group password-field">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Enter password or generate one">
            <button type="button" class="toggle-password" id="toggle-add-password">üëÅÔ∏è</button>
          </div>
          
          <div class="password-strength">
            <div class="strength-meter">
              <div class="strength-meter-fill" id="add-password-strength-meter"></div>
            </div>
            <div class="strength-text" id="add-password-strength-text"></div>
          </div>
          
          <div class="btn-group">
            <button id="generate-for-site-btn" class="btn">Generate Password</button>
            <button id="add-password-btn" class="btn btn-success">Save Password</button>
          </div>
        </div>
        
        <h2>Your Saved Passwords</h2>
        
        <div id="password-list" class="password-list">
          <!-- Password items will be added here dynamically -->
          <div class="empty-state" id="empty-passwords">
            <div class="empty-state-icon">üîê</div>
            <div class="empty-state-text">No passwords saved yet</div>
            <p>Your saved passwords will appear here. Add your first password using the form above.</p>
          </div>
        </div>
      </div>
      
      <!-- Generator Tab -->
      <div id="generator-tab" class="tab-content">
        <h2>Generate Secure Password</h2>
        <p>Create strong, random passwords that are difficult to crack.</p>
        
        <div class="generated-password" id="generated-password">
          Click "Generate" to create a password
          <button id="copy-generated" class="copy-btn">Copy</button>
        </div>
        
        <div class="password-strength">
          <div class="strength-meter">
            <div class="strength-meter-fill" id="generated-password-strength-meter"></div>
          </div>
          <div class="strength-text" id="generated-password-strength-text"></div>
        </div>
        
        <div class="slider-container">
          <label for="password-length">
            Length: <span id="length-value">16</span> characters
          </label>
          <input type="range" min="8" max="64" value="16" class="slider" id="password-length">
        </div>
        
        <div class="options-container">
          <div class="checkbox-group">
            <input type="checkbox" id="include-uppercase" checked>
            <label for="include-uppercase">Include Uppercase</label>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="include-lowercase" checked>
            <label for="include-lowercase">Include Lowercase</label>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="include-numbers" checked>
            <label for="include-numbers">Include Numbers</label>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="include-symbols" checked>
            <label for="include-symbols">Include Symbols</label>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="exclude-similar">
            <label for="exclude-similar">Exclude Similar Characters</label>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="exclude-ambiguous">
            <label for="exclude-ambiguous">Exclude Ambiguous Symbols</label>
          </div>
        </div>
        
        <button id="generate-password-btn" class="btn btn-primary btn-block">Generate Password</button>
        
        <div class="alert alert-info" style="margin-top: 20px; font-size: 0.9rem;">
          <strong>Password Strength Explained:</strong><br>
          Very Weak: Easily guessable<br>
          Weak: Could be cracked with simple tools<br>
          Medium: Resistant to simple attacks<br>
          Strong: Difficult to crack with current technology<br>
          Very Strong: Would require significant resources to crack
        </div>
      </div>
      
      <!-- Settings Tab -->
      <div id="settings-tab" class="tab-content">
        <h2>Settings</h2>
        
        <div class="form-group">
          <label for="auto-logout">Auto Logout After</label>
          <select id="auto-logout" class="form-control">
            <option value="0">Never</option>
            <option value="1">1 minute</option>
            <option value="5" selected>5 minutes</option>
            <option value="15">15 minutes</option>
            <option value="30">30 minutes</option>
            <option value="60">1 hour</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="default-password-length">Default Password Length</label>
          <select id="default-password-length" class="form-control">
            <option value="8">8 characters</option>
            <option value="12">12 characters</option>
            <option value="16" selected>16 characters</option>
            <option value="20">20 characters</option>
            <option value="24">24 characters</option>
            <option value="32">32 characters</option>
          </select>
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="clear-clipboard" checked>
          <label for="clear-clipboard">Clear clipboard after 30 seconds</label>
        </div>
        
        <h2>Security</h2>
        
        <div class="form-group password-field">
          <label for="change-master-password">Change Master Password</label>
          <input type="password" id="change-master-password" placeholder="Enter new master password">
          <button type="button" class="toggle-password" id="toggle-change-password">üëÅÔ∏è</button>
        </div>
        
        <div class="password-strength">
          <div class="strength-meter">
            <div class="strength-meter-fill" id="change-password-strength-meter"></div>
          </div>
          <div class="strength-text" id="change-password-strength-text"></div>
        </div>
        
        <button id="update-master-password-btn" class="btn btn-primary">Update Master Password</button>
        
        <div class="form-group" style="margin-top: 30px;">
          <button id="export-data-btn" class="btn btn-warning">Export Encrypted Data</button>
          <p style="font-size: 0.9rem; margin-top: 5px;">Export your encrypted password database for backup purposes.</p>
        </div>
        
        <div class="form-group">
          <button id="import-data-btn" class="btn btn-warning">Import Encrypted Data</button>
          <p style="font-size: 0.9rem; margin-top: 5px;">Import a previously exported encrypted database.</p>
        </div>
        
        <div class="form-group" style="margin-top: 30px;">
          <button id="lock-vault-btn" class="btn btn-primary">Lock Vault</button>
          <p style="font-size: 0.9rem; margin-top: 5px;">Lock your vault to protect your passwords.</p>
        </div>
        
        <div class="form-group">
          <button id="clear-data-btn" class="btn btn-danger">Clear All Data</button>
          <p style="font-size: 0.9rem; margin-top: 5px;">Permanently delete all saved passwords and reset the vault.</p>
        </div>
        
        <h2>Account</h2>
        
        <div class="form-group">
          <button id="change-account-password-btn" class="btn btn-primary">Change Account Password</button>
          <p style="font-size: 0.9rem; margin-top: 5px;">Change the password you use to sign in to your account.</p>
        </div>
        
        <div class="form-group">
          <button id="delete-account-btn" class="btn btn-danger">Delete Account</button>
          <p style="font-size: 0.9rem; margin-top: 5px;">Permanently delete your account and all associated data.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIza8yb_MP0NA6zHN48KU1oKAVP8q_VK4oGTGM",
        authDomain: "password-manager-2adbf.firebaseapp.com",
        projectId: "password-manager-2adbf",
        storageBucket: "password-manager-2adbf.firebasestorage.app",
        messagingSenderId: "825116138544",
        appId: "1:825116138544:web:c6795763a8dff3724a1f5",
        measurementId: "G-1SHX7OWEK4"
      };

      
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      
      // DOM elements
      const toggleBtn = document.getElementById("theme-toggle");
      const body = document.body;
      
      // Auth elements
      const authScreen = document.getElementById("auth-screen");
      const authTabs = document.querySelectorAll(".auth-tab");
      const authContents = document.querySelectorAll(".auth-content");
      const loginContent = document.getElementById("login-content");
      const signupContent = document.getElementById("signup-content");
      const resetPasswordContent = document.getElementById("reset-password-content");
      const authLoading = document.getElementById("auth-loading");
      
      // Login elements
      const loginEmail = document.getElementById("login-email");
      const loginPassword = document.getElementById("login-password");
      const loginBtn = document.getElementById("login-btn");
      const loginError = document.getElementById("login-error");
      const forgotPasswordLink = document.getElementById("forgot-password-link");
      
      // Signup elements
      const signupEmail = document.getElementById("signup-email");
      const signupPassword = document.getElementById("signup-password");
      const confirmPassword = document.getElementById("confirm-password");
      const signupBtn = document.getElementById("signup-btn");
      const signupError = document.getElementById("signup-error");
      const signupPasswordStrengthMeter = document.getElementById("signup-password-strength-meter");
      const signupPasswordStrengthText = document.getElementById("signup-password-strength-text");
      
      // Reset password elements
      const resetEmail = document.getElementById("reset-email");
      const resetPasswordBtn = document.getElementById("reset-password-btn");
      const resetMessage = document.getElementById("reset-message");
      const backToLoginLink = document.getElementById("back-to-login-link");
      
      // Master password setup elements
      const masterPasswordSetup = document.getElementById("master-password-setup");
      const masterPasswordInput = document.getElementById("master-password");
      const confirmMasterPasswordInput = document.getElementById("confirm-master-password");
      const createVaultBtn = document.getElementById("create-vault-btn");
      const masterPasswordError = document.getElementById("master-password-error");
      const masterPasswordStrengthMeter = document.getElementById("master-password-strength-meter");
      const masterPasswordStrengthText = document.getElementById("master-password-strength-text");
      
      // Unlock vault elements
      const unlockVault = document.getElementById("unlock-vault");
      const unlockMasterPasswordInput = document.getElementById("unlock-master-password");
      const unlockVaultBtn = document.getElementById("unlock-vault-btn");
      const unlockError = document.getElementById("unlock-error");
      const resetVaultBtn = document.getElementById("reset-vault-btn");
      
      // Main app elements
      const appContainer = document.getElementById("app-container");
      const userAvatar = document.getElementById("user-avatar");
      const userName = document.getElementById("user-name");
      const userEmail = document.getElementById("user-email");
      const signOutBtn = document.getElementById("sign-out-btn");
      const tabs = document.querySelectorAll(".tab");
      const tabContents = document.querySelectorAll(".tab-content");
      
      // Password tab elements
      const websiteInput = document.getElementById("website");
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const addPasswordBtn = document.getElementById("add-password-btn");
      const generateForSiteBtn = document.getElementById("generate-for-site-btn");
      const passwordList = document.getElementById("password-list");
      const emptyPasswords = document.getElementById("empty-passwords");
      const addPasswordStrengthMeter = document.getElementById("add-password-strength-meter");
      const addPasswordStrengthText = document.getElementById("add-password-strength-text");
      
      // Generator tab elements
      const passwordLengthSlider = document.getElementById("password-length");
      const passwordLengthValue = document.getElementById("length-value");
      const includeUppercase = document.getElementById("include-uppercase");
      const includeLowercase = document.getElementById("include-lowercase");
      const includeNumbers = document.getElementById("include-numbers");
      const includeSymbols = document.getElementById("include-symbols");
      const excludeSimilar = document.getElementById("exclude-similar");
      const excludeAmbiguous = document.getElementById("exclude-ambiguous");
      const generatePasswordBtn = document.getElementById("generate-password-btn");
      const generatedPassword = document.getElementById("generated-password");
      const copyGeneratedBtn = document.getElementById("copy-generated");
      const generatedPasswordStrengthMeter = document.getElementById("generated-password-strength-meter");
      const generatedPasswordStrengthText = document.getElementById("generated-password-strength-text");
      
      // Settings tab elements
      const autoLogoutSelect = document.getElementById("auto-logout");
      const defaultPasswordLengthSelect = document.getElementById("default-password-length");
      const clearClipboardCheckbox = document.getElementById("clear-clipboard");
      const changeMasterPasswordInput = document.getElementById("change-master-password");
      const updateMasterPasswordBtn = document.getElementById("update-master-password-btn");
      const exportDataBtn = document.getElementById("export-data-btn");
      const importDataBtn = document.getElementById("import-data-btn");
      const lockVaultBtn = document.getElementById("lock-vault-btn");
      const clearDataBtn = document.getElementById("clear-data-btn");
      const changeAccountPasswordBtn = document.getElementById("change-account-password-btn");
      const deleteAccountBtn = document.getElementById("delete-account-btn");
      const changePasswordStrengthMeter = document.getElementById("change-password-strength-meter");
      const changePasswordStrengthText = document.getElementById("change-password-strength-text");
      
      // Password toggles
      const toggleLoginPassword = document.getElementById("toggle-login-password");
      const toggleSignupPassword = document.getElementById("toggle-signup-password");
      const toggleConfirmPassword = document.getElementById("toggle-confirm-password");
      const toggleMasterPassword = document.getElementById("toggle-master-password");
      const toggleConfirmMaster = document.getElementById("toggle-confirm-master");
      const toggleUnlockPassword = document.getElementById("toggle-unlock-password");
      const toggleAddPassword = document.getElementById("toggle-add-password");
      const toggleChangePassword = document.getElementById("toggle-change-password");
      
      // Application state
      let currentUser = null;
      let encryptionKey = '';
      let autoLogoutTimer = null;
      let passwords = [];
      let settings = {
        autoLogout: 5,
        defaultPasswordLength: 16,
        clearClipboard: true
      };
      let vaultExists = false;

      // Create floating particles
      function createParticle() {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        const size = Math.random() * 8 + 3;
        const left = Math.random() * 100;
        const duration = Math.random() * 15 + 15;
        
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        particle.style.left = left + '%';
        particle.style.animationDuration = duration + 's';
        particle.style.opacity = Math.random() * 0.2 + 0.05;
        
        document.getElementById('particlesContainer').appendChild(particle);
        
        setTimeout(() => {
          particle.remove();
        }, duration * 1000);
      }

      // Generate particles periodically
      setInterval(createParticle, 800);

      // Apply saved theme or system preference
      const savedTheme = localStorage.getItem("theme");
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (savedTheme === "dark" || (!savedTheme && prefersDark)) {
        body.classList.add("dark");
        toggleBtn.textContent = "‚òÄÔ∏è";
      } else {
        toggleBtn.textContent = "üåô";
      }

      // Toggle theme listener
      toggleBtn.addEventListener("click", () => {
        const isDark = body.classList.toggle("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        toggleBtn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      });

      // Auth tab switching
      authTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Hide all auth contents
          authContents.forEach(content => {
            content.classList.remove('active');
          });
          
          // Remove active class from all tabs
          authTabs.forEach(t => {
            t.classList.remove('active');
          });
          
          // Add active class to clicked tab
          tab.classList.add('active');
          
          // Show corresponding content
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(`${tabId}-content`).classList.add('active');
        });
      });

      // Forgot password link
      forgotPasswordLink.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Hide login content
        loginContent.classList.remove('active');
        
        // Show reset password content
        resetPasswordContent.classList.add('active');
        
        // Set reset email to login email
        resetEmail.value = loginEmail.value;
      });

      // Back to login link
      backToLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        
        // Hide reset password content
        resetPasswordContent.classList.remove('active');
        
        // Show login content
        loginContent.classList.add('active');
      });

      // Password strength checker
      function getPasswordStrength(password) {
        let score = 0;
        let feedback = "";
        
        if (!password) {
          return { score: 0, feedback: "Enter a password" };
        }
        
        // Length check
        if (password.length < 8) {
          score = 0;
          feedback = "Too short";
        } else if (password.length < 12) {
          score += 1;
        } else if (password.length < 16) {
          score += 2;
        } else {
          score += 3;
        }
        
        // Character variety checks
        if (/[A-Z]/.test(password)) score += 1;
        if (/[a-z]/.test(password)) score += 1;
        if (/[0-9]/.test(password)) score += 1;
        if (/[^A-Za-z0-9]/.test(password)) score += 1;
        
        // Repeated characters
        if (/(.)\1\1/.test(password)) score -= 1;
        
        // Sequential characters
        if (/(?:abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|012|123|234|345|456|567|678|789)/.test(password.toLowerCase())) {
          score -= 1;
        }
        
        // Common words/patterns check
        const commonPatterns = ['password', '123456', 'qwerty', 'admin', 'welcome', 'letmein', 'monkey', 'abc123'];
        for (const pattern of commonPatterns) {
          if (password.toLowerCase().includes(pattern)) {
            score -= 2;
            break;
          }
        }
        
        // Clamp score to 0-4 range
        score = Math.max(0, Math.min(score, 4));
        
        // Generate feedback based on score
        switch (score) {
          case 0:
            feedback = "Very weak - easily guessable";
            break;
          case 1:
            feedback = "Weak - vulnerable to attacks";
            break;
          case 2:
            feedback = "Medium - could be stronger";
            break;
          case 3:
            feedback = "Strong - good protection";
            break;
          case 4:
            feedback = "Very strong - excellent protection";
            break;
        }
        
        return { score, feedback };
      }

      // Update password strength meter
      function updateStrengthMeter(password, meterElement, textElement) {
        const { score, feedback } = getPasswordStrength(password);
        
        // Update meter width and color
        let strengthClass = '';
        switch (score) {
          case 0:
            strengthClass = 'strength-very-weak';
            break;
          case 1:
            strengthClass = 'strength-weak';
            break;
          case 2:
            strengthClass = 'strength-medium';
            break;
          case 3:
            strengthClass = 'strength-strong';
            break;
          case 4:
            strengthClass = 'strength-very-strong';
            break;
        }
        
        // Remove all strength classes
        meterElement.classList.remove('strength-very-weak', 'strength-weak', 'strength-medium', 'strength-strong', 'strength-very-strong');
        
        // Add current strength class
        meterElement.classList.add(strengthClass);
        
        // Update text
        textElement.textContent = feedback;
      }

      // Password visibility toggle functionality
      function setupPasswordToggle(inputId, toggleId) {
        const input = document.getElementById(inputId);
        const toggle = document.getElementById(toggleId);
        
        toggle.addEventListener('click', () => {
          if (input.type === 'password') {
            input.type = 'text';
            toggle.textContent = 'üîí';
          } else {
            input.type = 'password';
            toggle.textContent = 'üëÅÔ∏è';
          }
        });
      }

      // Setup password toggles
      setupPasswordToggle('login-password', 'toggle-login-password');
      setupPasswordToggle('signup-password', 'toggle-signup-password');
      setupPasswordToggle('confirm-password', 'toggle-confirm-password');
      setupPasswordToggle('master-password', 'toggle-master-password');
      setupPasswordToggle('confirm-master-password', 'toggle-confirm-master');
      setupPasswordToggle('unlock-master-password', 'toggle-unlock-password');
      setupPasswordToggle('password', 'toggle-add-password');
      setupPasswordToggle('change-master-password', 'toggle-change-password');

      // Password strength listeners
      signupPassword.addEventListener('input', () => {
        updateStrengthMeter(signupPassword.value, signupPasswordStrengthMeter, signupPasswordStrengthText);
      });

      masterPasswordInput.addEventListener('input', () => {
        updateStrengthMeter(masterPasswordInput.value, masterPasswordStrengthMeter, masterPasswordStrengthText);
      });

      passwordInput.addEventListener('input', () => {
        updateStrengthMeter(passwordInput.value, addPasswordStrengthMeter, addPasswordStrengthText);
      });

      changeMasterPasswordInput.addEventListener('input', () => {
        updateStrengthMeter(changeMasterPasswordInput.value, changePasswordStrengthMeter, changePasswordStrengthText);
      });

      // Tab switching functionality
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs
          tabs.forEach(t => t.classList.remove('active'));
          
          // Add active class to clicked tab
          tab.classList.add('active');
          
          // Hide all tab contents
          tabContents.forEach(content => content.classList.remove('active'));
          
          // Show corresponding tab content
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(`${tabId}-tab`).classList.add('active');
        });
      });

      // Generate random password
      function generatePassword() {
        const length = parseInt(passwordLengthSlider.value);
        const useUpper = includeUppercase.checked;
        const useLower = includeLowercase.checked;
        const useNumbers = includeNumbers.checked;
        const useSymbols = includeSymbols.checked;
        const avoidSimilar = excludeSimilar.checked;
        const avoidAmbiguous = excludeAmbiguous.checked;
        
        // Character sets
        let upperChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let lowerChars = 'abcdefghijklmnopqrstuvwxyz';
        let numberChars = '0123456789';
        let symbolChars = '!@#$%^&*()_+-=[]{}|;:,.<>?';
        
        // Apply filters
        if (avoidSimilar) {
          upperChars = upperChars.replace(/[IO]/g, '');
          lowerChars = lowerChars.replace(/[l]/g, '');
          numberChars = numberChars.replace(/[01]/g, '');
        }
        
        if (avoidAmbiguous) {
          symbolChars = symbolChars.replace(/[{}[\]()/\\'"~,;.<>]/g, '');
        }
        
        // Build character pool
        let charPool = '';
        if (useUpper) charPool += upperChars;
        if (useLower) charPool += lowerChars;
        if (useNumbers) charPool += numberChars;
        if (useSymbols) charPool += symbolChars;
        
        // Fallback if nothing selected
        if (charPool === '') {
          charPool = lowerChars + numberChars;
        }
        
        // Generate password
        let password = '';
        const charPoolLength = charPool.length;
        
        // Ensure we have at least one character from each selected character set
        if (useUpper) password += upperChars.charAt(Math.floor(Math.random() * upperChars.length));
        if (useLower) password += lowerChars.charAt(Math.floor(Math.random() * lowerChars.length));
        if (useNumbers) password += numberChars.charAt(Math.floor(Math.random() * numberChars.length));
        if (useSymbols) password += symbolChars.charAt(Math.floor(Math.random() * symbolChars.length));
        
        // Fill the rest randomly
        while (password.length < length) {
          password += charPool.charAt(Math.floor(Math.random() * charPoolLength));
        }
        
        // Shuffle the password
        password = password.split('').sort(() => 0.5 - Math.random()).join('');
        
        // Trim to exact length (in case we added too many required characters)
        password = password.substring(0, length);
        
        return password;
      }

      // Copy password to clipboard
      function copyPassword(password) {
        navigator.clipboard.writeText(password).then(() => {
          // Show feedback
          const feedback = document.createElement('div');
          feedback.className = 'alert alert-success';
          feedback.style.position = 'fixed';
          feedback.style.bottom = '20px';
          feedback.style.right = '20px';
          feedback.style.zIndex = '1000';
          feedback.style.padding = '10px 20px';
          feedback.textContent = 'Password copied to clipboard';
          document.body.appendChild(feedback);
          
          // Remove feedback after 2 seconds
          setTimeout(() => {
            feedback.style.opacity = '0';
            setTimeout(() => {
              document.body.removeChild(feedback);
            }, 300);
          }, 2000);
          
          // Auto-clear clipboard if enabled
          if (settings.clearClipboard) {
            setTimeout(() => {
              navigator.clipboard.writeText('');
            }, 30000);
          }
        }).catch(err => {
          console.error('Could not copy password: ', err);
          alert('Failed to copy password to clipboard');
        });
      }

      // Setup auto logout timer
      function setupAutoLogout() {
        // Clear existing timer
        if (autoLogoutTimer) {
          clearTimeout(autoLogoutTimer);
        }
        
        // If auto logout is enabled
        if (settings.autoLogout > 0) {
          autoLogoutTimer = setTimeout(() => {
            lockVault();
          }, settings.autoLogout * 60 * 1000);
        }
      }

      // Reset auto logout timer (on user activity)
      function resetAutoLogout() {
        setupAutoLogout();
      }

      // Create a hash from the master password
      async function hashMasterPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      }

      // Derive encryption key from master password
      async function deriveEncryptionKey(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hashBuffer))
          .map(b => b.toString(16).padStart(2, '0'))
          .join('');
      }

      // Encrypt data with the encryption key
      function encryptData(data, key) {
        return CryptoJS.AES.encrypt(JSON.stringify(data), key).toString();
      }

      // Decrypt data with the encryption key
      function decryptData(ciphertext, key) {
        try {
          const bytes = CryptoJS.AES.decrypt(ciphertext, key);
          const decryptedData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
          return decryptedData;
        } catch (error) {
          console.error('Decryption failed:', error);
          return null;
        }
      }

      // Save passwords to Firestore
      async function savePasswords() {
        if (!currentUser) return;
        
        try {
          const encryptedData = encryptData(passwords, encryptionKey);
          await db.collection('vaults').doc(currentUser.uid).update({
            passwords: encryptedData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (error) {
          console.error('Error saving passwords:', error);
          alert('Failed to save passwords. Please try again.');
        }
      }

      // Save settings to Firestore
      async function saveSettings() {
        if (!currentUser) return;
        
        try {
          const encryptedSettings = encryptData(settings, encryptionKey);
          await db.collection('vaults').doc(currentUser.uid).update({
            settings: encryptedSettings,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Apply auto logout setting
          setupAutoLogout();
        } catch (error) {
          console.error('Error saving settings:', error);
          alert('Failed to save settings. Please try again.');
        }
      }

      // Add password to vault
      async function addPassword() {
        const website = websiteInput.value.trim();
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        
        if (!website) {
          alert("Please enter a website or service name.");
          websiteInput.focus();
          return;
        }
        
        if (!password) {
          alert("Please enter a password or generate one.");
          passwordInput.focus();
          return;
        }
        
        // Create password object
        const newPassword = {
          id: Date.now().toString(),
          website,
          username,
          password,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        // Add to passwords array
        passwords.push(newPassword);
        
        // Save to Firestore
        await savePasswords();
        
        // Update UI
        renderPasswordList();
        
        // Clear form
        websiteInput.value = '';
        usernameInput.value = '';
        passwordInput.value = '';
        updateStrengthMeter('', addPasswordStrengthMeter, addPasswordStrengthText);
        
        // Focus on website input for next entry
        websiteInput.focus();
      }

      // Delete password from vault
      async function deletePassword(id) {
        if (confirm("Are you sure you want to delete this password?")) {
          passwords = passwords.filter(p => p.id !== id);
          await savePasswords();
          renderPasswordList();
        }
      }

      // Edit password
      function editPassword(id) {
        const password = passwords.find(p => p.id === id);
        
        if (password) {
          // Fill form with password details
          websiteInput.value = password.website;
          usernameInput.value = password.username || '';
          passwordInput.value = password.password;
          updateStrengthMeter(password.password, addPasswordStrengthMeter, addPasswordStrengthText);
          
          // Remove password from list (will be re-added when saved)
          passwords = passwords.filter(p => p.id !== id);
          savePasswords();
          renderPasswordList();
          
          // Focus on website input
          websiteInput.focus();
        }
      }

      // Render password list
      function renderPasswordList() {
        // Sort passwords alphabetically by website
        passwords.sort((a, b) => a.website.localeCompare(b.website));
        
        // Check if passwords list is empty
        if (passwords.length === 0) {
          passwordList.innerHTML = '';
          passwordList.appendChild(emptyPasswords);
          return;
        }
        
        // Hide empty state
        passwordList.innerHTML = '';
        
        // Create password items
        passwords.forEach(password => {
          const passwordItem = document.createElement('div');
          passwordItem.className = 'password-item';
          
          const passwordInfo = document.createElement('div');
          passwordInfo.className = 'password-info';
          
          const websiteName = document.createElement('div');
          websiteName.className = 'website-name';
          websiteName.textContent = password.website;
          
          const username = document.createElement('div');
          username.className = 'username';
          username.textContent = password.username || 'No username';
          
          passwordInfo.appendChild(websiteName);
          passwordInfo.appendChild(username);
          
          const passwordActions = document.createElement('div');
          passwordActions.className = 'password-actions';
          
          const viewBtn = document.createElement('button');
          viewBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>';
          viewBtn.title = 'View Password';
          viewBtn.addEventListener('click', () => {
            alert(`Password for ${password.website}:\n${password.password}`);
          });
          
          const copyBtn = document.createElement('button');
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>';
          copyBtn.title = 'Copy Password';
          copyBtn.addEventListener('click', () => {
            copyPassword(password.password);
          });
          
          const editBtn = document.createElement('button');
          editBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>';
          editBtn.title = 'Edit Password';
          editBtn.addEventListener('click', () => {
            editPassword(password.id);
          });
          
          const deleteBtn = document.createElement('button');
          deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>';
          deleteBtn.title = 'Delete Password';
          deleteBtn.addEventListener('click', () => {
            deletePassword(password.id);
          });
          
          passwordActions.appendChild(viewBtn);
          passwordActions.appendChild(copyBtn);
          passwordActions.appendChild(editBtn);
          passwordActions.appendChild(deleteBtn);
          
          passwordItem.appendChild(passwordInfo);
          passwordItem.appendChild(passwordActions);
          
          passwordList.appendChild(passwordItem);
        });
      }

      // Check if vault exists for user
      async function checkVaultExists(userId) {
        try {
          const docRef = db.collection('vaults').doc(userId);
          const doc = await docRef.get();
          
          return doc.exists;
        } catch (error) {
          console.error('Error checking if vault exists:', error);
          return false;
        }
      }

      // Create vault with master password
      async function createVault() {
        const masterPassword = masterPasswordInput.value;
        const confirmPassword = confirmMasterPasswordInput.value;
        
        if (masterPassword !== confirmPassword) {
          masterPasswordError.textContent = "Passwords do not match!";
          masterPasswordError.style.display = "block";
          return;
        }
        
        if (getPasswordStrength(masterPassword).score < 2) {
          if (!confirm("Your master password is weak. This puts all your passwords at risk. Are you sure you want to continue?")) {
            return;
          }
        }
        
        try {
          // Show loading
          masterPasswordError.style.display = "none";
          createVaultBtn.disabled = true;
          createVaultBtn.innerHTML = '<div class="loader" style="width: 20px; height: 20px; margin-right: 10px;"></div> Creating vault...';
          
          // Generate master password hash
          const masterPasswordHash = await hashMasterPassword(masterPassword);
          
          // Derive encryption key
          encryptionKey = await deriveEncryptionKey(masterPassword);
          
          // Initialize empty vault
          passwords = [];
          
          // Encrypt empty passwords array
          const encryptedPasswords = encryptData(passwords, encryptionKey);
          
          // Encrypt settings
          const encryptedSettings = encryptData(settings, encryptionKey);
          
          // Create vault document in Firestore
          await db.collection('vaults').doc(currentUser.uid).set({
            masterPasswordHash,
            passwords: encryptedPasswords,
            settings: encryptedSettings,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Show app
          masterPasswordSetup.style.display = "none";
          appContainer.style.display = "block";
          
          // Setup auto logout
          setupAutoLogout();
          
          // Add activity listeners for auto logout
          document.addEventListener('click', resetAutoLogout);
          document.addEventListener('keypress', resetAutoLogout);
          
          // Update UI
          renderPasswordList();
          
        } catch (error) {
          console.error('Error creating vault:', error);
          masterPasswordError.textContent = "Failed to create vault. Please try again.";
          masterPasswordError.style.display = "block";
        } finally {
          createVaultBtn.disabled = false;
          createVaultBtn.textContent = "Create Secure Vault";
        }
      }

      // Unlock vault with master password
      async function unlockVault() {
        const masterPassword = unlockMasterPasswordInput.value;
        
        if (!masterPassword) {
          unlockError.textContent = "Please enter your master password.";
          unlockError.style.display = "block";
          return;
        }
        
        try {
          // Show loading
          unlockError.style.display = "none";
          unlockVaultBtn.disabled = true;
          unlockVaultBtn.innerHTML = '<div class="loader" style="width: 20px; height: 20px; margin-right: 10px;"></div> Unlocking...';
          
          // Get vault data
          const vaultDoc = await db.collection('vaults').doc(currentUser.uid).get();
          const vaultData = vaultDoc.data();
          
          // Generate hash from entered password
          const hash = await hashMasterPassword(masterPassword);
          
          // Compare with stored hash
          if (hash === vaultData.masterPasswordHash) {
            // Derive encryption key
            encryptionKey = await deriveEncryptionKey(masterPassword);
            
            // Decrypt passwords
            const decryptedPasswords = decryptData(vaultData.passwords, encryptionKey);
            
            if (decryptedPasswords) {
              passwords = decryptedPasswords;
            } else {
              throw new Error('Failed to decrypt passwords');
            }
            
            // Decrypt settings
            const decryptedSettings = decryptData(vaultData.settings, encryptionKey);
            
            if (decryptedSettings) {
              settings = decryptedSettings;
            }
            
            // Show app
            unlockVault.style.display = "none";
            appContainer.style.display = "block";
            
            // Setup auto logout
            setupAutoLogout();
            
            // Add activity listeners for auto logout
            document.addEventListener('click', resetAutoLogout);
            document.addEventListener('keypress', resetAutoLogout);
            
            // Update UI
            renderPasswordList();
            
            // Update settings UI
            autoLogoutSelect.value = settings.autoLogout.toString();
            defaultPasswordLengthSelect.value = settings.defaultPasswordLength.toString();
            clearClipboardCheckbox.checked = settings.clearClipboard;
            
            // Clear input
            unlockMasterPasswordInput.value = "";
          } else {
            unlockError.textContent = "Incorrect master password. Please try again.";
            unlockError.style.display = "block";
          }
        } catch (error) {
          console.error('Error unlocking vault:', error);
          unlockError.textContent = "Failed to unlock vault. Please try again.";
          unlockError.style.display = "block";
        } finally {
          unlockVaultBtn.disabled = false;
          unlockVaultBtn.textContent = "Unlock Vault";
        }
      }

      // Reset vault (for forgotten master password)
      async function resetVault() {
        if (confirm("WARNING: This will permanently delete all your saved passwords. Are you sure you want to continue?")) {
          if (confirm("Are you REALLY sure? This action cannot be undone!")) {
            try {
              // Delete vault document
              await db.collection('vaults').doc(currentUser.uid).delete();
              
              // Show master password setup
              unlockVault.style.display = "none";
              masterPasswordSetup.style.display = "block";
              
              // Clear fields
              masterPasswordInput.value = "";
              confirmMasterPasswordInput.value = "";
              updateStrengthMeter("", masterPasswordStrengthMeter, masterPasswordStrengthText);
              
            } catch (error) {
              console.error('Error resetting vault:', error);
              alert('Failed to reset vault. Please try again.');
            }
          }
        }
      }

      // Lock vault (sign out from vault, not from account)
      function lockVault() {
        // Hide app
        appContainer.style.display = "none";
        
        // Show unlock screen
        unlockVault.style.display = "block";
        
        // Clear sensitive data from memory
        encryptionKey = '';
        passwords = [];
        
        // Remove activity listeners
        document.removeEventListener('click', resetAutoLogout);
        document.removeEventListener('keypress', resetAutoLogout);
        
        // Clear auto logout timer
        if (autoLogoutTimer) {
          clearTimeout(autoLogoutTimer);
          autoLogoutTimer = null;
        }
        
        // Clear unlock error
        unlockError.style.display = "none";
      }

      // Change master password
      async function changeMasterPassword() {
        const newPassword = changeMasterPasswordInput.value;
        
        if (!newPassword) {
          alert('Please enter a new master password');
          return;
        }
        
        if (getPasswordStrength(newPassword).score < 2) {
          if (!confirm("Your new master password is weak. This puts all your passwords at risk. Are you sure you want to continue?")) {
            return;
          }
        }
        
        try {
          // Prompt for current master password
          const currentPassword = prompt("Please enter your current master password to continue:");
          
          if (!currentPassword) return;
          
          // Get vault data
          const vaultDoc = await db.collection('vaults').doc(currentUser.uid).get();
          const vaultData = vaultDoc.data();
          
          // Generate hash from entered password
          const hash = await hashMasterPassword(currentPassword);
          
          // Compare with stored hash
          if (hash !== vaultData.masterPasswordHash) {
            alert("Incorrect current master password.");
            return;
          }
          
          // Generate new hash and encryption key
          const newHash = await hashMasterPassword(newPassword);
          const newKey = await deriveEncryptionKey(newPassword);
          
          // Re-encrypt all passwords with new key
          const encryptedPasswords = encryptData(passwords, newKey);
          
          // Re-encrypt settings with new key
          const encryptedSettings = encryptData(settings, newKey);
          
          // Update vault document
          await db.collection('vaults').doc(currentUser.uid).update({
            masterPasswordHash: newHash,
            passwords: encryptedPasswords,
            settings: encryptedSettings,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Update current key
          encryptionKey = newKey;
          
          // Clear input
          changeMasterPasswordInput.value = '';
          updateStrengthMeter('', changePasswordStrengthMeter, changePasswordStrengthText);
          
          alert('Master password changed successfully');
          
        } catch (error) {
          console.error('Error changing master password:', error);
          alert('Failed to change master password. Please try again.');
        }
      }

      // Export encrypted data
      async function exportData() {
        if (!encryptionKey) {
          alert('Please unlock your vault first.');
          return;
        }
        
        try {
          // Get vault data
          const vaultDoc = await db.collection('vaults').doc(currentUser.uid).get();
          const vaultData = vaultDoc.data();
          
          const data = {
            passwords: vaultData.passwords,
            masterPasswordHash: vaultData.masterPasswordHash,
            settings: vaultData.settings,
            exportDate: new Date().toISOString()
          };
          
          const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = `password_vault_backup_${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          
          URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Error exporting data:', error);
          alert('Failed to export data. Please try again.');
        }
      }

      // Import encrypted data
      function importData() {
        if (!encryptionKey) {
          alert('Please unlock your vault first.');
          return;
        }
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = async (e) => {
          const file = e.target.files[0];
          
          if (file) {
            const reader = new FileReader();
            
            reader.onload = async (event) => {
              try {
                const data = JSON.parse(event.target.result);
                
                // Validate import data
                if (!data.passwords || !data.masterPasswordHash) {
                  throw new Error('Invalid backup file format');
                }
                
                if (confirm('This will replace all your current passwords. Are you sure you want to continue?')) {
                  // Import data
                  await db.collection('vaults').doc(currentUser.uid).update({
                    passwords: data.passwords,
                    masterPasswordHash: data.masterPasswordHash,
                    settings: data.settings || vaultData.settings,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                  });
                  
                  alert('Data imported successfully. You will now be logged out and need to log back in with the master password from the imported vault.');
                  
                  // Lock vault
                  lockVault();
                }
              } catch (error) {
                console.error('Error importing data:', error);
                alert('Error importing data: ' + error.message);
              }
            };
            
            reader.readAsText(file);
          }
        };
        
        input.click();
      }

      // Clear all data
      async function clearAllData() {
        if (confirm('This will permanently delete all your saved passwords. Are you sure you want to continue?')) {
          if (confirm('Are you REALLY sure? This action cannot be undone!')) {
            try {
              // Initialize empty passwords array
              passwords = [];
              
              // Encrypt empty passwords array
              const encryptedPasswords = encryptData(passwords, encryptionKey);
              
              // Update vault document
              await db.collection('vaults').doc(currentUser.uid).update({
                passwords: encryptedPasswords,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              // Update UI
              renderPasswordList();
              
              alert('All passwords have been deleted.');
            } catch (error) {
              console.error('Error clearing data:', error);
              alert('Failed to clear data. Please try again.');
            }
          }
        }
      }

      // Change account password
      async function changeAccountPassword() {
        const newPassword = prompt("Enter your new account password:");
        
        if (!newPassword) return;
        
        if (getPasswordStrength(newPassword).score < 2) {
          if (!confirm("Your new account password is weak. This puts your account at risk. Are you sure you want to continue?")) {
            return;
          }
        }
        
        try {
          const credential = prompt("For security, please enter your current password:");
          
          if (!credential) return;
          
          // Reauthenticate user
          const emailCredential = firebase.auth.EmailAuthProvider.credential(
            currentUser.email,
            credential
          );
          
          await currentUser.reauthenticateWithCredential(emailCredential);
          
          // Update password
          await currentUser.updatePassword(newPassword);
          
          alert('Account password updated successfully!');
        } catch (error) {
          console.error('Error updating account password:', error);
          alert('Failed to update account password: ' + error.message);
        }
      }

      // Delete account
      async function deleteAccount() {
        if (confirm('WARNING: This will permanently delete your account and all your data. Are you sure you want to continue?')) {
          if (confirm('Are you REALLY sure? This action cannot be undone!')) {
            try {
              const credential = prompt("For security, please enter your current password:");
              
              if (!credential) return;
              
              // Reauthenticate user
              const emailCredential = firebase.auth.EmailAuthProvider.credential(
                currentUser.email,
                credential
              );
              
              await currentUser.reauthenticateWithCredential(emailCredential);
              
              // Delete vault document
              await db.collection('vaults').doc(currentUser.uid).delete();
              
              // Delete user account
              await currentUser.delete();
              
              alert('Your account has been deleted.');
              
              // Redirect to auth screen
              window.location.reload();
            } catch (error) {
              console.error('Error deleting account:', error);
              alert('Failed to delete account: ' + error.message);
            }
          }
        }
      }

      // Login with email and password
      async function login() {
        const email = loginEmail.value;
        const password = loginPassword.value;
        
        if (!email || !password) {
          loginError.textContent = "Please enter both email and password.";
          loginError.style.display = "block";
          return;
        }
        
        try {
          // Show loading
          loginError.style.display = "none";
          authLoading.style.display = "block";
          loginContent.style.display = "none";
          
          // Sign in
          const userCredential = await auth.signInWithEmailAndPassword(email, password);
          
          // User will be handled by the auth state change listener
        } catch (error) {
          console.error('Login error:', error);
          loginError.textContent = error.message;
          loginError.style.display = "block";
          authLoading.style.display = "none";
          loginContent.style.display = "block";
        }
      }

      // Sign up with email and password
      async function signup() {
        const email = signupEmail.value;
        const password = signupPassword.value;
        const confirmPass = confirmPassword.value;
        
        if (!email || !password) {
          signupError.textContent = "Please enter both email and password.";
          signupError.style.display = "block";
          return;
        }
        
        if (password !== confirmPass) {
          signupError.textContent = "Passwords do not match.";
          signupError.style.display = "block";
          return;
        }
        
        if (getPasswordStrength(password).score < 2) {
          if (!confirm("Your account password is weak. Are you sure you want to continue?")) {
            return;
          }
        }
        
        try {
          // Show loading
          signupError.style.display = "none";
          authLoading.style.display = "block";
          signupContent.style.display = "none";
          
          // Create user
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          
          // User will be handled by the auth state change listener
        } catch (error) {
          console.error('Signup error:', error);
          signupError.textContent = error.message;
          signupError.style.display = "block";
          authLoading.style.display = "none";
          signupContent.style.display = "block";
        }
      }

      // Send password reset email
      async function sendPasswordResetEmail() {
        const email = resetEmail.value;
        
        if (!email) {
          resetMessage.textContent = "Please enter your email address.";
          resetMessage.className = "alert alert-danger";
          resetMessage.style.display = "block";
          return;
        }
        
        try {
          // Show loading
          resetMessage.style.display = "none";
          resetPasswordBtn.disabled = true;
          resetPasswordBtn.innerHTML = '<div class="loader" style="width: 20px; height: 20px; margin-right: 10px;"></div> Sending...';
          
          // Send reset email
          await auth.sendPasswordResetEmail(email);
          
          // Show success message
          resetMessage.textContent = "Password reset email sent! Check your inbox.";
          resetMessage.className = "alert alert-success";
          resetMessage.style.display = "block";
        } catch (error) {
          console.error('Reset password error:', error);
          resetMessage.textContent = error.message;
          resetMessage.className = "alert alert-danger";
          resetMessage.style.display = "block";
        } finally {
          resetPasswordBtn.disabled = false;
          resetPasswordBtn.textContent = "Send Reset Link";
        }
      }

      // Sign out
      async function signOut() {
        try {
          // Clear sensitive data
          encryptionKey = '';
          passwords = [];
          
          // Sign out
          await auth.signOut();
          
          // User will be handled by the auth state change listener
        } catch (error) {
          console.error('Sign out error:', error);
          alert('Failed to sign out. Please try again.');
        }
      }

      // Generate password button handler
      generatePasswordBtn.addEventListener('click', () => {
        const password = generatePassword();
        generatedPassword.textContent = password;
        updateStrengthMeter(password, generatedPasswordStrengthMeter, generatedPasswordStrengthText);
      });

      // Copy generated password button handler
      copyGeneratedBtn.addEventListener('click', () => {
        const password = generatedPassword.textContent;
        if (password && password !== 'Click "Generate" to create a password') {
          copyPassword(password);
          copyGeneratedBtn.textContent = 'Copied!';
          copyGeneratedBtn.classList.add('copied');
          
          setTimeout(() => {
            copyGeneratedBtn.textContent = 'Copy';
            copyGeneratedBtn.classList.remove('copied');
          }, 2000);
        }
      });

      // Initialize password length slider
      passwordLengthSlider.addEventListener('input', () => {
        passwordLengthValue.textContent = passwordLengthSlider.value;
      });

      // Generate for site button handler
      generateForSiteBtn.addEventListener('click', () => {
        const password = generatePassword();
        passwordInput.value = password;
        updateStrengthMeter(password, addPasswordStrengthMeter, addPasswordStrengthText);
      });

      // Settings change handlers
      autoLogoutSelect.addEventListener('change', () => {
        settings.autoLogout = parseInt(autoLogoutSelect.value);
        saveSettings();
      });

      defaultPasswordLengthSelect.addEventListener('change', () => {
        settings.defaultPasswordLength = parseInt(defaultPasswordLengthSelect.value);
        saveSettings();
        
        // update generator length
        passwordLengthSlider.value = settings.defaultPasswordLength;
        passwordLengthValue.textContent = settings.defaultPasswordLength;
      });

      clearClipboardCheckbox.addEventListener('change', () => {
        settings.clearClipboard = clearClipboardCheckbox.checked;
        saveSettings();
      });

      // auth state change listener
      auth.onAuthStateChanged(async (user) => {
        authLoading.style.display = "none";
        
        if (user) {
          // user is signed in
          currentUser = user;
          
          // update user profile
          userAvatar.textContent = user.email.charAt(0).toUpperCase();
          userName.textContent = user.displayName || 'User';
          userEmail.textContent = user.email;
          
          // check if vault exists
          vaultExists = await checkVaultExists(user.uid);
          
          if (vaultExists) {
            // show unlock screen
            authScreen.style.display = "none";
            unlockVault.style.display = "block";
          } else {
            // show master password setup
            authScreen.style.display = "none";
            masterPasswordSetup.style.display = "block";
          }
        } else {
          // user is signed out
          currentUser = null;
          
          // show auth screen
          authScreen.style.display = "block";
          masterPasswordSetup.style.display = "none";
          unlockVault.style.display = "none";
          appContainer.style.display = "none";
          
          // show login form
          loginContent.style.display = "block";
          signupContent.style.display = "none";
          resetPasswordContent.style.display = "none";
          
          // clear auth forms
          loginEmail.value = '';
          loginPassword.value = '';
          signupEmail.value = '';
          signupPassword.value = '';
          confirmPassword.value = '';
          resetEmail.value = '';
          loginError.style.display = "none";
          signupError.style.display = "none";
          resetMessage.style.display = "none";
        }
      });

      // event Listeners
      loginBtn.addEventListener('click', login);
      signupBtn.addEventListener('click', signup);
      resetPasswordBtn.addEventListener('click', sendPasswordResetEmail);
      createVaultBtn.addEventListener('click', createVault);
      unlockVaultBtn.addEventListener('click', unlockVault);
      resetVaultBtn.addEventListener('click', resetVault);
      signOutBtn.addEventListener('click', signOut);
      addPasswordBtn.addEventListener('click', addPassword);
      lockVaultBtn.addEventListener('click', lockVault);
      clearDataBtn.addEventListener('click', clearAllData);
      updateMasterPasswordBtn.addEventListener('click', changeMasterPassword);
      exportDataBtn.addEventListener('click', exportData);
      importDataBtn.addEventListener('click', importData);
      changeAccountPasswordBtn.addEventListener('click', changeAccountPassword);
      deleteAccountBtn.addEventListener('click', deleteAccount);

      // enter key handlers
      loginPassword.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          loginBtn.click();
        }
      });

      confirmPassword.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          signupBtn.click();
        }
      });

      resetEmail.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          resetPasswordBtn.click();
        }
      });

      unlockMasterPasswordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          unlockVaultBtn.click();
        }
      });

      confirmMasterPasswordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          createVaultBtn.click();
        }
      });
    });
  </script>
</body>
</html>
