<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>The Portal Chamber</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    /* Modern color system */
    --primary: #667eea;
    --primary-light: #818cf8;
    --primary-dark: #4338ca;
    --accent: #f472b6;
    --surface: #0f172a;
    --surface-light: rgba(15, 23, 42, 0.8);
    --surface-border: rgba(100, 116, 139, 0.2);
    --text: #f8fafc;
    --text-muted: #94a3b8;
    --text-dim: #64748b;
    --success: #10b981;
    --warning: #f59e0b;
    
    /* Spacing */
    --space-xs: 0.5rem;
    --space-sm: 1rem;
    --space-md: 1.5rem;
    --space-lg: 2rem;
    --space-xl: 3rem;
    
    /* Radius */
    --radius-sm: 0.5rem;
    --radius-md: 1rem;
    --radius-lg: 1.5rem;
    --radius-full: 9999px;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
    --shadow-glow: 0 0 20px rgb(102 126 234 / 0.3);
    
    /* Transitions */
    --ease-out: cubic-bezier(0.4, 0, 0.2, 1);
    --ease-in-out: cubic-bezier(0.4, 0, 0.6, 1);
  }

  /* Static Fitz image styling (simple) */
  .fitz-static { position:fixed; top:50%; right:40px; transform:translateY(-50%); width:240px; border-radius:22px; overflow:hidden; box-shadow:0 10px 32px rgba(0,0,0,0.55); opacity:0.98; z-index:500; background:#111; }
  .fitz-static img { width:100%; height:auto; display:block; }
  @media (max-width: 1100px){ .fitz-static { width:190px; right:24px; } }
  @media (max-width: 900px){ .fitz-static { width:160px; right:16px; } }
  @media (max-width: 760px){ .fitz-static { top:auto; bottom:12px; transform:none; width:140px; right:12px; } }
  
  * { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0; 
  }
  
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    color: var(--text);
    min-height: 100vh;
    display: grid;
    place-items: center;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
    position: relative;
  }
  
  /* Ambient particles */
  canvas#particles { 
    position: absolute; 
    inset: 0; 
    width: 100%; 
    height: 100%; 
    pointer-events: none; 
    opacity: 0.6;
  }
  
  /* Main container */
  .gateway-container {
    position: relative;
    max-width: 28rem;
    width: 90%;
    padding: var(--space-xl);
    background: var(--surface-light);
    backdrop-filter: blur(20px);
    border: 1px solid var(--surface-border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl), var(--shadow-glow);
    text-align: center;
  }
  
  /* Portal visualization */
  .portal-visual {
    position: relative;
    width: 12rem;
    height: 12rem;
    margin: 0 auto var(--space-lg);
  }
  
  .portal-ring {
    position: absolute;
    inset: 0;
    border: 2px solid transparent;
    border-radius: var(--radius-full);
    background: linear-gradient(45deg, var(--primary), var(--accent)) border-box;
    -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
    mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    animation: portal-rotate 20s linear infinite;
  }
  
  .portal-core {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 60%;
    height: 60%;
    transform: translate(-50%, -50%);
    background: radial-gradient(circle, var(--primary-light) 0%, transparent 70%);
    border-radius: var(--radius-full);
    animation: portal-pulse 3s ease-in-out infinite;
  }
  
  .portal-glow {
    position: absolute;
    inset: -1rem;
    background: radial-gradient(circle, var(--primary) 0%, transparent 50%);
    border-radius: var(--radius-full);
    opacity: 0.3;
    animation: portal-glow 4s ease-in-out infinite alternate;
  }
  
  @keyframes portal-rotate {
    to { transform: rotate(360deg); }
  }
  
  @keyframes portal-pulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
    50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
  }
  
  @keyframes portal-glow {
    0% { opacity: 0.2; }
    100% { opacity: 0.4; }
  }
  
  /* Typography */
  .gateway-title {
    font-size: 1.875rem;
    font-weight: 700;
    margin-bottom: var(--space-xs);
    background: linear-gradient(90deg, var(--text), var(--primary-light));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.025em;
  }
  
  .gateway-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    padding: 0.375rem 0.875rem;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    border-radius: var(--radius-full);
    margin-bottom: var(--space-md);
    box-shadow: var(--shadow-md);
  }
  
  .gateway-badge::before {
    content: 'âš¡';
    font-size: 0.875rem;
  }
  
  .gateway-description {
    color: var(--text-muted);
    line-height: 1.6;
    margin-bottom: var(--space-md);
    font-size: 0.9rem;
  }
  
  .gateway-description strong {
    color: var(--text);
    font-weight: 600;
  }
  
  /* Password section */
  .password-section {
    background: rgba(100, 116, 139, 0.1);
    border: 1px solid var(--surface-border);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    margin: var(--space-md) 0;
  }
  
  .password-label {
    color: var(--text-dim);
    font-size: 0.8rem;
    margin-bottom: var(--space-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  
  .password-display {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--primary-light);
    margin-bottom: var(--space-sm);
    letter-spacing: 0.1em;
  }
  
  .copy-btn {
    background: rgba(100, 116, 139, 0.2);
    border: 1px solid var(--surface-border);
    color: var(--text-muted);
    padding: 0.5rem 1rem;
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s var(--ease-out);
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .copy-btn:hover {
    background: rgba(100, 116, 139, 0.3);
    color: var(--text);
    transform: translateY(-1px);
  }
  
  .copy-feedback {
    position: absolute;
    top: -2.5rem;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface);
    color: var(--success);
    padding: 0.375rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s var(--ease-out);
    box-shadow: var(--shadow-md);
  }
  
  .copy-feedback.show {
    opacity: 1;
    transform: translateX(-50%) translateY(-0.25rem);
  }
  
  /* Action buttons */
  .gateway-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    margin-top: var(--space-lg);
  }
  
  .action-btn {
    padding: 0.875rem 1.5rem;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s var(--ease-out);
    position: relative;
    overflow: hidden;
  }
  
  .action-btn.primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    box-shadow: var(--shadow-md);
  }
  
  .action-btn.secondary {
    background: linear-gradient(135deg, var(--accent), #ec4899);
    color: white;
    box-shadow: var(--shadow-md);
  }
  
  .action-btn.ghost {
    background: transparent;
    border: 1px solid var(--surface-border);
    color: var(--text-muted);
  }
  
  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }
  
  .action-btn.primary:hover {
    box-shadow: var(--shadow-lg), 0 0 30px rgba(102, 126, 234, 0.4);
  }
  
  .action-btn.secondary:hover {
    box-shadow: var(--shadow-lg), 0 0 30px rgba(244, 114, 182, 0.4);
  }
  
  .action-btn.ghost:hover {
    background: rgba(100, 116, 139, 0.1);
    color: var(--text);
  }
  
  .action-btn:active {
    transform: translateY(0);
  }
  
  .action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }
  
  /* Footer */
  .gateway-footer {
    margin-top: var(--space-lg);
    padding-top: var(--space-md);
    border-top: 1px solid var(--surface-border);
    color: var(--text-dim);
    font-size: 0.75rem;
    opacity: 0.8;
  }
  
  /* Responsive design */
  @media (max-width: 640px) {
    .gateway-container {
      padding: var(--space-lg);
      width: 95%;
    }
    
    .portal-visual {
      width: 10rem;
      height: 10rem;
    }
    
    .gateway-title {
      font-size: 1.5rem;
    }
    
    .gateway-actions {
      gap: 0.75rem;
    }
  }
  
  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .portal-ring,
    .portal-core,
    .portal-glow {
      animation: none;
    }
  }
  
  /* Cursor-chasing square - PRESERVED */
  #chaseSquare {
    position: fixed !important;
    top: 20px;
    left: 20px;
    width: 30px;
    height: 30px;
    background: #ffffff !important;
    border: 3px solid #ff0000 !important;
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(255,255,255,0.8), 0 0 40px rgba(255,0,0,0.6) !important;
    pointer-events: none;
    z-index: 99999 !important;
    opacity: 1 !important;
    display: block !important;
    visibility: visible !important;
    mix-blend-mode: normal;
    transition: opacity .4s, filter .4s;
    will-change: transform;
  }
  
  #chaseSquare.paused { 
    opacity: 0.7; 
    filter: grayscale(.25) brightness(.85); 
  }
</style>
</head>
<body>
  <div class="fitz-static" aria-hidden="true">
    <img src="assets/images/fitz.png" alt="Fitz the dog" loading="lazy" decoding="async">
  </div>
  <canvas id="particles" aria-hidden="true"></canvas>
  <div id="chaseSquare" aria-hidden="true"></div>
  
  <main class="gateway-container">
    <!-- Portal Visualization -->
    <div class="portal-visual">
      <div class="portal-glow"></div>
      <div class="portal-ring"></div>
      <div class="portal-core"></div>
    </div>
    
    <!-- Content -->
    <h1 class="gateway-title">Access Granted</h1>
    <div class="gateway-badge">Hidden Gateway #2</div>
    
    <p class="gateway-description">
      Sequence authenticated. You've unlocked this <strong>classified portal</strong> through precise execution of the hidden protocol.
    </p>
    
    <!-- Password Section -->
    <div class="password-section">
      <div class="password-label">Security Key</div>
      <div class="password-display">PORTAL</div>
      <div style="position: relative; display: inline-block;">
        <button class="copy-btn" id="copyPass">
          <span>ðŸ“‹</span>
          Copy Key
        </button>
        <div class="copy-feedback" id="copyFeedback">Copied!</div>
      </div>
    </div>
    
    <!-- Actions -->
    <div class="gateway-actions">
      <button class="action-btn primary" onclick="window.location.href='index.html'">
        Return to Surface
      </button>
      <button class="action-btn secondary" onclick="window.location.href='congrats.html'">
        Previous Discovery
      </button>
      <button class="action-btn ghost" id="futureBtn" disabled title="Awaiting next sequence">
        Deep Access â€¢ Locked
      </button>
    </div>
    
    <div class="gateway-footer">
      Protocol: Long-Press + PORTAL â€¢ Level 2 Clearance
    </div>
  </main>
  <script>
    // Memory Management System
    const memoryManager = {
      animationFrames: new Set(),
      timeouts: new Set(),
      intervals: new Set(),
      eventListeners: new Map(),
      isCleanedUp: false,
      
      addAnimationFrame(id) {
        this.animationFrames.add(id);
        return id;
      },
      
      addTimeout(id) {
        this.timeouts.add(id);
        return id;
      },
      
      addInterval(id) {
        this.intervals.add(id);
        return id;
      },
      
      addEventListener(element, event, handler, options) {
        if (!this.eventListeners.has(element)) {
          this.eventListeners.set(element, []);
        }
        this.eventListeners.get(element).push({ event, handler, options });
        element.addEventListener(event, handler, options);
      },
      
      cleanup() {
        if (this.isCleanedUp) return;
        
        console.log('ðŸ§¹ Memory cleanup initiated - removing animations and event listeners');
        
        // Cancel all animation frames
        this.animationFrames.forEach(id => cancelAnimationFrame(id));
        this.animationFrames.clear();
        
        // Clear all timeouts
        this.timeouts.forEach(id => clearTimeout(id));
        this.timeouts.clear();
        
        // Clear all intervals
        this.intervals.forEach(id => clearInterval(id));
        this.intervals.clear();
        
        // Remove all event listeners
        this.eventListeners.forEach((listeners, element) => {
          listeners.forEach(({ event, handler, options }) => {
            element.removeEventListener(event, handler, options);
          });
        });
        this.eventListeners.clear();
        
        // Stop CSS animations
        const animatedElements = document.querySelectorAll('.portal-ring, .portal-core, .portal-glow');
        animatedElements.forEach(el => {
          el.style.animation = 'none';
          el.style.transform = 'none';
        });
        
        // Clear particle canvas
        const canvas = document.getElementById('particles');
        if (canvas) {
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        this.isCleanedUp = true;
        console.log('âœ… Memory cleanup completed - all resources freed');
      }
    };
    
    // Auto-cleanup after 10 seconds
    const cleanupTimeout = memoryManager.addTimeout(
      setTimeout(() => memoryManager.cleanup(), 10000)
    );
    
    // Lifecycle cleanup (pagehide replaces deprecated beforeunload)
    memoryManager.addEventListener(window, 'pagehide', () => memoryManager.cleanup());
    // Cleanup on tab switch / backgrounding
    memoryManager.addEventListener(document, 'visibilitychange', () => {
      if (document.hidden) memoryManager.cleanup();
    });

    // Interactive portal tilt
    const portalCore = document.querySelector('.portal-core');
    const container = document.querySelector('.gateway-container');
    let rect;
    
    function updateRect(){ 
      rect = container.getBoundingClientRect(); 
    }
    updateRect();
    memoryManager.addEventListener(window, 'resize', updateRect);
    
    const pointerMoveHandler = (e) => {
      if (memoryManager.isCleanedUp) return;
      if(!rect) return;
      const x = (e.clientX - rect.left)/rect.width - 0.5;
      const y = (e.clientY - rect.top)/rect.height - 0.5;
      portalCore.style.transform = `translate(-50%, -50%) rotateX(${(-y*8).toFixed(2)}deg) rotateY(${(x*8).toFixed(2)}deg)`;
    };
    
    const pointerLeaveHandler = () => { 
      if (memoryManager.isCleanedUp) return;
      portalCore.style.transform = 'translate(-50%, -50%)'; 
    };
    
    memoryManager.addEventListener(document, 'pointermove', pointerMoveHandler);
    memoryManager.addEventListener(document, 'pointerleave', pointerLeaveHandler);

    // Copy password functionality
    const copyBtn = document.getElementById('copyPass');
    const feedback = document.getElementById('copyFeedback');
    
    const copyHandler = async () => {
      if (memoryManager.isCleanedUp) return;
      try {
        await navigator.clipboard.writeText('PORTAL');
        feedback.textContent = 'Copied!';
      } catch(err){
        feedback.textContent = 'Failed';
      }
      feedback.classList.add('show');
      const hideTimeout = memoryManager.addTimeout(
        setTimeout(() => {
          if (!memoryManager.isCleanedUp) {
            feedback.classList.remove('show');
          }
        }, 2000)
      );
    };
    
    memoryManager.addEventListener(copyBtn, 'click', copyHandler);

    // Modern particle system with cleanup
    const canvas = document.getElementById('particles');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let animationId = null;
    
    function resize(){ 
      if (memoryManager.isCleanedUp) return;
      canvas.width = innerWidth; 
      canvas.height = innerHeight; 
      initParticles();
    }
    
    function initParticles() {
      if (memoryManager.isCleanedUp) return;
      particles = [];
      const COUNT = Math.min(100, Math.round(innerWidth/15));
      for(let i = 0; i < COUNT; i++){
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          r: Math.random() * 2 + 0.5,
          vx: (Math.random() - 0.5) * 0.5,
          vy: (Math.random() - 0.5) * 0.5,
          opacity: Math.random() * 0.6 + 0.2,
          hue: 220 + Math.random() * 40
        });
      }
    }
    
    function animateParticles(){
      if (memoryManager.isCleanedUp) {
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
        return;
      }
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      for(const particle of particles){
        particle.x += particle.vx;
        particle.y += particle.vy;
        
        // Wrap around edges
        if(particle.x < 0) particle.x = canvas.width;
        if(particle.x > canvas.width) particle.x = 0;
        if(particle.y < 0) particle.y = canvas.height;
        if(particle.y > canvas.height) particle.y = 0;
        
        // Draw particle
        const gradient = ctx.createRadialGradient(
          particle.x, particle.y, 0,
          particle.x, particle.y, particle.r * 3
        );
        gradient.addColorStop(0, `hsla(${particle.hue}, 70%, 70%, ${particle.opacity})`);
        gradient.addColorStop(1, `hsla(${particle.hue}, 70%, 70%, 0)`);
        
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(particle.x, particle.y, particle.r, 0, Math.PI * 2);
        ctx.fill();
      }
      
      animationId = memoryManager.addAnimationFrame(requestAnimationFrame(animateParticles));
    }
    
    memoryManager.addEventListener(window, 'resize', resize);
    resize();
    
    if(!matchMedia('(prefers-reduced-motion: reduce)').matches && !memoryManager.isCleanedUp) {
      animateParticles();
    }

    // --- CURSOR CHASING SQUARE - PRESERVED FUNCTIONALITY ---
    const chase = document.getElementById('chaseSquare');
    const panel = container; // Updated to use new container
    
    let chaseX = 20;
    let chaseY = 20;
    let targetX = 20;
    let targetY = 20;
    const chaseSpeed = 0.02;
    let chaseAnimationId = null;
    
    // Click tracking for secret portal
    let clickCount = 0;
    const maxClicks = 3;
    let lastClickTime = 0;
    
    let panelRect;
    function updatePanelRect() {
      if (memoryManager.isCleanedUp) return;
      panelRect = panel.getBoundingClientRect();
    }
    updatePanelRect();
    memoryManager.addEventListener(window, 'resize', updatePanelRect);

    // Force initial position
    chase.style.left = chaseX + 'px';
    chase.style.top = chaseY + 'px';
    chase.style.transform = 'none';

    // Animation loop with cleanup
    function animateChase(){
      if (memoryManager.isCleanedUp) {
        if (chaseAnimationId) {
          cancelAnimationFrame(chaseAnimationId);
          chaseAnimationId = null;
        }
        return;
      }
      
      chaseX += (targetX - chaseX) * chaseSpeed;
      chaseY += (targetY - chaseY) * chaseSpeed;
      
      chase.style.left = Math.round(chaseX) + 'px';
      chase.style.top = Math.round(chaseY) + 'px';
      
      chaseAnimationId = memoryManager.addAnimationFrame(requestAnimationFrame(animateChase));
    }
    
    animateChase();

    // Track mouse movement
    const mouseMoveHandler = (e) => {
      if (memoryManager.isCleanedUp || !panelRect) return;
      
      const inside = e.clientX >= panelRect.left && 
                    e.clientX <= panelRect.right && 
                    e.clientY >= panelRect.top && 
                    e.clientY <= panelRect.bottom;
      
      if(inside){
        chase.classList.add('paused');
      } else {
        chase.classList.remove('paused');
        targetX = e.clientX - 15;
        targetY = e.clientY - 15;
      }
    };
    
    memoryManager.addEventListener(document, 'mousemove', mouseMoveHandler);

    // Click handler for the chasing square
    const chaseClickHandler = (e) => {
      if (memoryManager.isCleanedUp) return;
      e.preventDefault();
      e.stopPropagation();
      
      const currentTime = Date.now();
      
      if (currentTime - lastClickTime > 5000) {
        clickCount = 0;
      }
      
      clickCount++;
      lastClickTime = currentTime;
      
      // Visual feedback
      chase.style.transform = 'scale(1.3)';
      chase.style.filter = 'brightness(1.5) drop-shadow(0 0 15px #fff)';
      
      const resetTimeout = memoryManager.addTimeout(
        setTimeout(() => {
          if (!memoryManager.isCleanedUp) {
            chase.style.transform = 'scale(1)';
            chase.style.filter = '';
          }
        }, 200)
      );
      
      console.log(`Chase square clicked: ${clickCount}/${maxClicks}`);
      
      if (clickCount >= maxClicks) {
        chase.style.background = '#00ff00';
        chase.style.boxShadow = '0 0 30px #00ff00, 0 0 60px #00ff00';
        
        // Clean up before navigation
        memoryManager.cleanup();
        
        setTimeout(() => {
          window.location.href = 'portal-2.html';
        }, 800);
      }
    };
    
    memoryManager.addEventListener(chase, 'click', chaseClickHandler);

    // Make the square clickable
    chase.style.pointerEvents = 'auto';
    chase.style.cursor = 'pointer';

    // Ensure visibility
    const visibilityTimeout = memoryManager.addTimeout(
      setTimeout(() => {
        if (!memoryManager.isCleanedUp) {
          chase.style.display = 'block';
          chase.style.visibility = 'visible';
          chase.style.opacity = '1';
          console.log('Chase square initialized');
        }
      }, 100)
    );
    
    console.log('ðŸš€ Portal initialized with 10-second auto-cleanup');

    // (Removed interactive Fitz + theme toggle per user request; static image only)
  </script>
</body>
</html>